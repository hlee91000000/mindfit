<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mindfit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <meta name="color-scheme" content="light" />
  <style>
    :root { color-scheme: light; }
    @media (prefers-color-scheme: dark) {
      html, body { background: #F4FBFA !important; color: #2D7060 !important; }
      .card, .card-warm, .stat-card, .modal-sheet { background: #fff !important; color: #2D7060 !important; }
      .btn-primary { background: #3BAA8C !important; color: #fff !important; }
      .btn-sage { background: #52C9A8 !important; color: #fff !important; }
      .header-gradient { background: linear-gradient(135deg, #3BAA8C 0%, #52C9A8 100%) !important; }
      .upcoming-meeting { background: linear-gradient(135deg, #3BAA8C, #52C9A8) !important; }
      input, textarea, select { background: #FAFEFE !important; color: #2D7060 !important; border-color: #B8E8DF !important; }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #F4FBFA !important; font-family: 'DM Sans', sans-serif; color: #2D7060; }
    button { cursor: pointer; font-family: 'DM Sans', sans-serif; border: none; background: none; }
    input, textarea, select { font-family: 'DM Sans', sans-serif; }
    .card { background: #fff; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04); }
    .card-warm { background: #FAFEFE; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); border: 1px solid #C8EDE6; }
    .btn-primary { background: #3BAA8C; color: #fff; border-radius: 14px; font-weight: 600; transition: all 0.15s; border: none; cursor: pointer; }
    .btn-primary:hover { background: #2D9078; transform: translateY(-1px); }
    .btn-sage { background: #52C9A8; color: #fff; border-radius: 14px; font-weight: 600; transition: all 0.15s; border: none; cursor: pointer; }
    .btn-sage:hover { background: #3BAA8C; }
    .btn-outline { background: transparent; border: 2px solid #3BAA8C; color: #3BAA8C; border-radius: 14px; font-weight: 600; transition: all 0.15s; cursor: pointer; }
    .btn-outline:hover { background: #3BAA8C; color: #fff; }
    .input-field { border: 1.5px solid #B8E8DF; border-radius: 12px; padding: 12px 16px; font-size: 15px; background: #FAFEFE; width: 100%; outline: none; transition: border-color 0.15s; }
    .input-field:focus { border-color: #3BAA8C; }
    .tag-sage { background: #D4F2EB; color: #2D9078; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .tag-dark { background: #3BAA8C; color: #fff; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .tag-warm { background: #D4F2EB; color: #2D9078; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .tag-blue { background: #D4F2EB; color: #2D9078; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .header-gradient { background: linear-gradient(135deg, #3BAA8C 0%, #52C9A8 100%); }
    .stat-card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(30,80,60,0.45); display: flex; align-items: flex-end; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
    .modal-sheet { background: #FAFEFE; border-radius: 24px 24px 0 0; width: 100%; max-width: 640px; max-height: 90vh; overflow-y: auto; padding: 28px 24px 40px; }
    .modal-handle { width: 36px; height: 4px; background: #B8E8DF; border-radius: 2px; margin: 0 auto 24px; }
    .coach-banner { background: linear-gradient(135deg, #52C9A8, #3BAA8C); border-radius: 16px; padding: 12px 16px; color: white; }
    .feedback-bubble { background: #E8F8F4; border-radius: 14px; padding: 12px 16px; }
    .answer-bubble { background: #3BAA8C; border-radius: 14px; padding: 14px 18px; color: white; }
    .category-btn-active { background: #3BAA8C; color: white; border-radius: 12px; }
    .category-btn { background: #D4F2EB; color: #2D9078; border-radius: 12px; }
    .meal-type-active { background: #3BAA8C; color: white; border-radius: 10px; }
    .meal-type { background: #D4F2EB; color: #2D9078; border-radius: 10px; }
    .energy-active { background: #52C9A8; color: white; border-radius: 10px; }
    .energy-btn { background: #D4F2EB; color: #2D9078; border-radius: 10px; }
    .mood-active { background: #D4F2EB; border-radius: 12px; transform: scale(1.1); }
    .mood-btn { background: #F4FBFA; border-radius: 12px; }
    .upcoming-meeting { background: linear-gradient(135deg, #3BAA8C, #52C9A8); border-radius: 18px; color: white; padding: 20px; }
    .badge { background: #E05C5C; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; position: absolute; top: 6px; right: 2px; }
    .app-bg { background: #F4FBFA; min-height: 100vh; }
    ::-webkit-scrollbar { width: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const API_URL = 'https://script.google.com/macros/s/AKfycbwhfh02uDuFnpPzoLbtrFOO-lT1DvVzwrk2Zp2ZwZ8gFpejkCyfTT5-2I2h4Q2sJXU7wg/exec';

    const apiCall = (tab, action, params = {}) => {
      return new Promise((resolve, reject) => {
        const cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
        const url = new URL(API_URL);
        url.searchParams.set('tab', tab);
        url.searchParams.set('action', action);
        url.searchParams.set('callback', cbName);
        Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, typeof v === 'object' ? JSON.stringify(v) : String(v)));
        const script = document.createElement('script');
        const timer = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, 15000);
        const cleanup = () => { clearTimeout(timer); delete window[cbName]; script.parentNode && script.parentNode.removeChild(script); };
        window[cbName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error('error')); };
        script.src = url.toString();
        document.head.appendChild(script);
      });
    };

    const load = (key) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : []; } catch { return []; } };
    const save = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch {} };

    // Icons (inline SVG)
    const Icon = ({ d, size = 20, color = 'currentColor', strokeWidth = 2 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round">
        {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
      </svg>
    );
    const Icons = {
      Plus: ({size=20,color='currentColor'}) => <Icon d="M12 5v14M5 12h14" size={size} color={color} />,
      X: ({size=20,color='currentColor'}) => <Icon d="M18 6L6 18M6 6l12 12" size={size} color={color} />,
      ChevronDown: ({size=20,color='currentColor'}) => <Icon d="M6 9l6 6 6-6" size={size} color={color} />,
      ChevronUp: ({size=20,color='currentColor'}) => <Icon d="M18 15l-6-6-6 6" size={size} color={color} />,
      Send: ({size=20,color='currentColor'}) => <Icon d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" size={size} color={color} />,
      Check: ({size=20,color='currentColor'}) => <Icon d="M20 6L9 17l-5-5" size={size} color={color} />,
      Utensils: ({size=20,color='currentColor'}) => <Icon d={["M3 2v7c0 1.1.9 2 2 2h4a2 2 0 002-2V2","M7 2v20","M21 15V2a5 5 0 00-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"]} size={size} color={color} />,
      BookOpen: ({size=20,color='currentColor'}) => <Icon d={["M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z","M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"]} size={size} color={color} />,
      TrendingUp: ({size=20,color='currentColor'}) => <Icon d="M23 6l-9.5 9.5-5-5L1 18" size={size} color={color} />,
      MessageCircle: ({size=20,color='currentColor'}) => <Icon d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" size={size} color={color} />,
      Bell: ({size=20,color='currentColor'}) => <Icon d={["M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9","M13.73 21a2 2 0 01-3.46 0"]} size={size} color={color} />,
      Calendar: ({size=20,color='currentColor'}) => <Icon d={["M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2z","M16 2v4M8 2v4M3 10h18"]} size={size} color={color} />,
      User: ({size=20,color='currentColor'}) => <Icon d={["M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2","M12 11a4 4 0 100-8 4 4 0 000 8z"]} size={size} color={color} />,
      Users: ({size=20,color='currentColor'}) => <Icon d={["M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2","M23 21v-2a4 4 0 00-3-3.87","M16 3.13a4 4 0 010 7.75","M9 11a4 4 0 100-8 4 4 0 000 8z"]} size={size} color={color} />,
    };

    function App() {
      const [mode, setMode] = useState('client');
      const [coachPassword, setCoachPassword] = useState('');
      const [showPasswordPrompt, setShowPasswordPrompt] = useState(false);
      const [clientName, setClientName] = useState(() => localStorage.getItem('clientName') || '');
      const [tempClientName, setTempClientName] = useState('');
      const [clientPassword, setClientPassword] = useState('');
      const [tempClientPassword, setTempClientPassword] = useState('');
      const [showClientPasswordPrompt, setShowClientPasswordPrompt] = useState(false);
      const [meals, setMeals] = useState(() => load('meals'));
      const [posts, setPosts] = useState(() => load('posts'));
      const [meetings, setMeetings] = useState(() => load('meetings'));
      const [journals, setJournals] = useState(() => load('journals'));
      const [inquiries, setInquiries] = useState(() => load('inquiries'));
      const [loading, setLoading] = useState(false);
      const [saving, setSaving] = useState(false);
      const [syncMsg, setSyncMsg] = useState('');
      const [activeTab, setActiveTab] = useState('meals');
      const [selectedClient, setSelectedClient] = useState('all');
      const [filterType, setFilterType] = useState('all');
      const [showForm, setShowForm] = useState(false);
      const [showEmergencyForm, setShowEmergencyForm] = useState(false);
      const [showJournalForm, setShowJournalForm] = useState(false);
      const [showPostForm, setShowPostForm] = useState(false);
      const [showMeetingForm, setShowMeetingForm] = useState(false);
      const [showInquiryForm, setShowInquiryForm] = useState(false);
      const [selectedMeal, setSelectedMeal] = useState(null);
      const [expandedMeals, setExpandedMeals] = useState({});
      const [expandedJournals, setExpandedJournals] = useState({});
      const [expandedDates, setExpandedDates] = useState({});
      const [expandedInquiries, setExpandedInquiries] = useState({});
      const [feedbackText, setFeedbackText] = useState('');
      const [answerText, setAnswerText] = useState('');
      const [answeringId, setAnsweringId] = useState(null);
      const today = new Date().toISOString().split('T')[0];
      const todayLabel = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

      const [mealForm, setMealForm] = useState({ date: today, time: new Date().toTimeString().slice(0,5), mealType: 'Breakfast', foods: '', fullness: '', satietyHours: '' });
      const [emergencyForm, setEmergencyForm] = useState({ type: 'Binge Eating', notes: '', date: today, time: new Date().toTimeString().slice(0,5) });
      const [journalForm, setJournalForm] = useState({ date: today, mood: '', energy: '', feelings: '', notes: '' });
      const [postForm, setPostForm] = useState({ title: '', content: '' });
      const [meetingForm, setMeetingForm] = useState({ clientName: '', date: today, time: '', title: '', notes: '' });
      const [inquiryForm, setInquiryForm] = useState({ category: 'Diet', question: '' });

      // Íµ¨Í∏ÄÏãúÌä∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      const syncFromSheets = async () => {
        setLoading(true);
        setSyncMsg('Syncing...');
        try {
          const [m, p, mt, j, inq] = await Promise.all([
            apiCall('meals','getAll'),
            apiCall('posts','getAll'),
            apiCall('meetings','getAll'),
            apiCall('journals','getAll'),
            apiCall('inquiries','getAll'),
          ]);
          if (m.data) { const d = m.data.map(r => ({...r, feedback: r.feedback ? (typeof r.feedback === 'string' ? JSON.parse(r.feedback) : r.feedback) : [], isEmergency: r.isEmergency === 'TRUE' || r.isEmergency === true})).reverse(); setMeals(d); save('meals', d); }
          if (p.data) { const d = p.data.reverse(); setPosts(d); save('posts', d); }
          if (mt.data) { const d = mt.data.sort((a,b) => new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time)); setMeetings(d); save('meetings', d); }
          if (j.data) { const d = j.data.reverse(); setJournals(d); save('journals', d); }
          if (inq.data) { const d = inq.data.map(r => ({...r, resolved: r.resolved === 'TRUE' || r.resolved === true})).reverse(); setInquiries(d); save('inquiries', d); }
          setSyncMsg('‚úì Synced');
        } catch(e) { setSyncMsg('Sync failed'); }
        setLoading(false);
        setTimeout(() => setSyncMsg(''), 3000);
      };

      useEffect(() => { syncFromSheets(); }, []);

      const clients = [...new Set(meals.map(m => m.clientName).filter(Boolean))];
      const toggleMeal = (id) => setExpandedMeals(p => ({...p, [id]: !p[id]}));
      const toggleJournal = (id) => setExpandedJournals(p => ({...p, [id]: !p[id]}));
      const toggleDate = (d) => setExpandedDates(p => ({...p, [d]: !p[d]}));
      const toggleInquiry = (id) => setExpandedInquiries(p => ({...p, [id]: !p[id]}));

      const filteredMeals = meals.filter(meal => {
        const cm = mode === 'coach' ? (selectedClient === 'all' || meal.clientName === selectedClient) : meal.clientName === clientName;
        return cm && (filterType === 'all' || meal.mealType === filterType);
      });
      const todayMeals = filteredMeals.filter(m => m.date === today);
      const mealsByDate = filteredMeals.reduce((acc, meal) => { if (!acc[meal.date]) acc[meal.date] = []; acc[meal.date].push(meal); return acc; }, {});
      const sortedDates = Object.keys(mealsByDate).sort((a,b) => new Date(b)-new Date(a));
      const filteredMeetings = meetings.filter(m => mode === 'coach' ? (selectedClient === 'all' || m.clientName === selectedClient) : m.clientName === clientName);
      const now = new Date();
      const pastMeetings = filteredMeetings.filter(m => new Date(m.date+' '+m.time) < now).sort((a,b) => new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time));
      const upcomingMeetings = filteredMeetings.filter(m => new Date(m.date+' '+m.time) >= now);
      const relevantMeals = mode === 'coach' ? (selectedClient === 'all' ? meals : meals.filter(m => m.clientName === selectedClient)) : meals.filter(m => m.clientName === clientName);
      const relevantJournals = mode === 'coach' ? (selectedClient === 'all' ? journals : journals.filter(j => j.clientName === selectedClient)) : journals.filter(j => j.clientName === clientName);
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
      const stats = {
        weekMeals: relevantMeals.filter(m => new Date(m.date) >= weekAgo && !m.isEmergency).length,
        specialNotes: relevantMeals.filter(m => m.isEmergency).length,
        journalEntries: relevantJournals.length,
        withFeedback: relevantMeals.filter(m => (m.feedback||[]).length > 0).length,
        totalClients: clients.length
      };
      const filteredInquiries = mode === 'coach' ? (selectedClient === 'all' ? inquiries : inquiries.filter(i => i.clientName === selectedClient)) : inquiries.filter(i => i.clientName === clientName);
      const unresolvedCount = filteredInquiries.filter(i => !i.resolved).length;

      const handleClientSignup = () => {
        if (!tempClientName.trim() || !tempClientPassword.trim()) return;
        setClientName(tempClientName.trim());
        localStorage.setItem('clientName', tempClientName.trim());
        localStorage.setItem('clientPassword', tempClientPassword.trim());
        setTempClientName(''); setTempClientPassword('');
      };
      const verifyAndClearClientName = () => {
        if (clientPassword === localStorage.getItem('clientPassword')) {
          setClientName(''); setClientPassword('');
          localStorage.removeItem('clientName'); localStorage.removeItem('clientPassword');
          setShowClientPasswordPrompt(false);
        } else { alert('Incorrect password'); setClientPassword(''); }
      };
      const handleCoachMode = () => { if (mode === 'coach') setMode('client'); else setShowPasswordPrompt(true); };
      const verifyPassword = () => {
        if (coachPassword === '9324') { setMode('coach'); setShowPasswordPrompt(false); setCoachPassword(''); }
        else { alert('Incorrect password'); setCoachPassword(''); }
      };

      const submitMeal = async () => {
        if (!mealForm.foods.trim() || !clientName.trim()) return;
        setSaving(true);
        const row = { id: Date.now(), clientName, date: mealForm.date, time: mealForm.time, mealType: mealForm.mealType, foods: mealForm.foods, fullness: mealForm.fullness, satietyHours: mealForm.satietyHours, emergencyType: '', feedback: '[]', isEmergency: false, timestamp: new Date().toLocaleString() };
        try { await apiCall('meals','append',{row}); } catch(e) {}
        const nm = [{...row, feedback: []}, ...meals]; setMeals(nm); save('meals', nm);
        setMealForm({ date: today, time: new Date().toTimeString().slice(0,5), mealType: 'Breakfast', foods: '', fullness: '', satietyHours: '' });
        setShowForm(false); setSaving(false);
      };
      const submitEmergency = async () => {
        if (!clientName.trim()) return;
        setSaving(true);
        const row = { id: Date.now(), clientName, date: emergencyForm.date, time: emergencyForm.time, mealType: 'Emergency', foods: emergencyForm.notes || emergencyForm.type, emergencyType: emergencyForm.type, fullness: '', satietyHours: '', feedback: '[]', isEmergency: true, timestamp: new Date().toLocaleString() };
        try { await apiCall('meals','append',{row}); } catch(e) {}
        const nm = [{...row, feedback: []}, ...meals]; setMeals(nm); save('meals', nm);
        setEmergencyForm({ type: 'Binge Eating', notes: '', date: today, time: new Date().toTimeString().slice(0,5) });
        setShowEmergencyForm(false); setSaving(false);
      };
      const submitJournal = async () => {
        if (!clientName.trim() || !journalForm.feelings.trim()) return;
        setSaving(true);
        const row = { id: Date.now(), clientName, date: journalForm.date, mood: journalForm.mood, energy: journalForm.energy, feelings: journalForm.feelings, notes: journalForm.notes, timestamp: new Date().toLocaleString() };
        try { await apiCall('journals','append',{row}); } catch(e) {}
        const nj = [row, ...journals]; setJournals(nj); save('journals', nj);
        setJournalForm({ date: today, mood: '', energy: '', feelings: '', notes: '' });
        setShowJournalForm(false); setSaving(false);
      };
      const submitPost = async () => {
        if (!postForm.title.trim() || !postForm.content.trim()) return;
        setSaving(true);
        const row = { id: Date.now(), title: postForm.title, content: postForm.content, date: new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) };
        try { await apiCall('posts','append',{row}); } catch(e) {}
        const np = [row, ...posts]; setPosts(np); save('posts', np);
        setPostForm({ title: '', content: '' }); setShowPostForm(false); setSaving(false);
      };
      const submitMeeting = async () => {
        const name = mode === 'coach' ? meetingForm.clientName : clientName;
        if (!meetingForm.title.trim() || !meetingForm.date || !meetingForm.time || !name.trim()) return;
        setSaving(true);
        const row = { id: Date.now(), clientName: name, date: meetingForm.date, time: meetingForm.time, title: meetingForm.title, notes: meetingForm.notes };
        try { await apiCall('meetings','append',{row}); } catch(e) {}
        const nm = [...meetings, row].sort((a,b) => new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time));
        setMeetings(nm); save('meetings', nm);
        setMeetingForm({ clientName: '', date: today, time: '', title: '', notes: '' }); setShowMeetingForm(false); setSaving(false);
      };
      const submitInquiry = async () => {
        if (!clientName.trim() || !inquiryForm.question.trim()) return;
        setSaving(true);
        const row = { id: Date.now(), clientName, category: inquiryForm.category, question: inquiryForm.question, answer: '', resolved: false, date: today, timestamp: new Date().toLocaleString() };
        try { await apiCall('inquiries','append',{row}); } catch(e) {}
        const ni = [row, ...inquiries]; setInquiries(ni); save('inquiries', ni);
        setInquiryForm({ category: 'Diet', question: '' }); setShowInquiryForm(false); setSaving(false);
      };
      const submitAnswer = async (id) => {
        if (!answerText.trim()) return;
        setSaving(true);
        try { await apiCall('inquiries','update',{id, row: {answer: answerText}}); } catch(e) {}
        const u = inquiries.map(i => i.id == id ? {...i, answer: answerText} : i);
        setInquiries(u); save('inquiries', u);
        setAnswerText(''); setAnsweringId(null); setSaving(false);
      };
      const toggleResolved = async (id) => {
        const inq = inquiries.find(i => i.id == id);
        const newVal = !inq.resolved;
        try { await apiCall('inquiries','update',{id, row: {resolved: newVal}}); } catch(e) {}
        const u = inquiries.map(i => i.id == id ? {...i, resolved: newVal} : i);
        setInquiries(u); save('inquiries', u);
      };
      const addFeedback = async (mealId) => {
        if (!feedbackText.trim()) return;
        setSaving(true);
        const meal = meals.find(m => m.id == mealId);
        const fb = [...(meal.feedback||[]), {id: Date.now(), text: feedbackText, timestamp: new Date().toLocaleString(), author: 'Coach'}];
        try { await apiCall('meals','update',{id: mealId, row: {feedback: JSON.stringify(fb)}}); } catch(e) {}
        const u = meals.map(m => m.id == mealId ? {...m, feedback: fb} : m);
        setMeals(u); save('meals', u);
        setFeedbackText(''); setSelectedMeal(null); setSaving(false);
      };
      const deleteMeal = async (id) => { try { await apiCall('meals','delete',{id}); } catch(e) {} const u = meals.filter(m => m.id != id); setMeals(u); save('meals', u); };
      const deletePost = async (id) => { try { await apiCall('posts','delete',{id}); } catch(e) {} const u = posts.filter(p => p.id != id); setPosts(u); save('posts', u); };
      const deleteMeeting = async (id) => { try { await apiCall('meetings','delete',{id}); } catch(e) {} const u = meetings.filter(m => m.id != id); setMeetings(u); save('meetings', u); };
      const deleteInquiry = async (id) => { try { await apiCall('inquiries','delete',{id}); } catch(e) {} const u = inquiries.filter(i => i.id != id); setInquiries(u); save('inquiries', u); };

      const Modal = ({ onClose, title, children }) => (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-sheet" onClick={e => e.stopPropagation()}>
            <div className="modal-handle" />
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
              <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:26,color:'#2D9078'}}>{title}</h2>
              <button onClick={onClose} style={{color:'#52C9A8',padding:4}}><Icons.X size={22} /></button>
            </div>
            {children}
          </div>
        </div>
      );

      const fullnessLabels = ['','Still hungry','A little full','Just right','Pretty full','Very full'];

      const MealCard = ({ meal }) => {
        const isExpanded = expandedMeals[meal.id];
        const feedbackList = meal.feedback || [];
        return (
          <div style={{background: meal.isEmergency ? '#E8F8F4' : '#fff', border: meal.isEmergency ? '1.5px solid #B8D4B9' : '1.5px solid #C8EDE6', borderRadius:18, overflow:'hidden', marginBottom:10}}>
            <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:12,textAlign:'left',background:'none',border:'none'}} onClick={() => toggleMeal(meal.id)}>
              <div style={{flex:1,display:'flex',alignItems:'center',gap:10,minWidth:0}}>
                {meal.isEmergency ? <span className="tag-sage">Special Note</span> : <span className="tag-dark">{meal.mealType}</span>}
                <span style={{fontWeight:600,color:'#2D9078',fontSize:14,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{meal.clientName}</span>
                <span style={{color:'#5A9A8E',fontSize:13,flexShrink:0}}>{meal.time}</span>
                {feedbackList.length > 0 && <span style={{color:'#5A9A8E',fontSize:12,flexShrink:0}}>üí¨ {feedbackList.length}</span>}
              </div>
              {isExpanded ? <Icons.ChevronUp size={18} color="#52C9A8" /> : <Icons.ChevronDown size={18} color="#52C9A8" />}
            </button>
            {isExpanded && (
              <div style={{padding:'0 18px 20px',borderTop:'1px solid #D4F2EB'}}>
                {mode === 'coach' && <div style={{display:'flex',justifyContent:'flex-end',paddingTop:12,marginBottom:8}}><button onClick={() => deleteMeal(meal.id)} style={{color:'#52C9A8'}}><Icons.X size={18} /></button></div>}
                <p style={{color:'#2D7060',lineHeight:1.6,marginTop: mode !== 'coach' ? 14 : 0,marginBottom:12}}>
                  {meal.isEmergency && meal.emergencyType && <span className="tag-warm" style={{marginRight:8,marginBottom:6,display:'inline-block'}}>{meal.emergencyType}</span>}
                  {meal.foods}
                </p>
                {(meal.fullness || meal.satietyHours) && (
                  <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap'}}>
                    {meal.fullness && <span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'4px 12px',fontSize:12,fontWeight:600}}>üçΩÔ∏è {fullnessLabels[meal.fullness] || meal.fullness}</span>}
                    {meal.satietyHours && <span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'4px 12px',fontSize:12,fontWeight:600}}>‚è±Ô∏è {meal.satietyHours}</span>}
                  </div>
                )}
                {feedbackList.length > 0 && (
                  <div style={{marginBottom:12}}>
                    {feedbackList.map((fb,i) => (
                      <div key={i} className="feedback-bubble" style={{marginBottom:8}}>
                        <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
                          <span style={{fontSize:12,fontWeight:700,color:'#3BAA8C'}}>{fb.author}</span>
                          <span style={{fontSize:11,color:'#5A9A8E'}}>{fb.timestamp}</span>
                        </div>
                        <p style={{color:'#2D7060',fontSize:14}}>{fb.text}</p>
                      </div>
                    ))}
                  </div>
                )}
                {mode === 'coach' && (selectedMeal == meal.id ? (
                  <div style={{display:'flex',gap:8,paddingTop:12,borderTop:'1px solid #D4F2EB'}}>
                    <input value={feedbackText} onChange={e => setFeedbackText(e.target.value)} placeholder="Write feedback..." className="input-field" style={{flex:1}} />
                    <button onClick={() => addFeedback(meal.id)} className="btn-sage" style={{padding:'10px 14px'}} disabled={saving}><Icons.Send size={16} /></button>
                    <button onClick={() => setSelectedMeal(null)} style={{color:'#52C9A8',padding:'10px'}}><Icons.X size={16} /></button>
                  </div>
                ) : (
                  <button onClick={() => setSelectedMeal(meal.id)} style={{color:'#3BAA8C',fontWeight:600,fontSize:14,paddingTop:12,borderTop:'1px solid #D4F2EB',width:'100%',textAlign:'left',background:'none',border:'none',borderTop:'1px solid #D4F2EB'}}>+ Add Feedback</button>
                ))}
              </div>
            )}
          </div>
        );
      };

      const tabs = [
        { id: 'meals', Icon: Icons.Utensils, label: 'Meals' },
        { id: 'journal', Icon: Icons.BookOpen, label: 'Journal' },
        { id: 'stats', Icon: Icons.TrendingUp, label: 'Stats' },
        { id: 'inquiries', Icon: Icons.MessageCircle, label: 'Q&A' },
        { id: 'posts', Icon: Icons.Bell, label: mode === 'client' ? 'Notice' : 'Posts' },
        { id: 'meetings', Icon: Icons.Calendar, label: 'Meetings' },
      ];

      return (
        <div className="app-bg">
          {/* Saving indicator */}
          {saving && <div style={{position:'fixed',top:0,left:0,right:0,zIndex:100,background:'#3BAA8C',color:'white',textAlign:'center',padding:'8px',fontSize:13,fontWeight:600}}>Saving...</div>}

          {/* Coach Password Modal */}
          {showPasswordPrompt && (
            <div className="modal-overlay" onClick={() => { setShowPasswordPrompt(false); setCoachPassword(''); }}>
              <div className="modal-sheet" onClick={e => e.stopPropagation()}>
                <div className="modal-handle" />
                <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:26,color:'#2D9078',marginBottom:8}}>Coach Access</h2>
                <p style={{color:'#5A9A8E',marginBottom:24,fontSize:15}}>Enter your password to continue</p>
                <input type="password" value={coachPassword} onChange={e => setCoachPassword(e.target.value)} onKeyDown={e => e.key==='Enter' && verifyPassword()} className="input-field" placeholder="Password" autoFocus style={{marginBottom:16}} />
                <div style={{display:'flex',gap:10}}>
                  <button onClick={verifyPassword} className="btn-primary" style={{flex:1,padding:'14px'}}>Enter</button>
                  <button onClick={() => { setShowPasswordPrompt(false); setCoachPassword(''); }} className="btn-outline" style={{flex:1,padding:'14px'}}>Cancel</button>
                </div>
              </div>
            </div>
          )}

          {/* Client Password Modal */}
          {showClientPasswordPrompt && (
            <div className="modal-overlay" onClick={() => { setShowClientPasswordPrompt(false); setClientPassword(''); }}>
              <div className="modal-sheet" onClick={e => e.stopPropagation()}>
                <div className="modal-handle" />
                <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:26,color:'#2D9078',marginBottom:8}}>Verify Identity</h2>
                <p style={{color:'#5A9A8E',marginBottom:24,fontSize:15}}>Enter your password to change name</p>
                <input type="password" value={clientPassword} onChange={e => setClientPassword(e.target.value)} onKeyDown={e => e.key==='Enter' && verifyAndClearClientName()} className="input-field" placeholder="Your Password" autoFocus style={{marginBottom:16}} />
                <div style={{display:'flex',gap:10}}>
                  <button onClick={verifyAndClearClientName} className="btn-primary" style={{flex:1,padding:'14px'}}>Verify</button>
                  <button onClick={() => { setShowClientPasswordPrompt(false); setClientPassword(''); }} className="btn-outline" style={{flex:1,padding:'14px'}}>Cancel</button>
                </div>
              </div>
            </div>
          )}

          {/* Header */}
          <div className="header-gradient" style={{padding:'20px 20px 0'}}>
            <div style={{maxWidth:640,margin:'0 auto'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:20}}>
                <div>
                  <h1 style={{fontFamily:'DM Serif Display,serif',fontSize:32,color:'#fff',letterSpacing:'-0.5px'}}>Mindfit</h1>
                  <p style={{color:'rgba(255,255,255,0.85)',fontSize:13,marginTop:2}}>Your Journey with Mindfit</p>
                </div>
                <div style={{display:'flex',gap:8,alignItems:'center'}}>
                  {syncMsg && <span style={{fontSize:12,color:'rgba(255,255,255,0.9)',fontWeight:600}}>{syncMsg}</span>}
                  <button onClick={syncFromSheets} style={{background:'rgba(255,255,255,0.2)',border:'1px solid rgba(255,255,255,0.3)',borderRadius:10,padding:'6px 10px',color:'#fff',fontSize:12,fontWeight:600}}>Sync</button>
                  <button onClick={handleCoachMode} style={{background:'rgba(255,255,255,0.25)',border:'1px solid rgba(255,255,255,0.4)',borderRadius:10,padding:'8px 12px',color:'#fff'}}>
                    {mode === 'coach' ? <Icons.User size={16} color="#fff" /> : <Icons.Users size={16} color="#fff" />}
                  </button>
                </div>
              </div>

              {mode === 'coach' && clients.length > 0 && (
                <div style={{marginBottom:16}}>
                  <select value={selectedClient} onChange={e => setSelectedClient(e.target.value)} style={{width:'100%',padding:'10px 14px',background:'rgba(255,255,255,0.2)',border:'1px solid rgba(255,255,255,0.3)',borderRadius:12,color:'#fff',fontSize:14,outline:'none'}}>
                    <option value="all" style={{color:'#333'}}>All Clients ({clients.length})</option>
                    {clients.map(c => <option key={c} value={c} style={{color:'#333'}}>{c}</option>)}
                  </select>
                </div>
              )}

              {mode === 'client' && !clientName && (
                <div style={{background:'rgba(255,255,255,0.15)',borderRadius:18,padding:20,marginBottom:16,border:'1px solid rgba(255,255,255,0.2)'}}>
                  <p style={{color:'#fff',fontWeight:600,marginBottom:14,fontFamily:'DM Serif Display,serif',fontSize:18}}>Welcome! Let's get started.</p>
                  <div style={{display:'flex',flexDirection:'column',gap:10}}>
                    <input type="text" value={tempClientName} onChange={e => setTempClientName(e.target.value)} placeholder="Your Name" style={{width:'100%',padding:'12px 14px',background:'rgba(255,255,255,0.92)',border:'none',borderRadius:12,fontSize:15,outline:'none'}} />
                    <input type="password" value={tempClientPassword} onChange={e => setTempClientPassword(e.target.value)} onKeyDown={e => e.key==='Enter' && handleClientSignup()} placeholder="Set a Password" style={{width:'100%',padding:'12px 14px',background:'rgba(255,255,255,0.92)',border:'none',borderRadius:12,fontSize:15,outline:'none'}} />
                    <button onClick={handleClientSignup} style={{width:'100%',padding:'13px',background:'rgba(255,255,255,0.95)',color:'#3BAA8C',border:'none',borderRadius:12,fontWeight:700,fontSize:15,cursor:'pointer'}}>Start My Journey</button>
                  </div>
                </div>
              )}

              {mode === 'client' && clientName && (
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',background:'rgba(255,255,255,0.2)',borderRadius:12,padding:'10px 14px',marginBottom:16}}>
                  <div style={{display:'flex',alignItems:'center',gap:8}}>
                    <div style={{width:32,height:32,background:'rgba(255,255,255,0.3)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:700,fontSize:14}}>{clientName[0]?.toUpperCase()}</div>
                    <span style={{color:'#fff',fontWeight:600,fontSize:15}}>{clientName}</span>
                  </div>
                  <button onClick={() => setShowClientPasswordPrompt(true)} style={{color:'#fff',fontSize:13,fontWeight:600,background:'none',border:'none',cursor:'pointer'}}>Change</button>
                </div>
              )}

              {/* Tabs */}
              <div style={{display:'flex',overflowX:'auto'}}>
                {tabs.map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{position:'relative',display:'flex',flexDirection:'column',alignItems:'center',gap:4,padding:'10px 14px 14px',background:'none',border:'none',borderBottom: activeTab === tab.id ? '2.5px solid #fff' : '2.5px solid transparent',color: activeTab === tab.id ? '#fff' : 'rgba(255,255,255,0.55)',cursor:'pointer',whiteSpace:'nowrap',transition:'all 0.15s',minWidth:60}}>
                    <tab.Icon size={18} color={activeTab === tab.id ? '#fff' : 'rgba(255,255,255,0.55)'} />
                    <span style={{fontSize:11,fontWeight:600}}>{tab.label}</span>
                    {tab.id === 'inquiries' && unresolvedCount > 0 && <span className="badge">{unresolvedCount}</span>}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Content */}
          <div style={{maxWidth:640,margin:'0 auto',padding:'20px 16px 100px'}}>

            {/* MEALS */}
            {activeTab === 'meals' && (
              <div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
                  <div>
                    <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>Today's Meals</h2>
                    <p style={{color:'#5A9A8E',fontSize:13,marginTop:2}}>{todayLabel}</p>
                  </div>
                  <select value={filterType} onChange={e => setFilterType(e.target.value)} style={{padding:'8px 12px',border:'1.5px solid #C8EDE6',borderRadius:10,fontSize:13,background:'#fff',color:'#2D9078',outline:'none'}}>
                    <option value="all">All</option>
                    {['Breakfast','Lunch','Dinner','Snack'].map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>

                {mode === 'client' && clientName && (
                  <div style={{display:'flex',flexDirection:'column',gap:10,marginBottom:24}}>
                    <button onClick={() => setShowForm(true)} style={{width:'100%',padding:'18px',background:'#3BAA8C',color:'#fff',border:'none',borderRadius:16,fontWeight:600,fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
                      <Icons.Plus size={20} color="#fff" /> Log a Meal
                    </button>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                      <button onClick={() => setShowJournalForm(true)} style={{padding:'16px',background:'#fff',border:'1.5px solid #C8EDE6',borderRadius:16,fontWeight:600,fontSize:14,cursor:'pointer',color:'#2D9078',display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
                        <Icons.BookOpen size={18} color="#3BAA8C" /> Daily Journal
                      </button>
                      <button onClick={() => setShowEmergencyForm(true)} style={{padding:'16px',background:'#E8F8F4',border:'1.5px solid #B8D4B9',borderRadius:16,fontWeight:600,fontSize:14,cursor:'pointer',color:'#3BAA8C',display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
                        Special Note
                      </button>
                    </div>
                  </div>
                )}

                {todayMeals.length === 0 ? (
                  <div className="card" style={{padding:40,textAlign:'center'}}>
                    <div style={{fontSize:48,marginBottom:12}}>üçΩÔ∏è</div>
                    <p style={{color:'#5A9A8E',fontWeight:600,fontSize:16}}>No meals logged today</p>
                    <p style={{color:'#A8DDD5',fontSize:14,marginTop:6}}>Past records are in the Stats tab</p>
                  </div>
                ) : todayMeals.map(meal => <MealCard key={meal.id} meal={meal} />)}
              </div>
            )}

            {/* JOURNAL */}
            {activeTab === 'journal' && (
              <div>
                <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58',marginBottom:20}}>Journal</h2>
                {relevantJournals.length === 0 ? (
                  <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üìî</div><p style={{color:'#5A9A8E',fontWeight:600,fontSize:16}}>No journal entries yet</p></div>
                ) : relevantJournals.map(journal => {
                  const isExpanded = expandedJournals[journal.id];
                  return (
                    <div key={journal.id} className="card-warm" style={{marginBottom:10,overflow:'hidden'}}>
                      <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:12,textAlign:'left',background:'none',border:'none'}} onClick={() => toggleJournal(journal.id)}>
                        <span style={{fontSize:28}}>{journal.mood || 'üìî'}</span>
                        <div style={{flex:1}}>
                          <p style={{fontWeight:600,color:'#2D9078',fontSize:15}}>{journal.date}</p>
                          <p style={{color:'#5A9A8E',fontSize:13}}>{journal.clientName}</p>
                        </div>
                        {journal.energy && <span style={{fontSize:13,color:'#3BAA8C',fontWeight:700}}>‚ö° {journal.energy}/5</span>}
                        {isExpanded ? <Icons.ChevronUp size={18} color="#52C9A8" /> : <Icons.ChevronDown size={18} color="#52C9A8" />}
                      </button>
                      {isExpanded && (
                        <div style={{padding:'0 18px 18px',borderTop:'1px solid #D4F2EB'}}>
                          <div style={{background:'#E8F8F4',borderRadius:12,padding:'12px 14px',marginTop:14,marginBottom:10}}>
                            <p style={{fontSize:11,fontWeight:700,color:'#5A9A8E',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.05em'}}>Feelings</p>
                            <p style={{color:'#2D7060',lineHeight:1.6,fontSize:14}}>{journal.feelings}</p>
                          </div>
                          {journal.notes && <p style={{color:'#5A9A8E',fontSize:14,lineHeight:1.5}}>{journal.notes}</p>}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}

            {/* STATS */}
            {activeTab === 'stats' && (
              <div>
                <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58',marginBottom:20}}>Progress</h2>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:24}}>
                  {mode === 'coach' && selectedClient === 'all' && (
                    <div className="stat-card" style={{gridColumn:'span 2',background:'linear-gradient(135deg,#3BAA8C,#52C9A8)',color:'white'}}>
                      <p style={{fontSize:40,fontWeight:700,fontFamily:'DM Serif Display,serif'}}>{stats.totalClients}</p>
                      <p style={{opacity:0.85,fontSize:13,marginTop:4,fontWeight:600}}>Total Clients</p>
                    </div>
                  )}
                  {[
                    {value:stats.weekMeals,label:'Meals This Week',icon:'üçΩÔ∏è'},
                    {value:stats.specialNotes,label:'Special Notes',icon:'üìã'},
                    {value:stats.journalEntries,label:'Journal Entries',icon:'üìî'},
                    {value:stats.withFeedback,label:'With Feedback',icon:'üí¨'},
                  ].map((s,i) => (
                    <div key={i} className="stat-card">
                      <p style={{fontSize:13,marginBottom:8}}>{s.icon}</p>
                      <p style={{fontSize:32,fontWeight:700,color:'#1A6B58',fontFamily:'DM Serif Display,serif'}}>{s.value}</p>
                      <p style={{color:'#4A8A7E',fontSize:13,fontWeight:600,marginTop:4}}>{s.label}</p>
                    </div>
                  ))}
                </div>
                <h3 style={{fontWeight:700,color:'#1A6B58',fontSize:17,marginBottom:14}}>All Records</h3>
                {sortedDates.length === 0 ? (
                  <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:40,marginBottom:12}}>üìä</div><p style={{color:'#5A9A8E',fontWeight:600}}>No records yet</p></div>
                ) : sortedDates.map(date => {
                  const dateMeals = mealsByDate[date];
                  const isExpanded = expandedDates[date];
                  return (
                    <div key={date} className="card-warm" style={{marginBottom:10,overflow:'hidden'}}>
                      <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:10,textAlign:'left',background:'none',border:'none'}} onClick={() => toggleDate(date)}>
                        <div style={{flex:1,display:'flex',alignItems:'center',gap:8}}>
                          <span style={{fontWeight:700,color:'#1A6B58',fontSize:15}}>{date}</span>
                          <span style={{color:'#4A8A7E',fontSize:13,fontWeight:600}}>{dateMeals.length} meals</span>
                          {dateMeals.some(m => m.isEmergency) && <span className="tag-sage" style={{fontSize:11}}>Special</span>}
                          {date === today && <span className="tag-dark" style={{fontSize:11}}>Today</span>}
                        </div>
                        {isExpanded ? <Icons.ChevronUp size={16} color="#52C9A8" /> : <Icons.ChevronDown size={16} color="#52C9A8" />}
                      </button>
                      {isExpanded && (
                        <div style={{borderTop:'1px solid #D4F2EB'}}>
                          {dateMeals.map((meal,i) => (
                            <div key={meal.id} style={{padding:'12px 18px',borderBottom: i < dateMeals.length-1 ? '1px solid #D4F2EB' : 'none'}}>
                              <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                                {meal.isEmergency ? <span className="tag-sage" style={{fontSize:11}}>Special</span> : <span className="tag-dark" style={{fontSize:11}}>{meal.mealType}</span>}
                                <span style={{color:'#5A9A8E',fontSize:12}}>{meal.time}</span>
                                {mode === 'coach' && <span style={{color:'#3BAA8C',fontSize:12,fontWeight:600}}>{meal.clientName}</span>}
                              </div>
                              <p style={{color:'#2D7060',fontSize:14,lineHeight:1.5}}>{meal.foods}</p>
                              {(meal.fullness || meal.satietyHours) && (
                                <div style={{display:'flex',gap:6,marginTop:6,flexWrap:'wrap'}}>
                                  {meal.fullness && <span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'3px 10px',fontSize:11,fontWeight:600}}>üçΩÔ∏è {fullnessLabels[meal.fullness] || meal.fullness}</span>}
                                  {meal.satietyHours && <span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'3px 10px',fontSize:11,fontWeight:600}}>‚è±Ô∏è {meal.satietyHours}</span>}
                                </div>
                              )}
                              {(meal.feedback||[]).map((fb,fi) => <p key={fi} style={{color:'#3BAA8C',fontSize:13,marginTop:4}}>üí¨ {fb.text}</p>)}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}

            {/* Q&A */}
            {activeTab === 'inquiries' && (
              <div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
                  <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>Q&A</h2>
                  {mode === 'client' && clientName && (
                    <button onClick={() => setShowInquiryForm(true)} className="btn-primary" style={{padding:'10px 18px',fontSize:14,display:'flex',alignItems:'center',gap:6}}>
                      <Icons.Plus size={16} color="#fff" /> New Question
                    </button>
                  )}
                </div>
                {filteredInquiries.length === 0 ? (
                  <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üí¨</div><p style={{color:'#5A9A8E',fontWeight:600,fontSize:16}}>No inquiries yet</p><p style={{color:'#A8DDD5',fontSize:14,marginTop:6}}>Ask your coach anything!</p></div>
                ) : filteredInquiries.map(inq => {
                  const isExpanded = expandedInquiries[inq.id];
                  const borderColor = inq.resolved ? '#52C9A8' : inq.answer ? '#3BAA8C' : '#F0B86E';
                  return (
                    <div key={inq.id} style={{background: inq.resolved ? '#F4FBFA' : '#fff',border:'1.5px solid #C8EDE6',borderLeft:`4px solid ${borderColor}`,borderRadius:16,marginBottom:10,overflow:'hidden',opacity: inq.resolved ? 0.8 : 1}}>
                      <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:10,textAlign:'left',background:'none',border:'none'}} onClick={() => toggleInquiry(inq.id)}>
                        <div style={{flex:1,display:'flex',alignItems:'center',gap:8,minWidth:0}}>
                          <span className="tag-sage" style={{fontSize:11,flexShrink:0}}>{inq.category}</span>
                          <span style={{fontWeight:500,color:'#2D7060',fontSize:14,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{inq.question}</span>
                        </div>
                        <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                          {inq.resolved ? <Icons.Check size={16} color="#3BAA8C" /> : !inq.answer ? <span style={{fontSize:11,color:'#C8963E',fontWeight:600,background:'#FEF3E2',padding:'2px 8px',borderRadius:10}}>Pending</span> : <span style={{fontSize:11,color:'#2D9078',fontWeight:600,background:'#D4F2EB',padding:'2px 8px',borderRadius:10}}>Answered</span>}
                          {isExpanded ? <Icons.ChevronUp size={16} color="#52C9A8" /> : <Icons.ChevronDown size={16} color="#52C9A8" />}
                        </div>
                      </button>
                      {isExpanded && (
                        <div style={{padding:'0 18px 18px',borderTop:'1px solid #D4F2EB'}}>
                          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',paddingTop:12,marginBottom:14}}>
                            <span style={{color:'#5A9A8E',fontSize:12}}>{inq.date} ¬∑ {inq.clientName}</span>
                            {mode === 'coach' && (
                              <div style={{display:'flex',gap:8}}>
                                <button onClick={() => toggleResolved(inq.id)} style={{fontSize:12,padding:'4px 12px',background: inq.resolved ? '#E8F8F4' : '#D4F2EB',color: inq.resolved ? '#5A9A8E' : '#2D9078',borderRadius:10,fontWeight:600,border:'none',cursor:'pointer'}}>{inq.resolved ? 'Unresolve' : '‚úì Resolved'}</button>
                                <button onClick={() => deleteInquiry(inq.id)} style={{color:'#52C9A8',background:'none',border:'none',cursor:'pointer'}}><Icons.X size={16} /></button>
                              </div>
                            )}
                          </div>
                          <div style={{background:'#E8F8F4',borderRadius:12,padding:'12px 14px',marginBottom:12}}>
                            <p style={{fontSize:11,fontWeight:700,color:'#5A9A8E',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.05em'}}>Question</p>
                            <p style={{color:'#2D7060',lineHeight:1.6,fontSize:14}}>{inq.question}</p>
                          </div>
                          {inq.answer ? (
                            <div className="answer-bubble">
                              <p style={{fontSize:11,fontWeight:700,color:'rgba(255,255,255,0.6)',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.05em'}}>Coach Reply</p>
                              <p style={{fontSize:14,lineHeight:1.6}}>{inq.answer}</p>
                            </div>
                          ) : mode === 'coach' ? (
                            answeringId == inq.id ? (
                              <div style={{display:'flex',flexDirection:'column',gap:8}}>
                                <textarea value={answerText} onChange={e => setAnswerText(e.target.value)} placeholder="Write your reply..." className="input-field" rows={4} style={{resize:'none'}} />
                                <div style={{display:'flex',gap:8}}>
                                  <button onClick={() => submitAnswer(inq.id)} className="btn-primary" style={{flex:1,padding:'12px'}} disabled={saving}>Submit Reply</button>
                                  <button onClick={() => { setAnsweringId(null); setAnswerText(''); }} style={{padding:'12px 14px',background:'#E8F8F4',border:'none',borderRadius:12,cursor:'pointer'}}><Icons.X size={16} color="#5A9A8E" /></button>
                                </div>
                              </div>
                            ) : <button onClick={() => setAnsweringId(inq.id)} className="btn-primary" style={{width:'100%',padding:'12px'}}>Reply</button>
                          ) : (
                            <div style={{background:'#E8F8F4',borderRadius:12,padding:'14px',textAlign:'center'}}>
                              <p style={{color:'#5A9A8E',fontSize:14}}>Your coach will reply soon üåø</p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}

            {/* POSTS */}
            {activeTab === 'posts' && (
              <div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
                  <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>{mode === 'client' ? 'Notice' : 'Posts'}</h2>
                  {mode === 'coach' && <button onClick={() => setShowPostForm(true)} className="btn-primary" style={{padding:'10px 18px',fontSize:14,display:'flex',alignItems:'center',gap:6}}><Icons.Plus size={16} color="#fff" /> New Post</button>}
                </div>
                {posts.length === 0 ? (
                  <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üì¢</div><p style={{color:'#5A9A8E',fontWeight:600}}>No posts yet</p></div>
                ) : posts.map(post => (
                  <div key={post.id} className="card" style={{padding:22,marginBottom:12}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:12}}>
                      <div>
                        <h3 style={{fontFamily:'DM Serif Display,serif',fontSize:19,color:'#1A6B58',marginBottom:4}}>{post.title}</h3>
                        <p style={{color:'#5A9A8E',fontSize:12}}>{post.date}</p>
                      </div>
                      {mode === 'coach' && <button onClick={() => deletePost(post.id)} style={{color:'#52C9A8',background:'none',border:'none',cursor:'pointer'}}><Icons.X size={18} /></button>}
                    </div>
                    <p style={{color:'#2D7060',lineHeight:1.7,fontSize:15,whiteSpace:'pre-line'}}>{post.content}</p>
                  </div>
                ))}
              </div>
            )}

            {/* MEETINGS */}
            {activeTab === 'meetings' && (
              <div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
                  <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>Meetings</h2>
                  {mode === 'coach' && <button onClick={() => setShowMeetingForm(true)} className="btn-primary" style={{padding:'10px 18px',fontSize:14,display:'flex',alignItems:'center',gap:6}}><Icons.Plus size={16} color="#fff" /> Schedule</button>}
                </div>
                {upcomingMeetings.length > 0 && (
                  <div style={{marginBottom:24}}>
                    <p style={{fontSize:12,fontWeight:700,color:'#5A9A8E',textTransform:'uppercase',letterSpacing:'0.08em',marginBottom:12}}>Upcoming</p>
                    {upcomingMeetings.map(m => (
                      <div key={m.id} className="upcoming-meeting" style={{marginBottom:10}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                          <div>
                            <p style={{fontFamily:'DM Serif Display,serif',fontSize:20,marginBottom:6}}>{m.title}</p>
                            <p style={{opacity:0.75,fontSize:13}}>{m.date} ¬∑ {m.time}</p>
                            {mode === 'coach' && <p style={{opacity:0.9,fontSize:14,marginTop:4,fontWeight:600}}>{m.clientName}</p>}
                          </div>
                          {mode === 'coach' && <button onClick={() => deleteMeeting(m.id)} style={{color:'rgba(255,255,255,0.5)',background:'none',border:'none',cursor:'pointer'}}><Icons.X size={18} /></button>}
                        </div>
                        {m.notes && <p style={{opacity:0.8,fontSize:14,marginTop:10,lineHeight:1.5}}>{m.notes}</p>}
                      </div>
                    ))}
                  </div>
                )}
                {pastMeetings.length > 0 && (
                  <div>
                    <p style={{fontSize:12,fontWeight:700,color:'#5A9A8E',textTransform:'uppercase',letterSpacing:'0.08em',marginBottom:12}}>Past</p>
                    {mode === 'client' && <div className="stat-card" style={{marginBottom:14,display:'flex',alignItems:'center',gap:14}}><p style={{fontSize:36,fontWeight:700,color:'#1A6B58',fontFamily:'DM Serif Display,serif'}}>{pastMeetings.length}</p><p style={{color:'#5A9A8E',fontSize:14,fontWeight:600}}>Sessions completed</p></div>}
                    {pastMeetings.map(m => (
                      <div key={m.id} className="card-warm" style={{padding:18,marginBottom:10,opacity:0.75}}>
                        <div style={{display:'flex',justifyContent:'space-between'}}>
                          <div>
                            <p style={{fontWeight:600,color:'#2D9078',fontSize:15,marginBottom:4}}>{m.title}</p>
                            <p style={{color:'#5A9A8E',fontSize:13}}>{m.date} ¬∑ {m.time}</p>
                            {mode === 'coach' && <p style={{color:'#3BAA8C',fontSize:13,marginTop:4}}>{m.clientName}</p>}
                          </div>
                          {mode === 'coach' && <button onClick={() => deleteMeeting(m.id)} style={{color:'#52C9A8',background:'none',border:'none',cursor:'pointer'}}><Icons.X size={16} /></button>}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                {filteredMeetings.length === 0 && <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üìÖ</div><p style={{color:'#5A9A8E',fontWeight:600}}>No meetings yet</p></div>}
              </div>
            )}
          </div>

          {/* MODALS */}
          {showForm && (
            <Modal onClose={() => setShowForm(false)} title="Log a Meal">
              <div style={{display:'flex',flexDirection:'column',gap:16}}>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                  <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Date</label><input type="date" value={mealForm.date} onChange={e => setMealForm({...mealForm,date:e.target.value})} className="input-field" /></div>
                  <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Time</label><input type="time" value={mealForm.time} onChange={e => setMealForm({...mealForm,time:e.target.value})} className="input-field" /></div>
                </div>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>Meal Type</label>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
                    {['Breakfast','Lunch','Dinner','Snack'].map(t => <button key={t} onClick={() => setMealForm({...mealForm,mealType:t})} className={mealForm.mealType===t?'meal-type-active':'meal-type'} style={{padding:'10px 4px',fontSize:13,fontWeight:600,border:'none',cursor:'pointer'}}>{t}</button>)}
                  </div>
                </div>
                <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>What did you eat?</label><textarea value={mealForm.foods} onChange={e => setMealForm({...mealForm,foods:e.target.value})} placeholder="Describe your meal..." className="input-field" rows={3} style={{resize:'none'}} /></div>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>How full did you feel after? üçΩÔ∏è</label>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}>
                    {[{value:'1',label:'Still hungry',emoji:'üò∂'},{value:'2',label:'A little full',emoji:'üôÇ'},{value:'3',label:'Just right',emoji:'üòä'},{value:'4',label:'Pretty full',emoji:'üòå'},{value:'5',label:'Very full',emoji:'ü§¢'}].map(o => (
                      <button key={o.value} onClick={() => setMealForm({...mealForm,fullness:o.value})} style={{padding:'10px 4px',background:mealForm.fullness===o.value?'#3BAA8C':'#D4F2EB',color:mealForm.fullness===o.value?'white':'#2D9078',borderRadius:12,border:'none',cursor:'pointer',fontSize:11,fontWeight:600,textAlign:'center'}}>
                        <div style={{fontSize:20,marginBottom:4}}>{o.emoji}</div>{o.label}
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>How long did you stay full? ‚è±Ô∏è</label>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
                    {[{value:'1-2h',label:'1‚Äì2 hours'},{value:'2-3h',label:'2‚Äì3 hours'},{value:'3-4h',label:'3‚Äì4 hours'},{value:'4h+',label:'4+ hours'}].map(o => (
                      <button key={o.value} onClick={() => setMealForm({...mealForm,satietyHours:o.value})} style={{padding:'12px 6px',background:mealForm.satietyHours===o.value?'#52C9A8':'#D4F2EB',color:mealForm.satietyHours===o.value?'white':'#2D9078',borderRadius:12,border:'none',cursor:'pointer',fontSize:12,fontWeight:600,textAlign:'center'}}>
                        {o.label}
                      </button>
                    ))}
                  </div>
                </div>
                <button onClick={submitMeal} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Save Meal</button>
              </div>
            </Modal>
          )}

          {showJournalForm && (
            <Modal onClose={() => setShowJournalForm(false)} title="Daily Journal">
              <div style={{display:'flex',flexDirection:'column',gap:18}}>
                <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Date</label><input type="date" value={journalForm.date} onChange={e => setJournalForm({...journalForm,date:e.target.value})} className="input-field" /></div>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:10}}>How did eating feel today?</label>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}>
                    {['üò¢','üòï','üòê','üôÇ','üòä'].map(e => <button key={e} onClick={() => setJournalForm({...journalForm,mood:e})} className={journalForm.mood===e?'mood-active':'mood-btn'} style={{padding:'12px 4px',fontSize:26,border:'none',cursor:'pointer',transition:'all 0.15s'}}>{e}</button>)}
                  </div>
                </div>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:10}}>Energy Level</label>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}>
                    {['1','2','3','4','5'].map(l => <button key={l} onClick={() => setJournalForm({...journalForm,energy:l})} className={journalForm.energy===l?'energy-active':'energy-btn'} style={{padding:'12px 4px',fontSize:16,fontWeight:700,border:'none',cursor:'pointer',borderRadius:10}}>{l}</button>)}
                  </div>
                  <p style={{fontSize:12,color:'#5A9A8E',marginTop:6,textAlign:'center'}}>1 = Very Low ¬∑ 5 = Very High</p>
                </div>
                <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>How are you feeling?</label><textarea value={journalForm.feelings} onChange={e => setJournalForm({...journalForm,feelings:e.target.value})} placeholder="Share your thoughts, emotions..." className="input-field" rows={4} style={{resize:'none'}} /></div>
                <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Additional Notes</label><textarea value={journalForm.notes} onChange={e => setJournalForm({...journalForm,notes:e.target.value})} placeholder="Anything else on your mind..." className="input-field" rows={3} style={{resize:'none'}} /></div>
                <button onClick={submitJournal} className="btn-sage" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Save Journal</button>
              </div>
            </Modal>
          )}

          {showEmergencyForm && (
            <Modal onClose={() => setShowEmergencyForm(false)} title="Special Note">
              <div style={{display:'flex',flexDirection:'column',gap:16}}>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                  <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Date</label><input type="date" value={emergencyForm.date} onChange={e => setEmergencyForm({...emergencyForm,date:e.target.value})} className="input-field" /></div>
                  <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Time</label><input type="time" value={emergencyForm.time} onChange={e => setEmergencyForm({...emergencyForm,time:e.target.value})} className="input-field" /></div>
                </div>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:10}}>What happened?</label>
                  <div style={{display:'flex',flexDirection:'column',gap:8}}>
                    {[{value:'Binge Eating',emoji:'üçî'},{value:'Purging',emoji:'ü§¢'},{value:'Meal Avoidance',emoji:'üò∞'}].map(t => (
                      <button key={t.value} onClick={() => setEmergencyForm({...emergencyForm,type:t.value})} style={{padding:'14px 16px',background:emergencyForm.type===t.value?'#D4F2EB':'#F4FBFA',border:emergencyForm.type===t.value?'2px solid #3BAA8C':'2px solid transparent',borderRadius:14,fontWeight:600,fontSize:15,textAlign:'left',display:'flex',alignItems:'center',gap:10,cursor:'pointer',color:emergencyForm.type===t.value?'#2D9078':'#5A9A8E'}}>
                        <span style={{fontSize:22}}>{t.emoji}</span>{t.value}
                      </button>
                    ))}
                  </div>
                </div>
                <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Notes (Optional)</label><textarea value={emergencyForm.notes} onChange={e => setEmergencyForm({...emergencyForm,notes:e.target.value})} placeholder="How are you feeling? Any triggers?" className="input-field" rows={3} style={{resize:'none'}} /></div>
                <div style={{background:'#D4F2EB',borderRadius:14,padding:'14px 16px'}}>
                  <p style={{color:'#2D9078',fontSize:14,lineHeight:1.6,textAlign:'center'}}>üåø It's okay that this happened. Every step of awareness is part of healing.</p>
                </div>
                <button onClick={submitEmergency} className="btn-sage" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Submit Report</button>
              </div>
            </Modal>
          )}

          {showInquiryForm && (
            <Modal onClose={() => setShowInquiryForm(false)} title="New Question">
              <div style={{display:'flex',flexDirection:'column',gap:16}}>
                <div>
                  <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>Category</label>
                  <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8}}>
                    {['Diet','Exercise','Other'].map(c => <button key={c} onClick={() => setInquiryForm({...inquiryForm,category:c})} className={inquiryForm.category===c?'category-btn-active':'category-btn'} style={{padding:'12px',fontSize:14,fontWeight:600,border:'none',cursor:'pointer'}}>{c}</button>)}
                  </div>
                </div>
                <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Your Question</label><textarea value={inquiryForm.question} onChange={e => setInquiryForm({...inquiryForm,question:e.target.value})} placeholder="Ask your coach anything..." className="input-field" rows={5} style={{resize:'none'}} /></div>
                <button onClick={submitInquiry} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Send Question</button>
              </div>
            </Modal>
          )}

          {showPostForm && (
            <Modal onClose={() => setShowPostForm(false)} title="New Post">
              <div style={{display:'flex',flexDirection:'column',gap:14}}>
                <input type="text" value={postForm.title} onChange={e => setPostForm({...postForm,title:e.target.value})} placeholder="Title" className="input-field" style={{fontWeight:600,fontSize:16}} />
                <textarea value={postForm.content} onChange={e => setPostForm({...postForm,content:e.target.value})} placeholder="Write your announcement..." className="input-field" rows={8} style={{resize:'none'}} />
                <button onClick={submitPost} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Publish</button>
              </div>
            </Modal>
          )}

          {showMeetingForm && (
            <Modal onClose={() => setShowMeetingForm(false)} title="Schedule Meeting">
              <div style={{display:'flex',flexDirection:'column',gap:14}}>
                <input type="text" value={meetingForm.clientName} onChange={e => setMeetingForm({...meetingForm,clientName:e.target.value})} placeholder="Client Name" className="input-field" style={{fontWeight:600}} />
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                  <input type="date" value={meetingForm.date} onChange={e => setMeetingForm({...meetingForm,date:e.target.value})} className="input-field" />
                  <input type="time" value={meetingForm.time} onChange={e => setMeetingForm({...meetingForm,time:e.target.value})} className="input-field" />
                </div>
                <input type="text" value={meetingForm.title} onChange={e => setMeetingForm({...meetingForm,title:e.target.value})} placeholder="Meeting Title" className="input-field" style={{fontWeight:600}} />
                <textarea value={meetingForm.notes} onChange={e => setMeetingForm({...meetingForm,notes:e.target.value})} placeholder="Notes (optional)" className="input-field" rows={3} style={{resize:'none'}} />
                <button onClick={submitMeeting} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Schedule</button>
              </div>
            </Modal>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
