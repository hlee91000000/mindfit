<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="color-scheme" content="light"/>
<title>Mindfit</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;600&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#F4FBFA;font-family:'DM Sans',sans-serif;color:#2D7060;min-height:100vh}
button{cursor:pointer;font-family:'DM Sans',sans-serif;border:none;background:none}
input,textarea,select{font-family:'DM Sans',sans-serif;font-size:16px}
.card{background:#fff;border-radius:20px;box-shadow:0 2px 12px rgba(0,0,0,.07)}
.cw{background:#FAFEFE;border-radius:20px;border:1px solid #C8EDE6}
.bp{background:#3BAA8C;color:#fff;border-radius:14px;font-weight:600;border:none;cursor:pointer;font-family:'DM Sans',sans-serif}
.bs{background:#52C9A8;color:#fff;border-radius:14px;font-weight:600;border:none;cursor:pointer;font-family:'DM Sans',sans-serif}
.bo{background:transparent;border:2px solid #3BAA8C;color:#3BAA8C;border-radius:14px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.inp{border:1.5px solid #B8E8DF;border-radius:12px;padding:12px 16px;font-size:16px;background:#FAFEFE;color:#2D7060;width:100%;outline:none}
.inp:focus{border-color:#3BAA8C}
.ts{background:#D4F2EB;color:#2D9078;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:600;display:inline-block}
.td{background:#3BAA8C;color:#fff;border-radius:20px;padding:3px 12px;font-size:12px;font-weight:600;display:inline-block}
.hdr{background:linear-gradient(135deg,#3BAA8C,#52C9A8)}
.st{background:#fff;border-radius:18px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.ov{position:fixed;inset:0;background:rgba(30,80,60,.45);display:flex;align-items:flex-end;justify-content:center;z-index:50}
.sh{background:#FAFEFE;border-radius:24px 24px 0 0;width:100%;max-width:640px;max-height:92vh;overflow-y:auto;padding:28px 24px 40px}
.hdl{width:36px;height:4px;background:#B8E8DF;border-radius:2px;margin:0 auto 24px}
.upc{background:linear-gradient(135deg,#3BAA8C,#52C9A8);border-radius:18px;color:white;padding:20px}
.bdg{background:#E05C5C;color:white;border-radius:50%;width:18px;height:18px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;position:absolute;top:6px;right:2px}
::-webkit-scrollbar{width:0}
</style>
</head>
<body>
<div id="app"></div>
<script>
'use strict';

var SHEETS='https://script.google.com/macros/s/AKfycbwhfh02uDuFnpPzoLbtrFOO-lT1DvVzwrk2Zp2ZwZ8gFpejkCyfTT5-2I2h4Q2sJXU7wg/exec';
var CNAME='dblqwqgnz', CPRES='mindfit_posts';
var PPID='ARllutZeJShzQMPZMOwIX7vD8CRA4g-LBq9-DnTjHi5tn4H8qrfrgkT0LX_fcDnmiT3zktRdoNM6F-B1';
var CPW='9324';
var FL=['','Still hungry','A little full','Just right','Pretty full','Very full'];
var PLANS=[
  {id:'monthly', name:'Monthly Plan', price:'150.00', desc:'Full coaching - 1 month', e:'üåø'},
  {id:'quarterly', name:'3-Month Plan', price:'400.00', desc:'Best value - save SGD 50', e:'‚≠ê'},
  {id:'session', name:'Single Session', price:'80.00', desc:'One-on-one session', e:'üí¨'}
];

function lsGet(k){try{var v=localStorage.getItem(k);return v?JSON.parse(v):[]}catch(e){return[]}}
function lsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function lsStr(k){return localStorage.getItem(k)||''}
function lsSetStr(k,v){localStorage.setItem(k,v)}
function lsRm(k){localStorage.removeItem(k)}
function lsObj(k){try{var v=localStorage.getItem(k);return v?JSON.parse(v):{}}catch(e){return{}}}
function lsSetObj(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}

function apiCall(tab,action,params){
  params=params||{};
  return new Promise(function(ok,fail){
    var cb='cb_'+Date.now()+'_'+Math.random().toString(36).slice(2);
    var url=new URL(SHEETS);
    url.searchParams.set('tab',tab);
    url.searchParams.set('action',action);
    url.searchParams.set('callback',cb);
    Object.keys(params).forEach(function(k){
      var v=params[k];
      url.searchParams.set(k,typeof v==='object'?JSON.stringify(v):String(v));
    });
    var el=document.createElement('script');
    var t=setTimeout(function(){cleanup();fail('timeout');},15000);
    function cleanup(){clearTimeout(t);delete window[cb];if(el.parentNode)el.parentNode.removeChild(el);}
    window[cb]=function(d){cleanup();ok(d);};
    el.onerror=function(){cleanup();fail('error');};
    el.src=url.toString();
    document.head.appendChild(el);
  });
}

function uploadImg(file){
  var fd=new FormData();
  fd.append('file',file);
  fd.append('upload_preset',CPRES);
  return fetch('https://api.cloudinary.com/v1_1/'+CNAME+'/image/upload',{method:'POST',body:fd})
    .then(function(r){return r.json();})
    .then(function(d){if(d.secure_url)return d.secure_url;throw new Error('fail');});
}

function loadPP(){
  return new Promise(function(ok,fail){
    if(window.paypal){ok();return;}
    var s=document.createElement('script');
    s.src='https://www.paypal.com/sdk/js?client-id='+PPID+'&currency=SGD&components=buttons';
    s.onload=ok;s.onerror=fail;
    document.body.appendChild(s);
  });
}

function today(){return new Date().toISOString().split('T')[0];}
function todayLabel(){return new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});}
function nowTime(){return new Date().toTimeString().slice(0,5);}
function nowTs(){return new Date().toLocaleString();}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtDate(d){if(!d)return'';try{return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}catch(e){return d;}}

var S={
  mode:'client',
  clientName:lsStr('clientName'),
  meals:lsGet('meals'),
  posts:lsGet('posts'),
  meetings:lsGet('meetings'),
  journals:lsGet('journals'),
  inquiries:lsGet('inquiries'),
  contracts:lsObj('contracts'),
  welcomeMsgs:lsObj('welcomeMsgs'),
  wmTarget:'all',
  tab:'meals',
  selClient:'all',
  filterType:'all',
  modal:'',
  formMeal:{date:today(),time:nowTime(),mt:'Breakfast',full:'',sat:''},
  formJrn:{date:today(),mood:'',energy:''},
  formEm:{date:today(),time:nowTime(),type:'Binge Eating'},
  formInq:{cat:'Diet'},
  formContract:{cn:'',start:'',end:'',plan:''},
  expMeals:{},expJournals:{},expDates:{},expInq:{},
  selMeal:'',selJrn:'',
  ansId:'',ansText:'',
  saving:false,syncMsg:'',
  tmpName:'',tmpPw:'',
  ppSel:null,ppPaid:null,
  postImg:'',postPrev:'',postUp:false,
  readPosts:lsObj('readPosts'),
  readAnswers:lsObj('readAnswers'),
  goals:lsObj('goals'),
  templates:lsGet('templates'),
  goalTarget:'',
  goalForm:{meals:0,journals:0,noSpecial:false}
};

var _rt=null;
function render(){
  clearTimeout(_rt);
  _rt=setTimeout(function(){
    try{
      document.getElementById('app').innerHTML=buildApp();
      attachEvents();
    }catch(e){console.error(e);}
  },16);
}

function setState(patch){
  Object.keys(patch).forEach(function(k){S[k]=patch[k];});
  render();
}

function sync(){
  setState({syncMsg:'Syncing...'});
  Promise.all([
    apiCall('meals','getAll'),
    apiCall('posts','getAll'),
    apiCall('meetings','getAll'),
    apiCall('journals','getAll'),
    apiCall('inquiries','getAll'),
    apiCall('contracts','getAll')
  ]).then(function(res){
    var patch={syncMsg:'Synced'};
    if(res[0]&&res[0].data){
      patch.meals=res[0].data.map(function(r){
        var fb=r.feedback;
        if(typeof fb==='string'){try{fb=JSON.parse(fb);}catch(e){fb=[];}}
        if(!Array.isArray(fb))fb=[];
        return Object.assign({},r,{feedback:fb,isEmergency:r.isEmergency==='TRUE'||r.isEmergency===true});
      }).reverse();
      lsSet('meals',patch.meals);
    }
    if(res[1]&&res[1].data){patch.posts=res[1].data.reverse();lsSet('posts',patch.posts);}
    if(res[2]&&res[2].data){
      patch.meetings=res[2].data.sort(function(a,b){return new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time);});
      lsSet('meetings',patch.meetings);
    }
    if(res[3]&&res[3].data){
      patch.journals=res[3].data.map(function(r){
        var jfb=r.jfeedback;
        if(typeof jfb==='string'){try{jfb=JSON.parse(jfb);}catch(e){jfb=[];}}
        if(!Array.isArray(jfb))jfb=[];
        return Object.assign({},r,{jfeedback:jfb});
      }).reverse();
      lsSet('journals',patch.journals);
    }
    if(res[4]&&res[4].data){
      patch.inquiries=res[4].data.map(function(r){
        return Object.assign({},r,{resolved:r.resolved==='TRUE'||r.resolved===true});
      }).reverse();
      lsSet('inquiries',patch.inquiries);
    }
    if(res[5]&&res[5].data){
      var m={};
      res[5].data.forEach(function(r){if(r.clientName)m[r.clientName]={plan:r.plan,start:r.start,end:r.end};});
      patch.contracts=m;lsSetObj('contracts',m);
    }
    setState(patch);
    setTimeout(function(){setState({syncMsg:''});},3000);
  }).catch(function(){
    setState({syncMsg:'Sync failed'});
    setTimeout(function(){setState({syncMsg:''});},3000);
  });
}

function buildModal(){
  if(!S.modal)return '';
  var h='<div class="ov" onclick="closeModal()"><div class="sh" onclick="event.stopPropagation()"><div class="hdl"></div>';

  if(S.modal==='coach'){
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078;margin-bottom:8px">Coach Access</h2>';
    h+='<p style="color:#5A9A8E;margin-bottom:24px">Enter your password</p>';
    h+='<input id="m-cpw" type="password" class="inp" placeholder="Password" style="margin-bottom:16px"/>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<button class="bp" style="padding:14px" onclick="verifyCoach()">Enter</button>';
    h+='<button class="bo" style="padding:14px" onclick="closeModal()">Cancel</button></div>';

  }else if(S.modal==='changePw'){
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078;margin-bottom:8px">Verify Identity</h2>';
    h+='<p style="color:#5A9A8E;margin-bottom:24px">Enter password to change name</p>';
    h+='<input id="m-cpw2" type="password" class="inp" placeholder="Your Password" style="margin-bottom:16px"/>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<button class="bp" style="padding:14px" onclick="verifyChange()">Verify</button>';
    h+='<button class="bo" style="padding:14px" onclick="closeModal()">Cancel</button></div>';

  }else if(S.modal==='meal'){
    var fm=S.formMeal;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Log a Meal</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:16px">';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Date</label>';
    h+='<input type="date" id="f-date" value="'+esc(fm.date)+'" class="inp"/></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Time</label>';
    h+='<input type="time" id="f-time" value="'+esc(fm.time)+'" class="inp"/></div></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Meal Type</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
    ['Breakfast','Lunch','Dinner','Snack'].forEach(function(t){
      var sel=fm.mt===t;
      h+='<button onclick="setMT(\''+t+'\')" style="padding:10px 4px;font-size:13px;font-weight:600;border-radius:10px;background:'+(sel?'#3BAA8C':'#D4F2EB')+';color:'+(sel?'#fff':'#2D9078')+'">'+t+'</button>';
    });
    h+='</div></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">What did you eat?</label>';
    h+='<textarea id="f-foods" class="inp" rows="3" placeholder="Describe your meal..." style="resize:none"></textarea></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">How full did you feel?</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px">';
    [{v:'1',l:'Still hungry',e:'üò∂'},{v:'2',l:'A little full',e:'üôÇ'},{v:'3',l:'Just right',e:'üòä'},{v:'4',l:'Pretty full',e:'üòå'},{v:'5',l:'Very full',e:'ü§¢'}].forEach(function(o){
      var sel=fm.full===o.v;
      h+='<button onclick="setFull(\''+o.v+'\')" style="padding:10px 4px;background:'+(sel?'#3BAA8C':'#D4F2EB')+';color:'+(sel?'white':'#2D9078')+';border-radius:12px;font-size:11px;font-weight:600;text-align:center">';
      h+='<div style="font-size:20px;margin-bottom:4px">'+o.e+'</div>'+o.l+'</button>';
    });
    h+='</div></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">How long did you stay full?</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
    ['1-2h','2-3h','3-4h','4h+'].forEach(function(o){
      h+='<button onclick="setSat(\''+o+'\')" style="padding:12px 6px;background:'+(fm.sat===o?'#52C9A8':'#D4F2EB')+';color:'+(fm.sat===o?'white':'#2D9078')+';border-radius:12px;font-size:12px;font-weight:600">'+o+'</button>';
    });
    h+='</div></div>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="submitMeal()"'+(S.saving?' disabled':'')+'>Save Meal</button></div>';

  }else if(S.modal==='journal'){
    var fj=S.formJrn;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Daily Journal</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:18px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Date</label>';
    h+='<input type="date" id="j-date" value="'+esc(fj.date)+'" class="inp"/></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:10px">How did eating feel today?</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">';
    ['üò¢','üòï','üòê','üôÇ','üòä'].forEach(function(e2){
      h+='<button onclick="setMood(\''+e2+'\')" style="padding:12px 4px;font-size:26px;background:'+(fj.mood===e2?'#D4F2EB':'#F4FBFA')+';border-radius:12px">'+e2+'</button>';
    });
    h+='</div></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:10px">Energy Level</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">';
    ['1','2','3','4','5'].forEach(function(l){
      h+='<button onclick="setEnergy(\''+l+'\')" style="padding:12px 4px;font-size:16px;font-weight:700;background:'+(fj.energy===l?'#52C9A8':'#D4F2EB')+';color:'+(fj.energy===l?'white':'#2D9078')+';border-radius:10px">'+l+'</button>';
    });
    h+='</div><p style="font-size:12px;color:#5A9A8E;margin-top:6px;text-align:center">1 = Very Low &middot; 5 = Very High</p></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">How are you feeling?</label>';
    h+='<textarea id="j-feel" class="inp" rows="4" placeholder="Share your thoughts..." style="resize:none"></textarea></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Additional Notes</label>';
    h+='<textarea id="j-notes" class="inp" rows="3" placeholder="Anything else..." style="resize:none"></textarea></div>';
    h+='<button class="bs" style="width:100%;padding:15px;font-size:16px" onclick="submitJournal()"'+(S.saving?' disabled':'')+'>Save Journal</button></div>';

  }else if(S.modal==='em'){
    var fe=S.formEm;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Special Note</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:16px">';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Date</label>';
    h+='<input type="date" id="e-date" value="'+esc(fe.date)+'" class="inp"/></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Time</label>';
    h+='<input type="time" id="e-time" value="'+esc(fe.time)+'" class="inp"/></div></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:10px">What happened?</label>';
    [{v:'Binge Eating',e:'üçî'},{v:'Purging',e:'ü§¢'},{v:'Meal Avoidance',e:'üò∞'}].forEach(function(t){
      h+='<button onclick="setEmType(\''+t.v+'\')" style="width:100%;padding:14px 16px;margin-bottom:8px;background:'+(fe.type===t.v?'#D4F2EB':'#F4FBFA')+';border:2px solid '+(fe.type===t.v?'#3BAA8C':'transparent')+';border-radius:14px;font-weight:600;font-size:15px;text-align:left;display:flex;align-items:center;gap:10px;color:'+(fe.type===t.v?'#2D9078':'#5A9A8E')+'"><span style="font-size:22px">'+t.e+'</span>'+t.v+'</button>';
    });
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Notes (Optional)</label>';
    h+='<textarea id="e-notes" class="inp" rows="3" placeholder="How are you feeling?" style="resize:none"></textarea></div>';
    h+='<div style="background:#D4F2EB;border-radius:14px;padding:14px"><p style="color:#2D9078;font-size:14px;line-height:1.6;text-align:center">It\'s okay. Every step of awareness is part of healing.</p></div>';
    h+='<button class="bs" style="width:100%;padding:15px;font-size:16px" onclick="submitEm()"'+(S.saving?' disabled':'')+'>Submit Report</button></div>';

  }else if(S.modal==='inq'){
    var fi=S.formInq;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">New Question</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:16px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Category</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
    ['Diet','Exercise','Other'].forEach(function(c){
      h+='<button onclick="setInqCat(\''+c+'\')" style="padding:12px;font-size:14px;font-weight:600;border-radius:12px;background:'+(fi.cat===c?'#3BAA8C':'#D4F2EB')+';color:'+(fi.cat===c?'white':'#2D9078')+'">'+c+'</button>';
    });
    h+='</div></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Your Question</label>';
    h+='<textarea id="inq-q" class="inp" rows="5" placeholder="Ask your coach anything..." style="resize:none"></textarea></div>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="submitInq()"'+(S.saving?' disabled':'')+'>Send Question</button></div>';

  }else if(S.modal==='post'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">New Post</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:14px">';
    h+='<input id="p-title" class="inp" placeholder="Title" style="font-weight:600"/>';
    h+='<textarea id="p-content" class="inp" rows="6" placeholder="Write your announcement..." style="resize:none"></textarea>';
    h+='<label style="display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;background:#E8F8F4;border:1.5px dashed #3BAA8C;border-radius:12px;cursor:pointer;color:#2D9078;font-weight:600;font-size:14px">';
    h+=(S.postUp?'Uploading...':(S.postImg?'Photo uploaded':'Add Photo'));
    h+='<input type="file" accept="image/*" onchange="handlePostImg(event)" style="display:none"/></label>';
    if(S.postPrev)h+='<img src="'+esc(S.postPrev)+'" style="width:100%;border-radius:12px;max-height:200px;object-fit:cover"/>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="submitPost()"'+(S.saving||S.postUp?' disabled':'')+'>Publish</button></div>';

  }else if(S.modal==='mtg'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Schedule Meeting</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:14px">';
    if(S.mode==='coach')h+='<input id="m-cn" class="inp" placeholder="Client Name" style="font-weight:600"/>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<input type="date" id="m-date" value="'+today()+'" class="inp"/>';
    h+='<input type="time" id="m-time" class="inp"/></div>';
    h+='<input id="m-title" class="inp" placeholder="Meeting Title" style="font-weight:600"/>';
    h+='<textarea id="m-notes" class="inp" rows="3" placeholder="Notes (optional)" style="resize:none"></textarea>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="submitMtg()"'+(S.saving?' disabled':'')+'>Schedule</button></div>';

  }else if(S.modal==='contract'){
    var fc=S.formContract;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Set Contract Period</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:14px">';
    h+='<input id="ct-cn" class="inp" placeholder="Client Name" value="'+esc(fc.cn)+'"/>';
    h+='<input id="ct-plan" class="inp" placeholder="e.g. Monthly Plan..." value="'+esc(fc.plan)+'"/>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Start</label>';
    h+='<input type="date" id="ct-start" value="'+esc(fc.start)+'" class="inp"/></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">End</label>';
    h+='<input type="date" id="ct-end" value="'+esc(fc.end)+'" class="inp"/></div></div>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="submitContract()">Save Contract</button></div>';

    }else if(S.modal==='setGoal'){
    var gcList=[];
    S.meals.forEach(function(m){if(m.clientName&&gcList.indexOf(m.clientName)===-1)gcList.push(m.clientName);});
    S.journals.forEach(function(j){if(j.clientName&&gcList.indexOf(j.clientName)===-1)gcList.push(j.clientName);});
    var gt=S.goalTarget||'';
    var gf=S.goalForm&&S.goalTarget===gt&&(S.goalForm.meals||S.goalForm.journals||S.goalForm.noSpecial)?S.goalForm:(S.goals[gt]||{meals:0,journals:0,noSpecial:false});
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Set Goals</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:16px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Client</label>';
    h+='<select id="goal-cn" onchange="updateGoalTarget(this.value)" style="width:100%;padding:12px 14px;border:1.5px solid #B8E8DF;border-radius:12px;font-size:15px;background:#FAFEFE;color:#2D7060;outline:none">';
    h+='<option value="">-- Select --</option>';
    gcList.forEach(function(c){h+='<option value="'+esc(c)+'"'+(gt===c?' selected':'')+'>'+esc(c)+'</option>';});
    h+='</select></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Weekly Meals Goal</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">';
    [7,10,14,15,21].forEach(function(n){
      var sel=(gf.meals||0)===n;
      h+='<button onclick="setGF(\'meals\','+n+')" style="padding:12px 4px;font-size:15px;font-weight:700;background:'+(sel?'#3BAA8C':'#D4F2EB')+';color:'+(sel?'white':'#2D9078')+';border-radius:12px">'+n+'</button>';
    });
    h+='</div><p style="font-size:12px;color:#5A9A8E;margin-top:4px">meals per week</p></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Weekly Journal Goal</label>';
    h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
    [3,5,6,7].forEach(function(n){
      var sel=(gf.journals||0)===n;
      h+='<button onclick="setGF(\'journals\','+n+')" style="padding:12px 4px;font-size:15px;font-weight:700;background:'+(sel?'#3BAA8C':'#D4F2EB')+';color:'+(sel?'white':'#2D9078')+';border-radius:12px">'+n+'</button>';
    });
    h+='</div><p style="font-size:12px;color:#5A9A8E;margin-top:4px">journals per week</p></div>';
    h+='<div style="display:flex;align-items:center;gap:12px;background:#F4FBFA;border-radius:12px;padding:14px">';
    h+='<input type="checkbox" id="goal-ns"'+(gf.noSpecial?' checked':'')+' onchange="setGF(\'noSpecial\',this.checked)" style="width:20px;height:20px;accent-color:#3BAA8C"/>';
    h+='<label for="goal-ns" style="font-size:14px;font-weight:600;color:#2D9078;cursor:pointer">No Special Notes this week</label></div>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="saveGoal()">Save Goals</button></div>';

  }else if(S.modal==='addTemplate'){
    var tpList=[];
    S.meals.forEach(function(m){if(m.clientName&&tpList.indexOf(m.clientName)===-1)tpList.push(m.clientName);});
    S.journals.forEach(function(j){if(j.clientName&&tpList.indexOf(j.clientName)===-1)tpList.push(j.clientName);});
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">New Template</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:14px">';
    h+='<input id="tpl-title" class="inp" placeholder="e.g. 1200kcal Balanced Plan" style="font-weight:600"/>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Share with</label>';
    h+='<select id="tpl-target" style="width:100%;padding:12px 14px;border:1.5px solid #B8E8DF;border-radius:12px;font-size:15px;background:#FAFEFE;color:#2D7060;outline:none">';
    h+='<option value="all">All Clients</option>';
    tpList.forEach(function(c){h+='<option value="'+esc(c)+'">'+esc(c)+'</option>';});
    h+='</select></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Template Content</label>';
    h+='<textarea id="tpl-content" class="inp" rows="12" style="resize:none;font-family:monospace;font-size:13px;line-height:1.7" placeholder="Breakfast:&#10;- Oatmeal with berries&#10;- 1 boiled egg&#10;&#10;Lunch:&#10;- Brown rice + grilled chicken&#10;- Side salad&#10;&#10;Dinner:&#10;- Clear soup + steamed veggies&#10;&#10;Snacks:&#10;- Apple / handful of nuts"></textarea></div>';
    h+='<button class="bp" style="width:100%;padding:15px;font-size:16px" onclick="saveTemplate()">Publish</button></div>';

  }else if(S.modal==='welcomeMsg'){
    var wmClients=[];
    S.meals.forEach(function(m){if(m.clientName&&wmClients.indexOf(m.clientName)===-1)wmClients.push(m.clientName);});
    S.journals.forEach(function(j){if(j.clientName&&wmClients.indexOf(j.clientName)===-1)wmClients.push(j.clientName);});
    var wmt=S.wmTarget||'all';
    var wmCurrent=wmt==='all'?(S.welcomeMsgs['__all__']||''):(S.welcomeMsgs[wmt]||'');
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:26px;color:#2D9078">Welcome Message</h2>';
    h+='<button onclick="closeModal()" style="color:#52C9A8;font-size:22px">&#x2715;</button></div>';
    h+='<div style="display:flex;flex-direction:column;gap:14px">';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:8px">Send to</label>';
    h+='<select id="wm-target" onchange="setState({wmTarget:this.value})" style="width:100%;padding:12px 14px;border:1.5px solid #B8E8DF;border-radius:12px;font-size:15px;background:#FAFEFE;color:#2D7060;outline:none">';
    h+='<option value="all"'+(wmt==='all'?' selected':'')+'>üì¢ All Clients</option>';
    wmClients.forEach(function(c){h+='<option value="'+esc(c)+'"'+(wmt===c?' selected':'')+'>üë§ '+esc(c)+'</option>';});
    h+='</select></div>';
    h+='<div><label style="font-size:13px;font-weight:600;color:#2D9078;display:block;margin-bottom:6px">Message'+(wmt==='all'?' (sent to all clients)':' (sent to '+esc(wmt)+' only)')+'</label>';
    h+='<textarea id="wm-txt" class="inp" rows="5" placeholder="e.g. Great work today! üåø" style="resize:none">'+esc(wmCurrent)+'</textarea></div>';
    if(wmt==='all'&&wmClients.length>0){
      h+='<div style="background:#E8F8F4;border-radius:12px;padding:12px 14px">';
      h+='<p style="font-size:13px;color:#2D9078">This will show to all '+wmClients.length+' client(s). Individual messages (if any) will still show to each person.</p></div>';
    }
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
    h+='<button class="bp" style="padding:14px" onclick="saveWelcomeMsg()">Save</button>';
    h+='<button class="bo" style="padding:14px" onclick="clearWelcomeMsg()">Clear</button></div></div>';
  }

  h+='</div></div>';
  return h;
}

function buildApp(){
  var mode=S.mode, cn=S.clientName, tab=S.tab, sc=S.selClient, ft=S.filterType;
  var meals=S.meals, posts=S.posts, meetings=S.meetings, journals=S.journals, inquiries=S.inquiries;
  var td=today(), tl=todayLabel();

  var clients=[];
  meals.forEach(function(m){if(m.clientName&&clients.indexOf(m.clientName)===-1)clients.push(m.clientName);});
  journals.forEach(function(j){if(j.clientName&&clients.indexOf(j.clientName)===-1)clients.push(j.clientName);});

  var fMeals=meals.filter(function(m){
    if(mode==='coach')return sc==='all'||m.clientName===sc;
    return m.clientName===cn;
  }).filter(function(m){return ft==='all'||m.mealType===ft;});

  var todayMeals=fMeals.filter(function(m){return m.date===td;});
  var byDate={};
  fMeals.forEach(function(m){if(!byDate[m.date])byDate[m.date]=[];byDate[m.date].push(m);});
  var sortedDates=Object.keys(byDate).sort(function(a,b){return new Date(b)-new Date(a);});

  var relM=mode==='coach'?(sc==='all'?meals:meals.filter(function(m){return m.clientName===sc;})):meals.filter(function(m){return m.clientName===cn;});
  var relJ=mode==='coach'?(sc==='all'?journals:journals.filter(function(j){return j.clientName===sc;})):journals.filter(function(j){return j.clientName===cn;});
  var relMtg=meetings.filter(function(m){return mode==='coach'?(sc==='all'||m.clientName===sc):m.clientName===cn;});
  var fInq=mode==='coach'?(sc==='all'?inquiries:inquiries.filter(function(i){return i.clientName===sc;})):inquiries.filter(function(i){return i.clientName===cn;});

  var now=new Date();
  var wk=new Date();wk.setDate(wk.getDate()-7);
  var upMtg=relMtg.filter(function(m){return new Date(m.date+' '+m.time)>=now;});
  var pastMtg=relMtg.filter(function(m){return new Date(m.date+' '+m.time)<now;}).sort(function(a,b){return new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time);});

  var stats={
    wm:relM.filter(function(m){return new Date(m.date)>=wk&&!m.isEmergency;}).length,
    sn:relM.filter(function(m){return m.isEmergency;}).length,
    je:relJ.length,
    wf:relM.filter(function(m){return(m.feedback||[]).length>0;}).length,
    tc:clients.length
  };

  var qaBadge=mode==='coach'
    ?fInq.filter(function(i){return!i.resolved&&!i.answer;}).length
    :fInq.filter(function(i){return i.answer&&!S.readAnswers[String(i.id)];}).length;
  var noticeBadge=mode==='client'?posts.filter(function(p){return!S.readPosts[String(p.id)];}).length:0;

  var TABS=[
    {id:'meals',ic:'üçΩÔ∏è',l:'Meals'},
    {id:'journal',ic:'üìî',l:'Journal'},
    {id:'stats',ic:'üìä',l:mode==='coach'?'Dashboard':'Stats'},
    {id:'goals',ic:'üéØ',l:'Goals'},
    {id:'template',ic:'ü•ó',l:mode==='coach'?'Templates':'Diet Plan'},
    {id:'inquiries',ic:'üí¨',l:'Q&A',badge:qaBadge},
    {id:'posts',ic:'üì¢',l:mode==='client'?'Notice':'Posts',badge:noticeBadge},
    {id:'meetings',ic:'üìÖ',l:'Meetings'},
    {id:'payment',ic:'üí≥',l:'Payment'}
  ];

  var h='<div style="background:#F4FBFA;min-height:100vh">';
  if(S.saving)h+='<div style="position:fixed;top:0;left:0;right:0;z-index:100;background:#3BAA8C;color:white;text-align:center;padding:8px;font-size:13px;font-weight:600">Saving...</div>';
  h+=buildModal();

  // Header
  h+='<div class="hdr" style="padding:20px 20px 0"><div style="max-width:640px;margin:0 auto">';
  h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">';
  h+='<div><h1 style="font-family:\'DM Serif Display\',serif;font-size:32px;color:#fff;letter-spacing:-0.5px">Mindfit</h1>';
  h+='<p style="color:rgba(255,255,255,0.85);font-size:13px;margin-top:2px">Your Journey with Mindfit</p></div>';
  h+='<div style="display:flex;gap:8px;align-items:center">';
  if(S.syncMsg)h+='<span style="font-size:12px;color:rgba(255,255,255,0.9);font-weight:600">'+esc(S.syncMsg)+'</span>';
  h+='<button onclick="sync()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:10px;padding:6px 10px;color:#fff;font-size:12px;font-weight:600">Sync</button>';
  h+='<button onclick="'+(mode==='coach'?'setState({mode:\'client\'})':'openModal(\'coach\')')+'" style="background:rgba(255,255,255,0.25);border:1px solid rgba(255,255,255,0.4);border-radius:10px;padding:8px 12px;font-size:18px">'+(mode==='coach'?'üë§':'üë•')+'</button>';
  h+='</div></div>';

  if(mode==='coach'&&clients.length>0){
    h+='<div style="margin-bottom:16px"><select onchange="setState({selClient:this.value})" style="width:100%;padding:10px 14px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:12px;color:#fff;font-size:14px;outline:none">';
    h+='<option value="all" style="color:#333">All Clients ('+clients.length+')</option>';
    clients.forEach(function(c){h+='<option value="'+esc(c)+'" style="color:#333"'+(sc===c?' selected':'')+'>'+esc(c)+'</option>';});
    h+='</select></div>';
  }

  if(mode==='client'&&!cn){
    h+='<div style="background:rgba(255,255,255,0.15);border-radius:18px;padding:20px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.2)">';
    h+='<p style="color:#fff;font-weight:600;margin-bottom:14px;font-family:\'DM Serif Display\',serif;font-size:18px">Welcome! Let\'s get started.</p>';
    h+='<div style="display:flex;flex-direction:column;gap:10px">';
    h+='<input id="reg-name" placeholder="Your Name" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.92);border:none;border-radius:12px;font-size:16px;outline:none;color:#2D7060"/>';
    h+='<input id="reg-pw" type="password" placeholder="Set a Password" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.92);border:none;border-radius:12px;font-size:16px;outline:none;color:#2D7060"/>';
    h+='<button onclick="signup()" style="width:100%;padding:13px;background:rgba(255,255,255,0.95);color:#3BAA8C;border:none;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer">Start My Journey</button>';
    h+='</div></div>';
  }

  if(mode==='client'&&cn){
    h+='<div style="display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.2);border-radius:12px;padding:10px 14px;margin-bottom:16px">';
    h+='<div style="display:flex;align-items:center;gap:8px">';
    h+='<div style="width:32px;height:32px;background:rgba(255,255,255,0.3);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px">'+esc(cn.charAt(0).toUpperCase())+'</div>';
    h+='<span style="color:#fff;font-weight:600;font-size:15px">'+esc(cn)+'</span></div>';
    h+='<button onclick="openModal(\'changePw\')" style="color:#fff;font-size:13px;font-weight:600">Change</button></div>';
  }

  h+='<div style="display:flex;overflow-x:auto">';
  TABS.forEach(function(t){
    var badge='';
    if(t.badge>0)badge='<span class="bdg">'+t.badge+'</span>';
    h+='<button onclick="switchTab(\''+t.id+'\')" style="position:relative;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 14px 14px;background:none;border:none;border-bottom:'+(tab===t.id?'2.5px solid #fff':'2.5px solid transparent')+';color:'+(tab===t.id?'#fff':'rgba(255,255,255,0.55)')+';cursor:pointer;white-space:nowrap;min-width:56px">';
    h+='<span style="font-size:18px">'+t.ic+'</span><span style="font-size:11px;font-weight:600">'+t.l+'</span>'+badge+'</button>';
  });
  h+='</div></div></div>';

  // Content
  h+='<div style="max-width:640px;margin:0 auto;padding:20px 16px 100px">';

  // ‚îÄ‚îÄ MEALS TAB ‚îÄ‚îÄ
  if(tab==='meals'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
    h+='<div><h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58">Today\'s Meals</h2>';
    h+='<p style="color:#5A9A8E;font-size:13px;margin-top:2px">'+tl+'</p></div>';
    h+='<select onchange="setState({filterType:this.value})" style="padding:8px 12px;border:1.5px solid #C8EDE6;border-radius:10px;font-size:13px;background:#fff;color:#2D9078;outline:none">';
    h+='<option value="all"'+(ft==='all'?' selected':'')+'>All</option>';
    ['Breakfast','Lunch','Dinner','Snack'].forEach(function(x){h+='<option'+(ft===x?' selected':'')+'>'+x+'</option>';});
    h+='</select></div>';

    var personalMsg=S.welcomeMsgs[cn]||'';
    var allMsg=S.welcomeMsgs['__all__']||'';
    if(mode==='client'&&cn&&(personalMsg||allMsg)){
      if(personalMsg){
        h+='<div style="background:linear-gradient(135deg,#E8F8F4,#D4F2EB);border-radius:18px;padding:18px 20px;margin-bottom:16px;border-left:4px solid #3BAA8C">';
        h+='<p style="font-size:13px;font-weight:700;color:#3BAA8C;margin-bottom:4px">üíå Message for you</p>';
        h+='<p style="color:#2D7060;font-size:15px;line-height:1.6">'+esc(personalMsg)+'</p></div>';
      }
      if(allMsg){
        h+='<div style="background:linear-gradient(135deg,#F0FBF7,#E8F8F4);border-radius:18px;padding:18px 20px;margin-bottom:16px;border-left:4px solid #52C9A8">';
        h+='<p style="font-size:13px;font-weight:700;color:#52C9A8;margin-bottom:4px">üì¢ From your coach</p>';
        h+='<p style="color:#2D7060;font-size:15px;line-height:1.6">'+esc(allMsg)+'</p></div>';
      }
    }
    if(mode==='coach'){
      var hasAnyMsg=Object.keys(S.welcomeMsgs).length>0;
      h+='<button onclick="openModal(\'welcomeMsg\')" style="width:100%;padding:14px;background:#E8F8F4;border:1.5px dashed #3BAA8C;border-radius:14px;font-weight:600;font-size:14px;color:#2D9078;margin-bottom:16px;cursor:pointer">'+(hasAnyMsg?'‚úèÔ∏è Edit Welcome Messages':'üíå Set Welcome Message')+'</button>';
    }
    if(mode==='client'&&cn){
      h+='<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px">';
      h+='<button onclick="openModal(\'meal\')" style="width:100%;padding:18px;background:#3BAA8C;color:#fff;border:none;border-radius:16px;font-weight:600;font-size:16px;cursor:pointer">+ Log a Meal</button>';
      h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
      h+='<button onclick="openModal(\'journal\')" style="padding:16px;background:#fff;border:1.5px solid #C8EDE6;border-radius:16px;font-weight:600;font-size:14px;cursor:pointer;color:#2D9078">Daily Journal</button>';
      h+='<button onclick="openModal(\'em\')" style="padding:16px;background:#E8F8F4;border:1.5px solid #B8D4B9;border-radius:16px;font-weight:600;font-size:14px;cursor:pointer;color:#3BAA8C">Special Note</button>';
      h+='</div></div>';
    }
    if(todayMeals.length===0){
      h+='<div class="card" style="padding:40px;text-align:center">';
      h+='<p style="color:#5A9A8E;font-weight:600;font-size:16px">No meals logged today</p>';
      h+='<p style="color:#A8DDD5;font-size:14px;margin-top:6px">Past records in the Stats tab</p></div>';
    }else{
      todayMeals.forEach(function(meal){h+=buildMealCard(meal,mode);});
    }
  }

  // ‚îÄ‚îÄ JOURNAL TAB ‚îÄ‚îÄ
  if(tab==='journal'){
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58;margin-bottom:20px">Journal</h2>';
    if(relJ.length===0){
      h+='<div class="card" style="padding:40px;text-align:center"><p style="color:#5A9A8E;font-weight:600;font-size:16px">No journal entries yet</p></div>';
    }else{
      relJ.forEach(function(j){
        var exp=S.expJournals[j.id];
        var jfbs=j.jfeedback||[];
        h+='<div class="cw" style="margin-bottom:10px;overflow:hidden">';
        h+='<button onclick="toggleJ(\''+j.id+'\')" style="width:100%;padding:14px 18px;display:flex;align-items:center;gap:12px;text-align:left;background:none;border:none;cursor:pointer">';
        h+='<span style="font-size:28px">'+(j.mood||'üìî')+'</span>';
        h+='<div style="flex:1"><p style="font-weight:600;color:#2D9078;font-size:15px">'+esc(j.date)+'</p>';
        h+='<p style="color:#5A9A8E;font-size:13px">'+esc(j.clientName)+'</p></div>';
        if(j.energy)h+='<span style="font-size:13px;color:#3BAA8C;font-weight:700">'+esc(j.energy)+'/5</span>';
        if(jfbs.length>0)h+='<span style="color:#5A9A8E;font-size:12px;margin-left:6px">'+jfbs.length+' comments</span>';
        h+='<span style="color:#52C9A8;margin-left:8px">'+(exp?'&#9650;':'&#9660;')+'</span></button>';
        if(exp){
          h+='<div style="padding:0 18px 18px;border-top:1px solid #D4F2EB">';
          h+='<div style="background:#E8F8F4;border-radius:12px;padding:12px 14px;margin-top:14px;margin-bottom:10px">';
          h+='<p style="font-size:11px;font-weight:700;color:#5A9A8E;margin-bottom:4px;text-transform:uppercase">Feelings</p>';
          h+='<p style="color:#2D7060;line-height:1.6;font-size:14px">'+esc(j.feelings)+'</p></div>';
          if(j.notes)h+='<p style="color:#5A9A8E;font-size:14px;line-height:1.5;margin-bottom:10px">'+esc(j.notes)+'</p>';
          jfbs.forEach(function(fb){
            h+='<div style="background:#E8F8F4;border-radius:14px;padding:12px 16px;margin-bottom:8px">';
            h+='<div style="display:flex;justify-content:space-between;margin-bottom:4px">';
            h+='<span style="font-size:12px;font-weight:700;color:#3BAA8C">'+esc(fb.author)+'</span>';
            h+='<span style="font-size:11px;color:#5A9A8E">'+esc(fb.timestamp)+'</span></div>';
            h+='<p style="color:#2D7060;font-size:14px">'+esc(fb.text)+'</p></div>';
          });
          if(mode==='coach'){
            if(S.selJrn==j.id){
              h+='<div style="display:flex;gap:8px;padding-top:10px;border-top:1px solid #D4F2EB">';
              h+='<input id="jfb-inp" class="inp" placeholder="Write a comment..." style="flex:1"/>';
              h+='<button onclick="addJournalFeedback(\''+j.id+'\')" class="bs" style="padding:10px 14px">Send</button>';
              h+='<button onclick="setState({selJrn:\'\'})" style="color:#52C9A8;padding:10px;font-size:18px">&#x2715;</button></div>';
            }else{
              h+='<button onclick="setState({selJrn:\''+j.id+'\'})" style="color:#3BAA8C;font-weight:600;font-size:14px;padding-top:10px;border-top:1px solid #D4F2EB;width:100%;text-align:left;background:none;border:none;cursor:pointer">+ Add Comment</button>';
            }
          }
          h+='</div>';
        }
        h+='</div>';
      });
    }
  }

  // ‚îÄ‚îÄ STATS / DASHBOARD TAB ‚îÄ‚îÄ
  if(tab==='stats'){
    if(mode==='coach'){
      h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58;margin-bottom:6px">Dashboard</h2>';
      h+='<p style="color:#5A9A8E;font-size:13px;margin-bottom:20px">'+(sc==='all'?'All clients overview':'Overview for '+esc(sc))+'</p>';
      h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">';
      h+='<div class="st" style="grid-column:span 2;background:linear-gradient(135deg,#3BAA8C,#52C9A8);color:white">';
      h+='<p style="font-size:40px;font-weight:700;font-family:\'DM Serif Display\',serif">'+stats.tc+'</p>';
      h+='<p style="opacity:.85;font-size:13px;margin-top:4px;font-weight:600">Total Clients</p></div>';
      [{v:stats.wm,l:'Meals This Week',i:'üçΩÔ∏è'},{v:stats.sn,l:'Special Notes',i:'üìã'},{v:stats.je,l:'Journal Entries',i:'üìî'},{v:stats.wf,l:'With Feedback',i:'üí¨'}].forEach(function(s){
        h+='<div class="st"><p style="font-size:13px;margin-bottom:8px">'+s.i+'</p>';
        h+='<p style="font-size:32px;font-weight:700;color:#1A6B58;font-family:\'DM Serif Display\',serif">'+s.v+'</p>';
        h+='<p style="color:#4A8A7E;font-size:13px;font-weight:600;margin-top:4px">'+s.l+'</p></div>';
      });
      h+='</div>';
      if(sc==='all'&&clients.length>0){
        h+='<h3 style="font-weight:700;color:#1A6B58;font-size:17px;margin-bottom:14px">Client Overview</h3>';
        clients.forEach(function(c){
          var cm=meals.filter(function(m){return m.clientName===c;});
          var cj=journals.filter(function(j){return j.clientName===c;});
          var ci=inquiries.filter(function(i){return i.clientName===c&&!i.resolved&&!i.answer;});
          var cct=S.contracts[c];
          var wkM=cm.filter(function(m){return new Date(m.date)>=wk&&!m.isEmergency;}).length;
          var lastMeal=cm.length>0?cm[0].date:'No meals yet';
          h+='<div class="card" style="padding:18px;margin-bottom:10px">';
          h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">';
          h+='<div style="width:40px;height:40px;background:linear-gradient(135deg,#3BAA8C,#52C9A8);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:16px">'+esc(c.charAt(0).toUpperCase())+'</div>';
          h+='<div style="flex:1"><p style="font-weight:700;color:#1A6B58;font-size:16px">'+esc(c)+'</p>';
          if(cct&&cct.end){
            var dl=Math.round((new Date(cct.end)-new Date(td))/(1000*60*60*24));
            h+='<p style="font-size:12px;color:'+(dl<7?'#E05C5C':'#5A9A8E')+'">'+(dl>0?dl+' days left':'Expired')+'</p>';
          }
          h+='</div>';
          if(ci.length>0)h+='<span style="background:#E05C5C;color:white;border-radius:20px;padding:3px 10px;font-size:12px;font-weight:700">'+ci.length+' Q</span>';
          h+='</div>';
          h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
          h+='<div style="background:#F4FBFA;border-radius:10px;padding:10px;text-align:center"><p style="font-size:20px;font-weight:700;color:#1A6B58">'+wkM+'</p><p style="font-size:11px;color:#5A9A8E;font-weight:600">Meals/wk</p></div>';
          h+='<div style="background:#F4FBFA;border-radius:10px;padding:10px;text-align:center"><p style="font-size:20px;font-weight:700;color:#1A6B58">'+cj.length+'</p><p style="font-size:11px;color:#5A9A8E;font-weight:600">Journals</p></div>';
          h+='<div style="background:#F4FBFA;border-radius:10px;padding:10px;text-align:center"><p style="font-size:11px;color:#3BAA8C;font-weight:600">Last meal</p><p style="font-size:11px;color:#5A9A8E">'+esc(lastMeal)+'</p></div>';
          h+='</div></div>';
        });
      }
    }else{
      h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58;margin-bottom:20px">Progress</h2>';
      h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">';
      [{v:stats.wm,l:'Meals This Week',i:'üçΩÔ∏è'},{v:stats.sn,l:'Special Notes',i:'üìã'},{v:stats.je,l:'Journal Entries',i:'üìî'},{v:stats.wf,l:'With Feedback',i:'üí¨'}].forEach(function(s){
        h+='<div class="st"><p style="font-size:13px;margin-bottom:8px">'+s.i+'</p>';
        h+='<p style="font-size:32px;font-weight:700;color:#1A6B58;font-family:\'DM Serif Display\',serif">'+s.v+'</p>';
        h+='<p style="color:#4A8A7E;font-size:13px;font-weight:600;margin-top:4px">'+s.l+'</p></div>';
      });
      h+='</div>';
      h+='<h3 style="font-weight:700;color:#1A6B58;font-size:17px;margin-bottom:14px">All Records</h3>';
      if(sortedDates.length===0){
        h+='<div class="card" style="padding:40px;text-align:center"><p style="color:#5A9A8E;font-weight:600">No records yet</p></div>';
      }else{
        sortedDates.forEach(function(date){
          var dm=byDate[date];var exp=S.expDates[date];
          h+='<div class="cw" style="margin-bottom:10px;overflow:hidden">';
          h+='<button onclick="toggleD(\''+date+'\')" style="width:100%;padding:14px 18px;display:flex;align-items:center;gap:10px;text-align:left;background:none;border:none;cursor:pointer">';
          h+='<div style="flex:1;display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
          h+='<span style="font-weight:700;color:#1A6B58;font-size:15px">'+esc(date)+'</span>';
          h+='<span style="color:#4A8A7E;font-size:13px;font-weight:600">'+dm.length+' meals</span>';
          if(date===td)h+='<span class="td" style="font-size:11px">Today</span>';
          h+='</div><span style="color:#52C9A8">'+(exp?'&#9650;':'&#9660;')+'</span></button>';
          if(exp){
            h+='<div style="border-top:1px solid #D4F2EB">';
            dm.forEach(function(meal,i){
              h+='<div style="padding:12px 18px;border-bottom:'+(i<dm.length-1?'1px solid #D4F2EB':'none')+'">';
              if(meal.isEmergency)h+='<span class="ts" style="font-size:11px;margin-bottom:6px;display:inline-block">Special</span>';
              else h+='<span class="td" style="font-size:11px;margin-bottom:6px;display:inline-block">'+esc(meal.mealType)+'</span>';
              h+='<p style="color:#2D7060;font-size:14px;line-height:1.5">'+esc(meal.foods)+'</p>';
              (meal.feedback||[]).forEach(function(fb){h+='<p style="color:#3BAA8C;font-size:13px;margin-top:4px">Coach: '+esc(fb.text)+'</p>';});
              h+='</div>';
            });
            h+='</div>';
          }
          h+='</div>';
        });
      }
    }
  }

  // ‚îÄ‚îÄ Q&A TAB ‚îÄ‚îÄ
  if(tab==='inquiries'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58">Q&amp;A</h2>';
    if(mode==='client'&&cn)h+='<button onclick="openModal(\'inq\')" class="bp" style="padding:10px 18px;font-size:14px">+ Ask</button>';
    h+='</div>';
    if(fInq.length===0){
      h+='<div class="card" style="padding:40px;text-align:center"><p style="color:#5A9A8E;font-weight:600;font-size:16px">No inquiries yet</p></div>';
    }else{
      fInq.forEach(function(inq){
        var exp=S.expInq[inq.id];
        var bc=inq.resolved?'#52C9A8':inq.answer?'#3BAA8C':'#F0B86E';
        var isNew=mode==='client'&&inq.answer&&!S.readAnswers[String(inq.id)];
        h+='<div style="background:'+(inq.resolved?'#F4FBFA':'#fff')+';border:1.5px solid #C8EDE6;border-left:4px solid '+bc+';border-radius:16px;margin-bottom:10px;overflow:hidden">';
        h+='<button onclick="openInq(\''+inq.id+'\')" style="width:100%;padding:14px 18px;display:flex;align-items:center;gap:10px;text-align:left;background:none;border:none;cursor:pointer">';
        h+='<div style="flex:1;min-width:0">';
        h+='<span class="ts" style="font-size:11px;margin-right:6px">'+esc(inq.category)+'</span>';
        h+='<span style="font-weight:'+(isNew?'700':'500')+';color:#2D7060;font-size:14px">'+esc(inq.question)+'</span></div>';
        h+='<div style="display:flex;align-items:center;gap:6px;flex-shrink:0">';
        if(isNew)h+='<span style="font-size:11px;color:#fff;font-weight:700;background:#E05C5C;padding:2px 8px;border-radius:10px">NEW</span>';
        else if(inq.resolved)h+='<span style="color:#3BAA8C;font-size:16px">&#10003;</span>';
        else if(!inq.answer)h+='<span style="font-size:11px;color:#C8963E;background:#FEF3E2;padding:2px 8px;border-radius:10px;font-weight:600">Pending</span>';
        else h+='<span style="font-size:11px;color:#2D9078;background:#D4F2EB;padding:2px 8px;border-radius:10px;font-weight:600">Answered</span>';
        h+='<span style="color:#52C9A8">'+(exp?'&#9650;':'&#9660;')+'</span></div></button>';
        if(exp){
          h+='<div style="padding:0 18px 18px;border-top:1px solid #D4F2EB">';
          h+='<div style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;margin-bottom:14px">';
          h+='<span style="color:#5A9A8E;font-size:12px">'+esc(inq.date)+' &middot; '+esc(inq.clientName)+'</span>';
          if(mode==='coach'){
            h+='<div style="display:flex;gap:8px">';
            h+='<button onclick="toggleRes(\''+inq.id+'\')" style="font-size:12px;padding:4px 12px;background:'+(inq.resolved?'#E8F8F4':'#D4F2EB')+';color:'+(inq.resolved?'#5A9A8E':'#2D9078')+';border-radius:10px;font-weight:600;cursor:pointer">'+(inq.resolved?'Unresolve':'Resolved')+'</button>';
            h+='<button onclick="delInq(\''+inq.id+'\')" style="color:#52C9A8;background:none;border:none;cursor:pointer;font-size:18px">&#x2715;</button></div>';
          }
          h+='</div>';
          h+='<div style="background:#E8F8F4;border-radius:12px;padding:12px 14px;margin-bottom:12px">';
          h+='<p style="font-size:11px;font-weight:700;color:#5A9A8E;margin-bottom:4px">QUESTION</p>';
          h+='<p style="color:#2D7060;line-height:1.6;font-size:14px">'+esc(inq.question)+'</p></div>';
          if(inq.answer){
            h+='<div style="background:#3BAA8C;border-radius:14px;padding:14px 18px;color:white">';
            h+='<p style="font-size:11px;font-weight:700;opacity:.6;margin-bottom:4px">COACH REPLY</p>';
            h+='<p style="font-size:14px;line-height:1.6">'+esc(inq.answer)+'</p></div>';
          }else if(mode==='coach'){
            if(S.ansId==inq.id){
              h+='<div style="display:flex;flex-direction:column;gap:8px">';
              h+='<textarea id="ans-txt" class="inp" rows="4" placeholder="Write your reply..." style="resize:none">'+esc(S.ansText)+'</textarea>';
              h+='<div style="display:flex;gap:8px">';
              h+='<button onclick="submitAnswer(\''+inq.id+'\')" class="bp" style="flex:1;padding:12px"'+(S.saving?' disabled':'')+'>Submit</button>';
              h+='<button onclick="setState({ansId:\'\',ansText:\'\'})" style="padding:12px 14px;background:#E8F8F4;border:none;border-radius:12px;cursor:pointer">&#x2715;</button></div></div>';
            }else{
              h+='<button onclick="setState({ansId:\''+inq.id+'\'})" class="bp" style="width:100%;padding:12px">Reply</button>';
            }
          }else{
            h+='<div style="background:#E8F8F4;border-radius:12px;padding:14px;text-align:center"><p style="color:#5A9A8E;font-size:14px">Your coach will reply soon</p></div>';
          }
          h+='</div>';
        }
        h+='</div>';
      });
    }
  }

  // ‚îÄ‚îÄ POSTS TAB ‚îÄ‚îÄ
  if(tab==='posts'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58">'+(mode==='client'?'Notice':'Posts')+'</h2>';
    if(mode==='coach')h+='<button onclick="openModal(\'post\')" class="bp" style="padding:10px 18px;font-size:14px">+ New Post</button>';
    h+='</div>';
    if(posts.length===0){
      h+='<div class="card" style="padding:40px;text-align:center"><p style="color:#5A9A8E;font-weight:600">No posts yet</p></div>';
    }else{
      posts.forEach(function(post){
        var isNew=mode==='client'&&!S.readPosts[String(post.id)];
        h+='<div class="card" style="padding:22px;margin-bottom:12px'+(isNew?';border-left:4px solid #E05C5C':'')+'">';
        h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">';
        h+='<div><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
        h+='<h3 style="font-family:\'DM Serif Display\',serif;font-size:19px;color:#1A6B58">'+esc(post.title)+'</h3>';
        if(isNew)h+='<span style="font-size:11px;color:#fff;font-weight:700;background:#E05C5C;padding:2px 8px;border-radius:10px">NEW</span>';
        h+='</div><p style="color:#5A9A8E;font-size:12px">'+esc(post.date)+'</p></div>';
        if(mode==='coach')h+='<button onclick="delPost(\''+post.id+'\')" style="color:#52C9A8;background:none;border:none;cursor:pointer;font-size:18px">&#x2715;</button>';
        h+='</div>';
        if(post.imageUrl)h+='<img src="'+esc(post.imageUrl)+'" style="width:100%;border-radius:12px;margin-bottom:12px;max-height:300px;object-fit:cover"/>';
        h+='<p style="color:#2D7060;line-height:1.7;font-size:15px;white-space:pre-line">'+esc(post.content)+'</p></div>';
      });
    }
  }

  // ‚îÄ‚îÄ MEETINGS TAB ‚îÄ‚îÄ
  if(tab==='meetings'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58">Meetings</h2>';
    if(mode==='coach'){
      h+='<div style="display:flex;gap:8px">';
      h+='<button onclick="openModal(\'contract\')" style="padding:10px 14px;background:#E8F8F4;border:1.5px solid #3BAA8C;border-radius:14px;font-weight:600;font-size:13px;cursor:pointer;color:#2D9078">Contract</button>';
      h+='<button onclick="openModal(\'mtg\')" class="bp" style="padding:10px 18px;font-size:14px">+ Schedule</button></div>';
    }
    h+='</div>';

    var ctKey=mode==='coach'?sc:cn;
    var ct=S.contracts[ctKey];
    if(ct&&ct.start&&ct.end){
      var startD=new Date(ct.start), endD=new Date(ct.end), todayD=new Date(td);
      var total=Math.round((endD-startD)/(1000*60*60*24));
      var elapsed=Math.round((todayD-startD)/(1000*60*60*24));
      var remaining=Math.round((endD-todayD)/(1000*60*60*24));
      var pct=Math.min(100,Math.max(0,Math.round((elapsed/total)*100)));
      var isExpired=todayD>endD, isActive=todayD>=startD&&!isExpired;
      h+='<div style="background:linear-gradient(135deg,#3BAA8C,#52C9A8);border-radius:20px;padding:22px;margin-bottom:20px;color:white">';
      h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">';
      h+='<div><p style="font-size:12px;opacity:.75;font-weight:600;text-transform:uppercase">Contract Period</p>';
      h+='<p style="font-family:\'DM Serif Display\',serif;font-size:20px;margin-top:4px">'+(ct.plan?esc(ct.plan):'Coaching Plan')+'</p></div>';
      if(isExpired)h+='<span style="background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700">Expired</span>';
      else if(isActive)h+='<span style="background:rgba(255,255,255,0.25);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700">Active</span>';
      else h+='<span style="background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700">Upcoming</span>';
      h+='</div>';
      h+='<div style="display:flex;justify-content:space-between;font-size:13px;opacity:.85;margin-bottom:10px">';
      h+='<span>'+fmtDate(ct.start)+'</span><span>'+fmtDate(ct.end)+'</span></div>';
      h+='<div style="background:rgba(255,255,255,0.25);border-radius:100px;height:8px;overflow:hidden;margin-bottom:10px">';
      h+='<div style="background:white;height:100%;border-radius:100px;width:'+pct+'%"></div></div>';
      h+='<div style="display:flex;justify-content:space-between;font-size:13px">';
      if(isExpired)h+='<span style="opacity:.8">Contract ended</span>';
      else if(isActive)h+='<span style="opacity:.8">'+remaining+' days remaining</span>';
      else h+='<span style="opacity:.8">Starts in '+Math.round((startD-todayD)/(1000*60*60*24))+' days</span>';
      h+='<span style="opacity:.8">'+pct+'% complete</span></div>';
      if(mode==='coach')h+='<button onclick="openModal(\'contract\')" style="margin-top:14px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.4);border-radius:10px;padding:6px 14px;color:white;font-size:12px;font-weight:600;cursor:pointer">Edit</button>';
      h+='</div>';
    }else if(mode==='coach'&&sc!=='all'){
      h+='<div class="cw" style="padding:18px;margin-bottom:20px;display:flex;align-items:center;gap:12px">';
      h+='<div style="flex:1"><p style="font-weight:600;color:#2D9078">No contract set</p>';
      h+='<p style="color:#5A9A8E;font-size:13px">Set a contract period for '+esc(sc)+'</p></div>';
      h+='<button onclick="openModal(\'contract\')" class="bp" style="padding:8px 14px;font-size:13px">Set</button></div>';
    }else if(mode==='client'){
      h+='<div class="cw" style="padding:18px;margin-bottom:20px"><p style="color:#5A9A8E;font-size:14px;text-align:center">Your coach will set your contract period here</p></div>';
    }

    if(upMtg.length>0){
      h+='<p style="font-size:12px;font-weight:700;color:#5A9A8E;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px">Upcoming</p>';
      upMtg.forEach(function(m){
        h+='<div class="upc" style="margin-bottom:10px">';
        h+='<div style="display:flex;justify-content:space-between;align-items:flex-start">';
        h+='<div><p style="font-family:\'DM Serif Display\',serif;font-size:20px;margin-bottom:6px">'+esc(m.title)+'</p>';
        h+='<p style="opacity:.75;font-size:13px">'+esc(m.date)+' &middot; '+esc(m.time)+'</p>';
        if(mode==='coach')h+='<p style="opacity:.9;font-size:14px;margin-top:4px;font-weight:600">'+esc(m.clientName)+'</p>';
        h+='</div>';
        if(mode==='coach')h+='<button onclick="delMtg(\''+m.id+'\')" style="color:rgba(255,255,255,.5);background:none;border:none;cursor:pointer;font-size:18px">&#x2715;</button>';
        h+='</div>';
        if(m.notes)h+='<p style="opacity:.8;font-size:14px;margin-top:10px;line-height:1.5">'+esc(m.notes)+'</p>';
        h+='</div>';
      });
    }
    if(pastMtg.length>0){
      h+='<p style="font-size:12px;font-weight:700;color:#5A9A8E;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;margin-top:'+(upMtg.length>0?'24':'0')+'px">Past</p>';
      pastMtg.forEach(function(m){
        h+='<div class="cw" style="padding:18px;margin-bottom:10px;opacity:.8">';
        h+='<div style="display:flex;justify-content:space-between">';
        h+='<div><p style="font-weight:600;color:#2D9078;font-size:15px;margin-bottom:4px">'+esc(m.title)+'</p>';
        h+='<p style="color:#5A9A8E;font-size:13px">'+esc(m.date)+' &middot; '+esc(m.time)+'</p>';
        if(mode==='coach')h+='<p style="color:#3BAA8C;font-size:13px;margin-top:4px">'+esc(m.clientName)+'</p>';
        h+='</div>';
        if(mode==='coach')h+='<button onclick="delMtg(\''+m.id+'\')" style="color:#52C9A8;background:none;border:none;cursor:pointer;font-size:16px">&#x2715;</button>';
        h+='</div></div>';
      });
    }
    if(relMtg.length===0&&!(ct&&ct.start)){
      h+='<div class="card" style="padding:40px;text-align:center"><p style="color:#5A9A8E;font-weight:600">No meetings yet</p></div>';
    }
  }

  // ‚îÄ‚îÄ GOALS TAB ‚îÄ‚îÄ
  if(tab==='goals'){
    var wk7=new Date();wk7.setDate(wk7.getDate()-7);
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58">Goals</h2>';
    if(mode==='coach')h+='<button onclick="setState({goalTarget:sc!==\'all\'?sc:\'\',modal:\'setGoal\'})" class="bp" style="padding:10px 18px;font-size:14px">+ Set Goal</button>';
    h+='</div>';
    if(mode==='coach'){
      var gcKeys=Object.keys(S.goals);
      if(gcKeys.length===0){
        h+='<div class="card" style="padding:40px;text-align:center">';
        h+='<p style="font-size:36px;margin-bottom:12px">üéØ</p>';
        h+='<p style="color:#5A9A8E;font-weight:600">No goals set yet</p>';
        h+='<p style="color:#A8DDD5;font-size:14px;margin-top:6px">Press + Set Goal to get started</p></div>';
      }else{
        gcKeys.forEach(function(gcn){
          var g=S.goals[gcn];
          var gcMeals=meals.filter(function(m){return m.clientName===gcn&&!m.isEmergency&&new Date(m.date)>=wk7;}).length;
          var gcJrnls=journals.filter(function(j){return j.clientName===gcn&&new Date(j.date)>=wk7;}).length;
          var gcSn=meals.filter(function(m){return m.clientName===gcn&&m.isEmergency&&new Date(m.date)>=wk7;}).length;
          var mPct=g.meals>0?Math.min(100,Math.round(gcMeals/g.meals*100)):0;
          var jPct=g.journals>0?Math.min(100,Math.round(gcJrnls/g.journals*100)):0;
          h+='<div class="card" style="padding:20px;margin-bottom:12px">';
          h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">';
          h+='<div style="display:flex;align-items:center;gap:10px">';
          h+='<div style="width:38px;height:38px;background:linear-gradient(135deg,#3BAA8C,#52C9A8);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700">'+esc(gcn.charAt(0).toUpperCase())+'</div>';
          h+='<p style="font-weight:700;color:#1A6B58;font-size:16px">'+esc(gcn)+'</p></div>';
          h+='<button onclick="setState({goalTarget:\''+esc(gcn)+'\',modal:\'setGoal\'})" style="font-size:12px;padding:5px 12px;background:#E8F8F4;border-radius:10px;color:#2D9078;font-weight:600;cursor:pointer">Edit</button></div>';
          if(g.meals>0){
            h+='<div style="margin-bottom:14px">';
            h+='<div style="display:flex;justify-content:space-between;margin-bottom:6px">';
            h+='<span style="font-size:13px;font-weight:600;color:#2D9078">üçΩÔ∏è Weekly Meals</span>';
            h+='<span style="font-size:13px;font-weight:700;color:'+(mPct>=100?'#3BAA8C':'#2D9078')+'">'+gcMeals+' / '+g.meals+(mPct>=100?' ‚úì':'')+'</span></div>';
            h+='<div style="background:#D4F2EB;border-radius:100px;height:10px;overflow:hidden">';
            h+='<div style="background:'+(mPct>=100?'#3BAA8C':'#52C9A8')+';height:100%;border-radius:100px;width:'+mPct+'%"></div></div></div>';
          }
          if(g.journals>0){
            h+='<div style="margin-bottom:14px">';
            h+='<div style="display:flex;justify-content:space-between;margin-bottom:6px">';
            h+='<span style="font-size:13px;font-weight:600;color:#2D9078">üìî Weekly Journals</span>';
            h+='<span style="font-size:13px;font-weight:700;color:'+(jPct>=100?'#3BAA8C':'#2D9078')+'">'+gcJrnls+' / '+g.journals+(jPct>=100?' ‚úì':'')+'</span></div>';
            h+='<div style="background:#D4F2EB;border-radius:100px;height:10px;overflow:hidden">';
            h+='<div style="background:'+(jPct>=100?'#3BAA8C':'#52C9A8')+';height:100%;border-radius:100px;width:'+jPct+'%"></div></div></div>';
          }
          if(g.noSpecial){
            h+='<div style="display:flex;align-items:center;gap:8px;background:'+(gcSn===0?'#E8F8F4':'#FEF3E2')+';border-radius:12px;padding:10px 14px">';
            h+='<span style="font-size:18px">'+(gcSn===0?'‚úÖ':'‚ö†Ô∏è')+'</span>';
            h+='<span style="font-size:13px;font-weight:600;color:'+(gcSn===0?'#2D9078':'#C8963E')+'">'+(gcSn===0?'No special notes this week':gcSn+' special note(s) this week')+'</span></div>';
          }
          h+='</div>';
        });
      }
    }else{
      var myG=S.goals[cn];
      if(!myG){
        h+='<div class="card" style="padding:40px;text-align:center">';
        h+='<p style="font-size:36px;margin-bottom:12px">üéØ</p>';
        h+='<p style="color:#5A9A8E;font-weight:600;font-size:16px">No goals set yet</p>';
        h+='<p style="color:#A8DDD5;font-size:14px;margin-top:6px">Your coach will set your goals soon!</p></div>';
      }else{
        var myMls=relM.filter(function(m){return!m.isEmergency&&new Date(m.date)>=wk7;}).length;
        var myJls=relJ.filter(function(j){return new Date(j.date)>=wk7;}).length;
        var mySn=relM.filter(function(m){return m.isEmergency&&new Date(m.date)>=wk7;}).length;
        var myMP=myG.meals>0?Math.min(100,Math.round(myMls/myG.meals*100)):0;
        var myJP=myG.journals>0?Math.min(100,Math.round(myJls/myG.journals*100)):0;
        var avgP=Math.round((myMP+(myG.journals>0?myJP:myMP))/2);
        var motiv=avgP>=100?'Amazing! You hit all your goals this week! üéâ':avgP>=70?'Great progress! Keep it up! üí™':avgP>=40?'You\'re on your way, stay consistent! üåø':'Every meal logged counts. Let\'s go! ‚ú®';
        h+='<div style="background:linear-gradient(135deg,#3BAA8C,#52C9A8);border-radius:20px;padding:22px;margin-bottom:20px;color:white">';
        h+='<p style="font-size:22px;font-weight:700;font-family:\'DM Serif Display\',serif;margin-bottom:6px">This Week</p>';
        h+='<p style="opacity:.9;font-size:14px;line-height:1.5">'+motiv+'</p></div>';
        if(myG.meals>0){
          h+='<div class="card" style="padding:20px;margin-bottom:12px">';
          h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
          h+='<span style="font-size:15px;font-weight:700;color:#1A6B58">üçΩÔ∏è Meals Logged</span>';
          h+='<span style="font-size:18px;font-weight:700;color:'+(myMP>=100?'#3BAA8C':'#2D9078')+'">'+myMls+' / '+myG.meals+(myMP>=100?' ‚úì':'')+'</span></div>';
          h+='<div style="background:#D4F2EB;border-radius:100px;height:14px;overflow:hidden;margin-bottom:8px">';
          h+='<div style="background:'+(myMP>=100?'#3BAA8C':'#52C9A8')+';height:100%;border-radius:100px;width:'+myMP+'%"></div></div>';
          h+='<p style="font-size:13px;color:#5A9A8E">'+myMP+'% complete</p></div>';
        }
        if(myG.journals>0){
          h+='<div class="card" style="padding:20px;margin-bottom:12px">';
          h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
          h+='<span style="font-size:15px;font-weight:700;color:#1A6B58">üìî Journals Written</span>';
          h+='<span style="font-size:18px;font-weight:700;color:'+(myJP>=100?'#3BAA8C':'#2D9078')+'">'+myJls+' / '+myG.journals+(myJP>=100?' ‚úì':'')+'</span></div>';
          h+='<div style="background:#D4F2EB;border-radius:100px;height:14px;overflow:hidden;margin-bottom:8px">';
          h+='<div style="background:'+(myJP>=100?'#3BAA8C':'#52C9A8')+';height:100%;border-radius:100px;width:'+myJP+'%"></div></div>';
          h+='<p style="font-size:13px;color:#5A9A8E">'+myJP+'% complete</p></div>';
        }
        if(myG.noSpecial){
          h+='<div class="card" style="padding:20px;margin-bottom:12px;display:flex;align-items:center;gap:12px">';
          h+='<span style="font-size:36px">'+(mySn===0?'‚úÖ':'‚ö†Ô∏è')+'</span>';
          h+='<div><p style="font-weight:700;color:#1A6B58;font-size:15px">No Special Notes</p>';
          h+='<p style="color:'+(mySn===0?'#3BAA8C':'#C8963E')+';font-size:14px;margin-top:2px">'+(mySn===0?'Goal achieved this week!':mySn+' note(s) this week')+'</p></div></div>';
        }
      }
      // ‚îÄ‚îÄ Ï∞®Ìä∏: ÏãúÍ∞ÑÎåÄÎ≥Ñ ÏãùÏÇ¨ & Ìè¨ÎßåÍ∞ê ‚îÄ‚îÄ
      if(relM.length>0){
        var slots={Morning:[],Afternoon:[],Evening:[],Night:[]};
        relM.forEach(function(m){
          if(m.isEmergency||!m.time)return;
          var hh=parseInt(m.time.split(':')[0],10);
          var sl=hh>=5&&hh<12?'Morning':hh>=12&&hh<17?'Afternoon':hh>=17&&hh<21?'Evening':'Night';
          var sh=0;
          if(m.satietyHours){
            sh=m.satietyHours==='1-2h'?1.5:m.satietyHours==='2-3h'?2.5:m.satietyHours==='3-4h'?3.5:4.5;
          }
          slots[sl].push({full:parseInt(m.fullness)||0,sat:sh,mt:m.mealType||''});
        });
        var slColors={Morning:'#52C9A8',Afternoon:'#3BAA8C',Evening:'#2D7060',Night:'#1A5248'};
        var slIcons={Morning:'üåÖ',Afternoon:'‚òÄÔ∏è',Evening:'üåÜ',Night:'üåô'};
        var hasSlot=false;
        ['Morning','Afternoon','Evening','Night'].forEach(function(sl){if(slots[sl].length>0)hasSlot=true;});
        if(hasSlot){
          h+='<div class="card" style="padding:20px;margin-bottom:12px">';
          h+='<p style="font-weight:700;color:#1A6B58;font-size:16px;margin-bottom:18px">Meal Timing & Fullness</p>';
          ['Morning','Afternoon','Evening','Night'].forEach(function(sl){
            var items=slots[sl];
            if(items.length===0)return;
            var avgFull=Math.round(items.reduce(function(a,b){return a+b.full;},0)/items.length*10)/10;
            var satItems=items.filter(function(i){return i.sat>0;});
            var avgSat=satItems.length>0?Math.round(satItems.reduce(function(a,b){return a+b.sat;},0)/satItems.length*10)/10:0;
            var fullPct=Math.round(avgFull/5*100);
            h+='<div style="margin-bottom:16px">';
            h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
            h+='<div style="display:flex;align-items:center;gap:6px">';
            h+='<span style="font-size:16px">'+slIcons[sl]+'</span>';
            h+='<span style="font-size:14px;font-weight:600;color:#1A6B58">'+sl+'</span>';
            h+='<span style="font-size:12px;color:#5A9A8E;background:#F4FBFA;padding:2px 8px;border-radius:10px">'+items.length+' meals</span></div>';
            h+='<div style="text-align:right">';
            h+='<span style="font-size:12px;color:#5A9A8E">avg full: '+avgFull+'/5';
            if(avgSat>0)h+=' &middot; stays '+avgSat+'h';
            h+='</span></div></div>';
            h+='<div style="display:flex;align-items:center;gap:8px">';
            h+='<div style="flex:1;background:#D4F2EB;border-radius:100px;height:12px;overflow:hidden">';
            h+='<div style="background:'+slColors[sl]+';height:100%;border-radius:100px;width:'+fullPct+'%"></div></div>';
            h+='<span style="font-size:11px;color:#5A9A8E;font-weight:600;min-width:28px">'+fullPct+'%</span></div>';
            h+='</div>';
          });
          h+='</div>';
        }
        // Ìè¨ÎßåÍ∞ê ÏßÄÏÜçÏãúÍ∞Ñ Î∂ÑÌè¨
        var satAll=relM.filter(function(m){return m.satietyHours&&!m.isEmergency;});
        if(satAll.length>0){
          var satC={'1-2h':0,'2-3h':0,'3-4h':0,'4h+':0};
          satAll.forEach(function(m){if(satC[m.satietyHours]!==undefined)satC[m.satietyHours]++;});
          var maxSC=Math.max(satC['1-2h'],satC['2-3h'],satC['3-4h'],satC['4h+'])||1;
          h+='<div class="card" style="padding:20px;margin-bottom:12px">';
          h+='<p style="font-weight:700;color:#1A6B58;font-size:16px;margin-bottom:18px">Satiety Duration</p>';
          ['1-2h','2-3h','3-4h','4h+'].forEach(function(k){
            var cnt=satC[k];
            var pct=Math.round(cnt/maxSC*100);
            var barC=pct>=80?'#3BAA8C':pct>=50?'#52C9A8':'#A8DDD5';
            h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">';
            h+='<span style="font-size:13px;font-weight:700;color:#2D9078;min-width:34px">'+k+'</span>';
            h+='<div style="flex:1;background:#D4F2EB;border-radius:100px;height:12px;overflow:hidden">';
            h+='<div style="background:'+barC+';height:100%;border-radius:100px;width:'+pct+'%"></div></div>';
            h+='<span style="font-size:12px;color:#5A9A8E;min-width:24px">'+cnt+'x</span></div>';
          });
          h+='<p style="font-size:12px;color:#5A9A8E;margin-top:6px;text-align:right">Based on '+satAll.length+' meals</p></div>';
        }
      }
    }
  }

  // ‚îÄ‚îÄ TEMPLATE TAB ‚îÄ‚îÄ
  if(tab==='template'){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
    h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58">'+(mode==='coach'?'Templates':'Diet Plan')+'</h2>';
    if(mode==='coach')h+='<button onclick="openModal(\'addTemplate\')" class="bp" style="padding:10px 18px;font-size:14px">+ New</button>';
    h+='</div>';
    if(mode==='client')h+='<p style="color:#5A9A8E;font-size:14px;line-height:1.6;margin-bottom:20px">Diet plans aren\'t always provided ‚Äî your coach will share one when needed. In the meantime, enjoy eating what feels good to you and listen to your body!</p>';
    if(mode==='coach'){
      if(S.templates.length===0){
        h+='<div class="card" style="padding:40px;text-align:center">';
        h+='<p style="font-size:36px;margin-bottom:12px">ü•ó</p>';
        h+='<p style="color:#5A9A8E;font-weight:600">No templates yet</p>';
        h+='<p style="color:#A8DDD5;font-size:14px;margin-top:6px">Create one to share with clients</p></div>';
      }else{
        S.templates.forEach(function(tpl){
          h+='<div class="card" style="padding:20px;margin-bottom:12px">';
          h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">';
          h+='<div>';
          h+='<h3 style="font-weight:700;color:#1A6B58;font-size:17px;margin-bottom:6px">'+esc(tpl.title)+'</h3>';
          h+='<span class="ts" style="font-size:11px">'+(tpl.target==='all'?'All Clients':esc(tpl.target))+'</span>';
          h+='</div>';
          h+='<button onclick="delTemplate('+tpl.id+')" style="color:#52C9A8;font-size:18px">&#x2715;</button></div>';
          h+='<pre style="color:#2D7060;font-size:13px;line-height:1.7;white-space:pre-wrap;font-family:inherit;background:#F4FBFA;border-radius:12px;padding:14px">'+esc(tpl.content)+'</pre></div>';
        });
      }
    }else{
      var myTpls=S.templates.filter(function(t){return t.target==='all'||t.target===cn;});
      if(myTpls.length===0){
        h+='<div class="card" style="padding:40px;text-align:center">';
        h+='<p style="font-size:36px;margin-bottom:12px">ü•ó</p>';
        h+='<p style="color:#5A9A8E;font-weight:600;font-size:16px">No diet plan yet</p>';
        h+='<p style="color:#A8DDD5;font-size:14px;margin-top:6px">Your coach will share one soon!</p></div>';
      }else{
        myTpls.forEach(function(tpl){
          h+='<div class="card" style="padding:22px;margin-bottom:12px">';
          h+='<h3 style="font-family:\'DM Serif Display\',serif;font-weight:700;color:#1A6B58;font-size:20px;margin-bottom:14px">'+esc(tpl.title)+'</h3>';
          h+='<pre style="color:#2D7060;font-size:14px;line-height:1.8;white-space:pre-wrap;font-family:inherit;background:#F4FBFA;border-radius:12px;padding:16px">'+esc(tpl.content)+'</pre></div>';
        });
      }
    }
  }

  // ‚îÄ‚îÄ PAYMENT TAB ‚îÄ‚îÄ
  if(tab==='payment'){
    if(mode==='coach'){
      h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58;margin-bottom:8px">Payment Plans</h2>';
      h+='<p style="color:#5A9A8E;font-size:14px;margin-bottom:20px">Plans shown to your clients.</p>';
      PLANS.forEach(function(p){
        h+='<div class="card" style="padding:20px;margin-bottom:12px;display:flex;align-items:center;gap:14px">';
        h+='<span style="font-size:32px">'+p.e+'</span><div>';
        h+='<p style="font-weight:700;color:#1A6B58;font-size:16px">'+p.name+'</p>';
        h+='<p style="color:#3BAA8C;font-size:20px;font-weight:700">SGD '+p.price+'</p>';
        h+='<p style="color:#5A9A8E;font-size:13px">'+p.desc+'</p></div></div>';
      });
    }else if(S.ppPaid){
      h+='<div style="text-align:center;padding:40px 20px">';
      h+='<div style="font-size:64px;margin-bottom:16px">üéâ</div>';
      h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:28px;color:#1A6B58;margin-bottom:8px">Payment Successful!</h2>';
      h+='<p style="color:#5A9A8E;font-size:15px;margin-bottom:8px">'+esc(S.ppPaid.name)+' &mdash; SGD '+esc(S.ppPaid.price)+'</p>';
      h+='<div style="background:#E8F8F4;border-radius:16px;padding:20px;margin:24px 0"><p style="color:#2D9078;font-size:14px;line-height:1.7">Thank you! Your coach will be in touch shortly.</p></div>';
      h+='<button onclick="setState({ppPaid:null,ppSel:null})" class="bo" style="padding:12px 24px">Back to Plans</button></div>';
    }else{
      h+='<h2 style="font-family:\'DM Serif Display\',serif;font-size:24px;color:#1A6B58;margin-bottom:8px">Payment</h2>';
      h+='<p style="color:#5A9A8E;font-size:14px;margin-bottom:20px">Choose a plan to get started.</p>';
      PLANS.forEach(function(plan){
        var sel=S.ppSel&&S.ppSel.id===plan.id;
        h+='<div onclick="selectPlan(\''+plan.id+'\')" style="background:'+(sel?'#E8F8F4':'#fff')+';border:'+(sel?'2px solid #3BAA8C':'1.5px solid #C8EDE6')+';border-radius:18px;padding:20px;margin-bottom:12px;cursor:pointer">';
        h+='<div style="display:flex;align-items:center;gap:12px">';
        h+='<span style="font-size:32px">'+plan.e+'</span><div style="flex:1">';
        h+='<p style="font-weight:700;color:#1A6B58;font-size:16px">'+plan.name+'</p>';
        h+='<p style="color:#3BAA8C;font-size:20px;font-weight:700">SGD '+plan.price+'</p>';
        h+='<p style="color:#5A9A8E;font-size:13px">'+plan.desc+'</p></div>';
        if(sel)h+='<span style="color:#3BAA8C;font-size:20px">&#10003;</span>';
        h+='</div>';
        if(sel){
          h+='<div id="pp-container" onclick="event.stopPropagation()" style="margin-top:16px;border-top:1px solid #D4F2EB;padding-top:16px"></div>';
        }
        h+='</div>';
      });
      h+='<div style="background:#F4FBFA;border-radius:14px;padding:14px;margin-top:4px"><p style="color:#5A9A8E;font-size:13px;text-align:center">Secure payment via PayPal &middot; All major cards accepted</p></div>';
    }
  }

  h+='</div></div>';
  return h;
}

function buildMealCard(meal,mode){
  var exp=S.expMeals[meal.id], fbs=meal.feedback||[];
  var h='<div style="background:'+(meal.isEmergency?'#E8F8F4':'#fff')+';border:1.5px solid '+(meal.isEmergency?'#B8D4B9':'#C8EDE6')+';border-radius:18px;overflow:hidden;margin-bottom:10px">';
  h+='<button onclick="toggleM(\''+meal.id+'\')" style="width:100%;padding:14px 18px;display:flex;align-items:center;gap:12px;text-align:left;background:none;border:none;cursor:pointer">';
  h+='<div style="flex:1;display:flex;align-items:center;gap:10px;min-width:0">';
  if(meal.isEmergency)h+='<span class="ts">Special</span>';
  else h+='<span class="td">'+esc(meal.mealType)+'</span>';
  h+='<span style="font-weight:600;color:#2D9078;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(meal.clientName)+'</span>';
  h+='<span style="color:#5A9A8E;font-size:13px;flex-shrink:0">'+esc(meal.time)+'</span>';
  if(fbs.length>0)h+='<span style="color:#5A9A8E;font-size:12px;flex-shrink:0">'+fbs.length+' fb</span>';
  h+='</div><span style="color:#52C9A8">'+(exp?'&#9650;':'&#9660;')+'</span></button>';
  if(exp){
    h+='<div style="padding:0 18px 20px;border-top:1px solid #D4F2EB">';
    if(mode==='coach'){
      h+='<div style="display:flex;justify-content:flex-end;padding-top:12px;margin-bottom:8px">';
      h+='<button onclick="delMeal(\''+meal.id+'\')" style="color:#52C9A8;font-size:18px">&#x2715;</button></div>';
    }
    h+='<p style="color:#2D7060;line-height:1.6;margin-top:'+(mode!=='coach'?'14':'0')+'px;margin-bottom:12px">';
    if(meal.isEmergency&&meal.emergencyType)h+='<span class="ts" style="margin-right:8px;margin-bottom:6px;display:inline-block">'+esc(meal.emergencyType)+'</span>';
    h+=esc(meal.foods)+'</p>';
    if(meal.fullness||meal.satietyHours){
      var FL2=['','Still hungry','A little full','Just right','Pretty full','Very full'];
      h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
      if(meal.fullness)h+='<span style="background:#D4F2EB;color:#2D9078;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:600">'+esc(FL2[meal.fullness]||meal.fullness)+'</span>';
      if(meal.satietyHours)h+='<span style="background:#D4F2EB;color:#2D9078;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:600">'+esc(meal.satietyHours)+'</span>';
      h+='</div>';
    }
    fbs.forEach(function(fb){
      h+='<div style="background:#E8F8F4;border-radius:14px;padding:12px 16px;margin-bottom:8px">';
      h+='<div style="display:flex;justify-content:space-between;margin-bottom:4px">';
      h+='<span style="font-size:12px;font-weight:700;color:#3BAA8C">'+esc(fb.author)+'</span>';
      h+='<span style="font-size:11px;color:#5A9A8E">'+esc(fb.timestamp)+'</span></div>';
      h+='<p style="color:#2D7060;font-size:14px">'+esc(fb.text)+'</p></div>';
    });
    if(mode==='coach'){
      if(S.selMeal==meal.id){
        h+='<div style="display:flex;gap:8px;padding-top:12px;border-top:1px solid #D4F2EB">';
        h+='<input id="fb-inp" class="inp" placeholder="Write feedback..." style="flex:1"/>';
        h+='<button onclick="addFeedback(\''+meal.id+'\')" class="bs" style="padding:10px 14px">Send</button>';
        h+='<button onclick="setState({selMeal:\'\'})" style="color:#52C9A8;padding:10px;font-size:18px">&#x2715;</button></div>';
      }else{
        h+='<button onclick="setState({selMeal:\''+meal.id+'\'})" style="color:#3BAA8C;font-weight:600;font-size:14px;padding-top:12px;border-top:1px solid #D4F2EB;width:100%;text-align:left;background:none;border:none;cursor:pointer">+ Add Feedback</button>';
      }
    }
    h+='</div>';
  }
  return h+'</div>';
}

function attachEvents(){
  var cpw=document.getElementById('m-cpw');
  if(cpw){cpw.focus();cpw.onkeydown=function(e){if(e.key==='Enter')verifyCoach();};}
  var cpw2=document.getElementById('m-cpw2');
  if(cpw2){cpw2.focus();cpw2.onkeydown=function(e){if(e.key==='Enter')verifyChange();};}
  var at=document.getElementById('ans-txt');
  if(at)at.oninput=function(e){S.ansText=e.target.value;};
  var rn=document.getElementById('reg-name');
  if(rn){
    rn.value=S.tmpName;
    rn.oninput=function(e){S.tmpName=e.target.value;};
    rn.onkeydown=function(e){
      if(e.key==='Tab'||e.key==='Enter'){
        e.preventDefault();
        var pw=document.getElementById('reg-pw');
        if(pw)pw.focus();
      }
    };
  }
  var rp=document.getElementById('reg-pw');
  if(rp){
    rp.value=S.tmpPw;
    rp.oninput=function(e){S.tmpPw=e.target.value;};
    rp.onkeydown=function(e){if(e.key==='Enter')signup();};
  }
  var ctcn=document.getElementById('ct-cn');
  if(ctcn){ctcn.value=S.formContract.cn;ctcn.oninput=function(e){S.formContract.cn=e.target.value;};}
  var ctpl=document.getElementById('ct-plan');
  if(ctpl){ctpl.value=S.formContract.plan;ctpl.oninput=function(e){S.formContract.plan=e.target.value;};}
  var ctst=document.getElementById('ct-start');
  if(ctst)ctst.oninput=function(e){S.formContract.start=e.target.value;};
  var cten=document.getElementById('ct-end');
  if(cten)cten.oninput=function(e){S.formContract.end=e.target.value;};
  if(S.tab==='payment'&&S.ppSel&&!S.ppPaid){
    var btn=document.getElementById('pp-container');
    if(btn&&!btn.dataset.loaded){
      btn.dataset.loaded='1';
      loadPP().then(function(){
        var b=document.getElementById('pp-container');
        if(!b||!window.paypal)return;
        window.paypal.Buttons({
          style:{layout:'vertical',color:'gold',shape:'rect',label:'pay',height:48},
          createOrder:function(_,a){
            return a.order.create({purchase_units:[{amount:{value:S.ppSel.price,currency_code:'SGD'},description:S.ppSel.name}]});
          },
          onApprove:function(_,a){
            return a.order.capture().then(function(){setState({ppPaid:S.ppSel,ppSel:null});});
          },
          onError:function(){alert('Payment failed. Please try again.');}
        }).render('#pp-container');
      }).catch(function(){
        var b=document.getElementById('pp-container');
        if(b)b.innerHTML='<p style="color:#E05C5C;text-align:center;padding:12px">Could not load PayPal.</p>';
      });
    }
  }
}

window.setState=setState; window.sync=sync;
window.openModal=function(n){setState({modal:n});};
window.closeModal=function(){setState({modal:'',formContract:{cn:'',start:'',end:'',plan:''}});};
window.switchTab=function(t){
  var patch={tab:t};
  if(t==='posts'&&S.mode==='client'){
    var rp2=Object.assign({},S.readPosts);
    S.posts.forEach(function(p){rp2[String(p.id)]=true;});
    patch.readPosts=rp2;lsSetObj('readPosts',rp2);
  }
  setState(patch);
};
window.openInq=function(id){
  var exp=!S.expInq[id];
  var expInq=Object.assign({},S.expInq);
  expInq[id]=exp;
  var patch={expInq:expInq};
  if(exp&&S.mode==='client'){
    var inq=null;
    S.inquiries.forEach(function(i){if(String(i.id)===String(id))inq=i;});
    if(inq&&inq.answer){
      var ra=Object.assign({},S.readAnswers);
      ra[String(id)]=true;
      patch.readAnswers=ra;
      lsSetObj('readAnswers',ra);
    }
  }
  setState(patch);
};
window.verifyCoach=function(){
  var pw=(document.getElementById('m-cpw')&&document.getElementById('m-cpw').value)||'';
  if(pw===CPW)setState({mode:'coach',modal:''});
  else alert('Incorrect password');
};
window.verifyChange=function(){
  var pw=(document.getElementById('m-cpw2')&&document.getElementById('m-cpw2').value)||'';
  if(pw===lsStr('clientPw')){lsRm('clientName');lsRm('clientPw');setState({clientName:'',modal:''});}
  else alert('Incorrect password');
};
window.signup=function(){
  var n=(document.getElementById('reg-name')&&document.getElementById('reg-name').value)||S.tmpName||'';
  var p=(document.getElementById('reg-pw')&&document.getElementById('reg-pw').value)||S.tmpPw||'';
  if(!n.trim()||!p.trim())return alert('Please enter your name and password.');
  lsSetStr('clientName',n.trim());lsSetStr('clientPw',p.trim());
  setState({clientName:n.trim(),tmpName:'',tmpPw:''});
};
window.setMT=function(v){S.formMeal.mt=v;render();};
window.setFull=function(v){S.formMeal.full=v;render();};
window.setSat=function(v){S.formMeal.sat=v;render();};
window.setMood=function(v){S.formJrn.mood=v;render();};
window.setEnergy=function(v){S.formJrn.energy=v;render();};
window.setEmType=function(v){S.formEm.type=v;render();};
window.setInqCat=function(v){S.formInq.cat=v;render();};
window.selectPlan=function(id){
  var plan=null;
  PLANS.forEach(function(p){if(p.id===id)plan=p;});
  setState({ppSel:S.ppSel&&S.ppSel.id===id?null:plan});
};
window.toggleM=function(id){S.expMeals[id]=!S.expMeals[id];render();};
window.toggleJ=function(id){S.expJournals[id]=!S.expJournals[id];render();};
window.toggleD=function(d){S.expDates[d]=!S.expDates[d];render();};
window.saveWelcomeMsg=function(){
  var txt=(document.getElementById('wm-txt')&&document.getElementById('wm-txt').value)||'';
  var target=S.wmTarget||'all';
  var key=target==='all'?'__all__':target;
  var msgs=Object.assign({},S.welcomeMsgs);
  if(txt.trim()){msgs[key]=txt;}else{delete msgs[key];}
  lsSetObj('welcomeMsgs',msgs);
  setState({welcomeMsgs:msgs,modal:''});
};
window.clearWelcomeMsg=function(){
  var target=S.wmTarget||'all';
  var key=target==='all'?'__all__':target;
  var msgs=Object.assign({},S.welcomeMsgs);
  delete msgs[key];
  lsSetObj('welcomeMsgs',msgs);
  setState({welcomeMsgs:msgs,modal:''});
};
window.handlePostImg=function(e){
  var file=e.target.files[0];if(!file)return;
  setState({postUp:true,postPrev:URL.createObjectURL(file)});
  uploadImg(file).then(function(url){setState({postImg:url,postUp:false});}).catch(function(){
    alert('Image upload failed');setState({postUp:false,postPrev:'',postImg:''});
  });
};
window.submitContract=function(){
  var cn2=(document.getElementById('ct-cn')&&document.getElementById('ct-cn').value)||S.formContract.cn||'';
  var plan2=(document.getElementById('ct-plan')&&document.getElementById('ct-plan').value)||S.formContract.plan||'';
  var start2=(document.getElementById('ct-start')&&document.getElementById('ct-start').value)||S.formContract.start||'';
  var end2=(document.getElementById('ct-end')&&document.getElementById('ct-end').value)||S.formContract.end||'';
  if(!cn2.trim()||!start2||!end2)return alert('Please fill in client name, start and end dates.');
  var row={clientName:cn2.trim(),plan:plan2,start:start2,end:end2};
  apiCall('contracts','upsertContract',{row:row}).catch(function(){});
  var ct=Object.assign({},S.contracts);
  ct[cn2.trim()]={plan:plan2,start:start2,end:end2};
  lsSetObj('contracts',ct);
  setState({contracts:ct,modal:'',formContract:{cn:'',start:'',end:'',plan:''}});
};
window.submitMeal=function(){
  var foods=(document.getElementById('f-foods')&&document.getElementById('f-foods').value)||'';
  var date=(document.getElementById('f-date')&&document.getElementById('f-date').value)||today();
  var time=(document.getElementById('f-time')&&document.getElementById('f-time').value)||nowTime();
  if(!foods.trim())return;
  setState({saving:true});
  var row={id:Date.now(),clientName:S.clientName,date:date,time:time,mealType:S.formMeal.mt,foods:foods,fullness:S.formMeal.full,satietyHours:S.formMeal.sat,emergencyType:'',feedback:'[]',isEmergency:false,timestamp:nowTs()};
  apiCall('meals','append',{row:row}).catch(function(){}).then(function(){
    var nm=[Object.assign({},row,{feedback:[]})].concat(S.meals);
    lsSet('meals',nm);
    setState({meals:nm,modal:'',saving:false,formMeal:{date:today(),time:nowTime(),mt:'Breakfast',full:'',sat:''}});
  });
};
window.submitJournal=function(){
  var feelings=(document.getElementById('j-feel')&&document.getElementById('j-feel').value)||'';
  var notes=(document.getElementById('j-notes')&&document.getElementById('j-notes').value)||'';
  var date=(document.getElementById('j-date')&&document.getElementById('j-date').value)||today();
  if(!feelings.trim())return;
  setState({saving:true});
  var row={id:Date.now(),clientName:S.clientName,date:date,mood:S.formJrn.mood,energy:S.formJrn.energy,feelings:feelings,notes:notes,jfeedback:'[]',timestamp:nowTs()};
  apiCall('journals','append',{row:row}).catch(function(){}).then(function(){
    var nj=[Object.assign({},row,{jfeedback:[]})].concat(S.journals);
    lsSet('journals',nj);
    setState({journals:nj,modal:'',saving:false,formJrn:{date:today(),mood:'',energy:''}});
  });
};
window.submitEm=function(){
  var notes=(document.getElementById('e-notes')&&document.getElementById('e-notes').value)||'';
  var date=(document.getElementById('e-date')&&document.getElementById('e-date').value)||today();
  var time=(document.getElementById('e-time')&&document.getElementById('e-time').value)||nowTime();
  setState({saving:true});
  var row={id:Date.now(),clientName:S.clientName,date:date,time:time,mealType:'Emergency',foods:notes||S.formEm.type,emergencyType:S.formEm.type,fullness:'',satietyHours:'',feedback:'[]',isEmergency:true,timestamp:nowTs()};
  apiCall('meals','append',{row:row}).catch(function(){}).then(function(){
    var nm=[Object.assign({},row,{feedback:[]})].concat(S.meals);
    lsSet('meals',nm);
    setState({meals:nm,modal:'',saving:false});
  });
};
window.submitPost=function(){
  var title=(document.getElementById('p-title')&&document.getElementById('p-title').value)||'';
  var content=(document.getElementById('p-content')&&document.getElementById('p-content').value)||'';
  if(!title.trim()||!content.trim())return;
  setState({saving:true});
  var row={id:Date.now(),title:title,content:content,imageUrl:S.postImg||'',date:new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})};
  apiCall('posts','append',{row:row}).catch(function(){}).then(function(){
    var np=[row].concat(S.posts);
    lsSet('posts',np);
    setState({posts:np,modal:'',saving:false,postImg:'',postPrev:''});
  });
};
window.submitMtg=function(){
  var mcn=(document.getElementById('m-cn')&&document.getElementById('m-cn').value)||'';
  var title=(document.getElementById('m-title')&&document.getElementById('m-title').value)||'';
  var notes=(document.getElementById('m-notes')&&document.getElementById('m-notes').value)||'';
  var date=(document.getElementById('m-date')&&document.getElementById('m-date').value)||today();
  var time=(document.getElementById('m-time')&&document.getElementById('m-time').value)||'';
  if(!title.trim()||!time)return;
  setState({saving:true});
  var name=S.mode==='coach'?mcn:S.clientName;
  var row={id:Date.now(),clientName:name,date:date,time:time,title:title,notes:notes};
  apiCall('meetings','append',{row:row}).catch(function(){}).then(function(){
    var nm=S.meetings.concat([row]).sort(function(a,b){return new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time);});
    lsSet('meetings',nm);
    setState({meetings:nm,modal:'',saving:false});
  });
};
window.submitInq=function(){
  var q=(document.getElementById('inq-q')&&document.getElementById('inq-q').value)||'';
  if(!q.trim())return;
  setState({saving:true});
  var row={id:Date.now(),clientName:S.clientName,category:S.formInq.cat,question:q,answer:'',resolved:false,date:today(),timestamp:nowTs()};
  apiCall('inquiries','append',{row:row}).catch(function(){}).then(function(){
    var ni=[row].concat(S.inquiries);
    lsSet('inquiries',ni);
    setState({inquiries:ni,modal:'',saving:false});
  });
};
window.submitAnswer=function(id){
  var text=(document.getElementById('ans-txt')&&document.getElementById('ans-txt').value)||S.ansText;
  if(!text.trim())return;
  setState({saving:true});
  apiCall('inquiries','update',{id:id,row:{answer:text}}).catch(function(){}).then(function(){
    var u=S.inquiries.map(function(i){return i.id==id?Object.assign({},i,{answer:text}):i;});
    lsSet('inquiries',u);
    setState({inquiries:u,ansId:'',ansText:'',saving:false});
  });
};
window.toggleRes=function(id){
  var inq=null;S.inquiries.forEach(function(i){if(i.id==id)inq=i;});
  var nv=!inq.resolved;
  apiCall('inquiries','update',{id:id,row:{resolved:nv}}).catch(function(){});
  var u=S.inquiries.map(function(i){return i.id==id?Object.assign({},i,{resolved:nv}):i;});
  lsSet('inquiries',u);setState({inquiries:u});
};
window.addFeedback=function(mealId){
  var text=(document.getElementById('fb-inp')&&document.getElementById('fb-inp').value)||'';
  if(!text.trim())return;setState({saving:true});
  var meal=null;S.meals.forEach(function(m){if(m.id==mealId)meal=m;});
  var fb=(meal.feedback||[]).concat([{id:Date.now(),text:text,timestamp:nowTs(),author:'Coach'}]);
  apiCall('meals','update',{id:mealId,row:{feedback:JSON.stringify(fb)}}).catch(function(){});
  var u=S.meals.map(function(m){return m.id==mealId?Object.assign({},m,{feedback:fb}):m;});
  lsSet('meals',u);setState({meals:u,selMeal:'',saving:false});
};
window.addJournalFeedback=function(jrnId){
  var text=(document.getElementById('jfb-inp')&&document.getElementById('jfb-inp').value)||'';
  if(!text.trim())return;setState({saving:true});
  var jrn=null;S.journals.forEach(function(j){if(j.id==jrnId)jrn=j;});
  var jfb=(jrn.jfeedback||[]).concat([{id:Date.now(),text:text,timestamp:nowTs(),author:'Coach'}]);
  apiCall('journals','update',{id:jrnId,row:{jfeedback:JSON.stringify(jfb)}}).catch(function(){});
  var u=S.journals.map(function(j){return j.id==jrnId?Object.assign({},j,{jfeedback:jfb}):j;});
  lsSet('journals',u);setState({journals:u,selJrn:'',saving:false});
};
window.delMeal=function(id){apiCall('meals','delete',{id:id}).catch(function(){});var u=S.meals.filter(function(m){return m.id!=id;});lsSet('meals',u);setState({meals:u});};
window.delPost=function(id){apiCall('posts','delete',{id:id}).catch(function(){});var u=S.posts.filter(function(p){return p.id!=id;});lsSet('posts',u);setState({posts:u});};
window.delMtg=function(id){apiCall('meetings','delete',{id:id}).catch(function(){});var u=S.meetings.filter(function(m){return m.id!=id;});lsSet('meetings',u);setState({meetings:u});};
window.delInq=function(id){apiCall('inquiries','delete',{id:id}).catch(function(){});var u=S.inquiries.filter(function(i){return i.id!=id;});lsSet('inquiries',u);setState({inquiries:u});};

// ‚îÄ‚îÄ Goals ‚îÄ‚îÄ
window.updateGoalTarget=function(cn){
  var existing=S.goals[cn]||{meals:0,journals:0,noSpecial:false};
  setState({goalTarget:cn,goalForm:Object.assign({},existing)});
};
window.setGF=function(key,val){
  var gf=Object.assign({},S.goalForm);
  // toggle: Í∞ôÏùÄ Í∞í ÎàÑÎ•¥Î©¥ 0ÏúºÎ°ú Ï¥àÍ∏∞Ìôî
  if(key==='meals'||key==='journals'){gf[key]=gf[key]===val?0:val;}
  else{gf[key]=val;}
  setState({goalForm:gf});
};
window.saveGoal=function(){
  var cn=(document.getElementById('goal-cn')&&document.getElementById('goal-cn').value)||S.goalTarget||'';
  if(!cn)return alert('Please select a client.');
  var gf=S.goalForm||{meals:0,journals:0,noSpecial:false};
  var goals=Object.assign({},S.goals);
  goals[cn]=gf;
  lsSetObj('goals',goals);
  setState({goals:goals,modal:'',goalTarget:''});
};

// ‚îÄ‚îÄ Templates ‚îÄ‚îÄ
window.saveTemplate=function(){
  var title=(document.getElementById('tpl-title')&&document.getElementById('tpl-title').value)||'';
  var target=(document.getElementById('tpl-target')&&document.getElementById('tpl-target').value)||'all';
  var content=(document.getElementById('tpl-content')&&document.getElementById('tpl-content').value)||'';
  if(!title.trim()||!content.trim())return alert('Please fill in title and content.');
  var tpl={id:Date.now(),title:title,target:target,content:content};
  var tpls=S.templates.concat([tpl]);
  lsSet('templates',tpls);
  setState({templates:tpls,modal:''});
};
window.delTemplate=function(id){
  var tpls=S.templates.filter(function(t){return t.id!=id;});
  lsSet('templates',tpls);
  setState({templates:tpls});
};

render();
sync();

</script>
</body>
</html>
