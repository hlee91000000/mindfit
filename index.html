<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <title>Mindfit</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { color-scheme: light; }
    @media (prefers-color-scheme: dark) {
      html, body { background: #F4FBFA !important; color: #2D7060 !important; }
      .card, .card-warm, .stat-card, .modal-sheet { background: #fff !important; color: #2D7060 !important; }
      .btn-primary { background: #3BAA8C !important; color: #fff !important; }
      .btn-sage { background: #52C9A8 !important; color: #fff !important; }
      .header-gradient { background: linear-gradient(135deg, #3BAA8C 0%, #52C9A8 100%) !important; }
      .upcoming-meeting { background: linear-gradient(135deg, #3BAA8C, #52C9A8) !important; }
      input, textarea, select { background: #FAFEFE !important; color: #2D7060 !important; border-color: #B8E8DF !important; }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #F4FBFA !important; font-family: 'DM Sans', sans-serif; color: #2D7060; }
    button { cursor: pointer; font-family: 'DM Sans', sans-serif; border: none; background: none; }
    input, textarea, select { font-family: 'DM Sans', sans-serif; }
    .card { background: #fff; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04); }
    .card-warm { background: #FAFEFE; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); border: 1px solid #C8EDE6; }
    .btn-primary { background: #3BAA8C !important; color: #fff !important; border-radius: 14px; font-weight: 600; transition: all 0.15s; border: none; cursor: pointer; }
    .btn-sage { background: #52C9A8 !important; color: #fff !important; border-radius: 14px; font-weight: 600; transition: all 0.15s; border: none; cursor: pointer; }
    .btn-outline { background: transparent; border: 2px solid #3BAA8C; color: #3BAA8C; border-radius: 14px; font-weight: 600; transition: all 0.15s; cursor: pointer; }
    .btn-outline:hover { background: #3BAA8C; color: #fff; }
    .input-field { border: 1.5px solid #B8E8DF; border-radius: 12px; padding: 12px 16px; font-size: 15px; background: #FAFEFE !important; color: #2D7060 !important; width: 100%; outline: none; transition: border-color 0.15s; }
    .input-field:focus { border-color: #3BAA8C; }
    .tag-sage { background: #D4F2EB; color: #2D9078; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .tag-dark { background: #3BAA8C; color: #fff; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .tag-warm { background: #D4F2EB; color: #2D9078; border-radius: 20px; padding: 3px 12px; font-size: 12px; font-weight: 600; display: inline-block; }
    .header-gradient { background: linear-gradient(135deg, #3BAA8C 0%, #52C9A8 100%) !important; }
    .stat-card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(30,80,60,0.45); display: flex; align-items: flex-end; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
    .modal-sheet { background: #FAFEFE !important; border-radius: 24px 24px 0 0; width: 100%; max-width: 640px; max-height: 90vh; overflow-y: auto; padding: 28px 24px 40px; }
    .modal-handle { width: 36px; height: 4px; background: #B8E8DF; border-radius: 2px; margin: 0 auto 24px; }
    .feedback-bubble { background: #E8F8F4; border-radius: 14px; padding: 12px 16px; }
    .answer-bubble { background: #3BAA8C; border-radius: 14px; padding: 14px 18px; color: white; }
    .meal-type-active { background: #3BAA8C !important; color: white !important; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
    .meal-type { background: #D4F2EB !important; color: #2D9078 !important; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
    .energy-active { background: #52C9A8 !important; color: white !important; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; }
    .energy-btn { background: #D4F2EB !important; color: #2D9078 !important; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; }
    .mood-active { background: #D4F2EB !important; border-radius: 12px; transform: scale(1.1); border: none; cursor: pointer; }
    .mood-btn { background: #F4FBFA !important; border-radius: 12px; border: none; cursor: pointer; }
    .cat-active { background: #3BAA8C !important; color: white !important; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; }
    .cat-btn { background: #D4F2EB !important; color: #2D9078 !important; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; }
    .upcoming-meeting { background: linear-gradient(135deg, #3BAA8C, #52C9A8) !important; border-radius: 18px; color: white; padding: 20px; }
    .badge { background: #E05C5C; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; position: absolute; top: 6px; right: 2px; }
    ::-webkit-scrollbar { width: 0; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhfh02uDuFnpPzoLbtrFOO-lT1DvVzwrk2Zp2ZwZ8gFpejkCyfTT5-2I2h4Q2sJXU7wg/exec';

const CLOUDINARY_CLOUD = 'dblqwqgnz';
const CLOUDINARY_PRESET = 'mindfit_posts'; // CloudinaryÏóêÏÑú unsigned preset Ïù¥Î¶Ñ

const uploadImage = async (file) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', CLOUDINARY_PRESET);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, {
    method: 'POST',
    body: formData,
  });
  const data = await res.json();
  if (data.secure_url) return data.secure_url;
  throw new Error('Upload failed');
};

const apiCall = (tab, action, params = {}) => new Promise((resolve, reject) => {
  const cb = 'cb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  const url = new URL(SCRIPT_URL);
  url.searchParams.set('tab', tab);
  url.searchParams.set('action', action);
  url.searchParams.set('callback', cb);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, typeof v === 'object' ? JSON.stringify(v) : String(v)));
  const script = document.createElement('script');
  const timer = setTimeout(() => { cleanup(); reject(new Error('timeout')); }, 15000);
  const cleanup = () => { clearTimeout(timer); delete window[cb]; script.parentNode && script.parentNode.removeChild(script); };
  window[cb] = (data) => { cleanup(); resolve(data); };
  script.onerror = () => { cleanup(); reject(new Error('error')); };
  script.src = url.toString();
  document.head.appendChild(script);
});

const lsGet = (k) => { try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : []; } catch { return []; } };
const lsSet = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

// ‚îÄ‚îÄ SVG Icons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Ico = ({ d, size=20, color='currentColor' }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    {[].concat(d).map((p,i) => <path key={i} d={p}/>)}
  </svg>
);
const I = {
  Plus:    p => <Ico {...p} d="M12 5v14M5 12h14"/>,
  X:       p => <Ico {...p} d="M18 6L6 18M6 6l12 12"/>,
  Up:      p => <Ico {...p} d="M18 15l-6-6-6 6"/>,
  Down:    p => <Ico {...p} d="M6 9l6 6 6-6"/>,
  Send:    p => <Ico {...p} d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>,
  Check:   p => <Ico {...p} d="M20 6L9 17l-5-5"/>,
  Meal:    p => <Ico {...p} d={["M3 2v7c0 1.1.9 2 2 2h4a2 2 0 002-2V2","M7 2v20","M21 15V2a5 5 0 00-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"]}/>,
  Book:    p => <Ico {...p} d={["M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z","M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"]}/>,
  Chart:   p => <Ico {...p} d="M23 6l-9.5 9.5-5-5L1 18"/>,
  Msg:     p => <Ico {...p} d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>,
  Bell:    p => <Ico {...p} d={["M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9","M13.73 21a2 2 0 01-3.46 0"]}/>,
  Cal:     p => <Ico {...p} d={["M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2z","M16 2v4M8 2v4M3 10h18"]}/>,
  User:    p => <Ico {...p} d={["M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2","M12 11a4 4 0 100-8 4 4 0 000 8z"]}/>,
  Users:   p => <Ico {...p} d={["M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2","M23 21v-2a4 4 0 00-3-3.87","M16 3.13a4 4 0 010 7.75","M9 11a4 4 0 100-8 4 4 0 000 8z"]}/>,
  Pay:     p => <Ico {...p} d={["M21 4H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V6a2 2 0 00-2-2z","M1 10h22"]}/>,,
};

// ‚îÄ‚îÄ Modal (App Î∞ñÏóê ÏÑ†Ïñ∏ ‚Üí Î¶¨Î†åÎçîÎßÅ Ïïà Îê®) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Modal = ({ onClose, title, children }) => (
  <div className="modal-overlay" onClick={onClose}>
    <div className="modal-sheet" onClick={e => e.stopPropagation()}>
      <div className="modal-handle"/>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
        <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:26,color:'#2D9078'}}>{title}</h2>
        <button onClick={onClose} style={{color:'#52C9A8',padding:4}}><I.X size={22}/></button>
      </div>
      {children}
    </div>
  </div>
);

// ‚îÄ‚îÄ MealCard (App Î∞ñÏóê ÏÑ†Ïñ∏ ‚Üí Î¶¨Î†åÎçîÎßÅ Ïïà Îê®) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FULLNESS = ['','Still hungry','A little full','Just right','Pretty full','Very full'];

const MealCard = React.memo(({ meal, mode, isExpanded, onToggle, isSelectedMeal, onSelectMeal, onAddFeedback, onDelete, saving }) => {
  const feedbackRef = useRef('');
  const feedbackList = meal.feedback || [];
  return (
    <div style={{background: meal.isEmergency ? '#E8F8F4':'#fff', border: meal.isEmergency ? '1.5px solid #B8D4B9':'1.5px solid #C8EDE6', borderRadius:18, overflow:'hidden', marginBottom:10}}>
      <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:12,textAlign:'left',background:'none',border:'none'}} onClick={onToggle}>
        <div style={{flex:1,display:'flex',alignItems:'center',gap:10,minWidth:0}}>
          {meal.isEmergency ? <span className="tag-sage">Special Note</span> : <span className="tag-dark">{meal.mealType}</span>}
          <span style={{fontWeight:600,color:'#2D9078',fontSize:14,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{meal.clientName}</span>
          <span style={{color:'#5A9A8E',fontSize:13,flexShrink:0}}>{meal.time}</span>
          {feedbackList.length > 0 && <span style={{color:'#5A9A8E',fontSize:12,flexShrink:0}}>üí¨ {feedbackList.length}</span>}
        </div>
        {isExpanded ? <I.Up size={18} color="#52C9A8"/> : <I.Down size={18} color="#52C9A8"/>}
      </button>
      {isExpanded && (
        <div style={{padding:'0 18px 20px',borderTop:'1px solid #D4F2EB'}}>
          {mode === 'coach' && <div style={{display:'flex',justifyContent:'flex-end',paddingTop:12,marginBottom:8}}><button onClick={() => onDelete(meal.id)} style={{color:'#52C9A8'}}><I.X size={18}/></button></div>}
          <p style={{color:'#2D7060',lineHeight:1.6,marginTop:mode!=='coach'?14:0,marginBottom:12}}>
            {meal.isEmergency && meal.emergencyType && <span className="tag-warm" style={{marginRight:8,marginBottom:6,display:'inline-block'}}>{meal.emergencyType}</span>}
            {meal.foods}
          </p>
          {(meal.fullness || meal.satietyHours) && (
            <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap'}}>
              {meal.fullness && <span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'4px 12px',fontSize:12,fontWeight:600}}>üçΩÔ∏è {FULLNESS[meal.fullness] || meal.fullness}</span>}
              {meal.satietyHours && <span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'4px 12px',fontSize:12,fontWeight:600}}>‚è±Ô∏è {meal.satietyHours}</span>}
            </div>
          )}
          {feedbackList.length > 0 && (
            <div style={{marginBottom:12}}>
              {feedbackList.map((fb,i) => (
                <div key={i} className="feedback-bubble" style={{marginBottom:8}}>
                  <div style={{display:'flex',justifyContent:'space-between',marginBottom:4}}>
                    <span style={{fontSize:12,fontWeight:700,color:'#3BAA8C'}}>{fb.author}</span>
                    <span style={{fontSize:11,color:'#5A9A8E'}}>{fb.timestamp}</span>
                  </div>
                  <p style={{color:'#2D7060',fontSize:14}}>{fb.text}</p>
                </div>
              ))}
            </div>
          )}
          {mode === 'coach' && (isSelectedMeal ? (
            <div style={{display:'flex',gap:8,paddingTop:12,borderTop:'1px solid #D4F2EB'}}>
              <input defaultValue="" ref={feedbackRef} placeholder="Write feedback..." className="input-field" style={{flex:1}} onChange={e => { feedbackRef.current.value = e.target.value; }}/>
              <button onClick={() => onAddFeedback(meal.id, feedbackRef.current.value)} className="btn-sage" style={{padding:'10px 14px'}} disabled={saving}><I.Send size={16}/></button>
              <button onClick={() => onSelectMeal(null)} style={{color:'#52C9A8',padding:'10px'}}><I.X size={16}/></button>
            </div>
          ) : (
            <button onClick={() => onSelectMeal(meal.id)} style={{color:'#3BAA8C',fontWeight:600,fontSize:14,paddingTop:12,borderTop:'1px solid #D4F2EB',width:'100%',textAlign:'left',background:'none',border:'none',borderTop:'1px solid #D4F2EB'}}>+ Add Feedback</button>
          ))}
        </div>
      )}
    </div>
  );
});

// ‚îÄ‚îÄ MealForm (App Î∞ñ, useRefÎ°ú input Í¥ÄÎ¶¨) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MealForm = ({ onClose, onSubmit, saving, today }) => {
  const foodsRef = useRef(null);
  const [mealType, setMealType] = useState('Breakfast');
  const [fullness, setFullness] = useState('');
  const [satietyHours, setSatietyHours] = useState('');
  const [date, setDate] = useState(today);
  const [time, setTime] = useState(new Date().toTimeString().slice(0,5));

  const handleSubmit = () => {
    const foods = foodsRef.current ? foodsRef.current.value : '';
    if (!foods.trim()) return;
    onSubmit({ date, time, mealType, foods, fullness, satietyHours });
  };

  return (
    <Modal onClose={onClose} title="Log a Meal">
      <div style={{display:'flex',flexDirection:'column',gap:16}}>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Date</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="input-field"/></div>
          <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Time</label><input type="time" value={time} onChange={e=>setTime(e.target.value)} className="input-field"/></div>
        </div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>Meal Type</label>
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
            {['Breakfast','Lunch','Dinner','Snack'].map(t => <button key={t} onClick={()=>setMealType(t)} className={mealType===t?'meal-type-active':'meal-type'} style={{padding:'10px 4px',fontSize:13}}>{t}</button>)}
          </div>
        </div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>What did you eat?</label>
          <textarea ref={foodsRef} placeholder="Describe your meal..." className="input-field" rows={3} style={{resize:'none'}}/>
        </div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>How full did you feel after? üçΩÔ∏è</label>
          <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}>
            {[{v:'1',l:'Still hungry',e:'üò∂'},{v:'2',l:'A little full',e:'üôÇ'},{v:'3',l:'Just right',e:'üòä'},{v:'4',l:'Pretty full',e:'üòå'},{v:'5',l:'Very full',e:'ü§¢'}].map(o=>(
              <button key={o.v} onClick={()=>setFullness(o.v)} style={{padding:'10px 4px',background:fullness===o.v?'#3BAA8C':'#D4F2EB',color:fullness===o.v?'white':'#2D9078',borderRadius:12,border:'none',cursor:'pointer',fontSize:11,fontWeight:600,textAlign:'center'}}>
                <div style={{fontSize:20,marginBottom:4}}>{o.e}</div>{o.l}
              </button>
            ))}
          </div>
        </div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>How long did you stay full? ‚è±Ô∏è</label>
          <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8}}>
            {[{v:'1-2h',l:'1‚Äì2 hours'},{v:'2-3h',l:'2‚Äì3 hours'},{v:'3-4h',l:'3‚Äì4 hours'},{v:'4h+',l:'4+ hours'}].map(o=>(
              <button key={o.v} onClick={()=>setSatietyHours(o.v)} style={{padding:'12px 6px',background:satietyHours===o.v?'#52C9A8':'#D4F2EB',color:satietyHours===o.v?'white':'#2D9078',borderRadius:12,border:'none',cursor:'pointer',fontSize:12,fontWeight:600,textAlign:'center'}}>
                {o.l}
              </button>
            ))}
          </div>
        </div>
        <button onClick={handleSubmit} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Save Meal</button>
      </div>
    </Modal>
  );
};

// ‚îÄ‚îÄ JournalForm (App Î∞ñ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const JournalForm = ({ onClose, onSubmit, saving, today }) => {
  const feelingsRef = useRef(null);
  const notesRef = useRef(null);
  const [mood, setMood] = useState('');
  const [energy, setEnergy] = useState('');
  const [date, setDate] = useState(today);

  const handleSubmit = () => {
    const feelings = feelingsRef.current ? feelingsRef.current.value : '';
    const notes = notesRef.current ? notesRef.current.value : '';
    if (!feelings.trim()) return;
    onSubmit({ date, mood, energy, feelings, notes });
  };

  return (
    <Modal onClose={onClose} title="Daily Journal">
      <div style={{display:'flex',flexDirection:'column',gap:18}}>
        <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Date</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="input-field"/></div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:10}}>How did eating feel today?</label>
          <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}>
            {['üò¢','üòï','üòê','üôÇ','üòä'].map(e=><button key={e} onClick={()=>setMood(e)} className={mood===e?'mood-active':'mood-btn'} style={{padding:'12px 4px',fontSize:26,transition:'all 0.15s'}}>{e}</button>)}
          </div>
        </div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:10}}>Energy Level</label>
          <div style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}>
            {['1','2','3','4','5'].map(l=><button key={l} onClick={()=>setEnergy(l)} className={energy===l?'energy-active':'energy-btn'} style={{padding:'12px 4px',fontSize:16}}>{l}</button>)}
          </div>
          <p style={{fontSize:12,color:'#5A9A8E',marginTop:6,textAlign:'center'}}>1 = Very Low ¬∑ 5 = Very High</p>
        </div>
        <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>How are you feeling?</label><textarea ref={feelingsRef} placeholder="Share your thoughts, emotions..." className="input-field" rows={4} style={{resize:'none'}}/></div>
        <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Additional Notes</label><textarea ref={notesRef} placeholder="Anything else on your mind..." className="input-field" rows={3} style={{resize:'none'}}/></div>
        <button onClick={handleSubmit} className="btn-sage" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Save Journal</button>
      </div>
    </Modal>
  );
};

// ‚îÄ‚îÄ EmergencyForm (App Î∞ñ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EmergencyForm = ({ onClose, onSubmit, saving, today }) => {
  const notesRef = useRef(null);
  const [type, setType] = useState('Binge Eating');
  const [date, setDate] = useState(today);
  const [time, setTime] = useState(new Date().toTimeString().slice(0,5));

  const handleSubmit = () => {
    const notes = notesRef.current ? notesRef.current.value : '';
    onSubmit({ type, notes, date, time });
  };

  return (
    <Modal onClose={onClose} title="Special Note">
      <div style={{display:'flex',flexDirection:'column',gap:16}}>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Date</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="input-field"/></div>
          <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Time</label><input type="time" value={time} onChange={e=>setTime(e.target.value)} className="input-field"/></div>
        </div>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:10}}>What happened?</label>
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            {[{v:'Binge Eating',e:'üçî'},{v:'Purging',e:'ü§¢'},{v:'Meal Avoidance',e:'üò∞'}].map(t=>(
              <button key={t.v} onClick={()=>setType(t.v)} style={{padding:'14px 16px',background:type===t.v?'#D4F2EB':'#F4FBFA',border:type===t.v?'2px solid #3BAA8C':'2px solid transparent',borderRadius:14,fontWeight:600,fontSize:15,textAlign:'left',display:'flex',alignItems:'center',gap:10,cursor:'pointer',color:type===t.v?'#2D9078':'#5A9A8E'}}>
                <span style={{fontSize:22}}>{t.e}</span>{t.v}
              </button>
            ))}
          </div>
        </div>
        <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Notes (Optional)</label><textarea ref={notesRef} placeholder="How are you feeling? Any triggers?" className="input-field" rows={3} style={{resize:'none'}}/></div>
        <div style={{background:'#D4F2EB',borderRadius:14,padding:'14px 16px'}}>
          <p style={{color:'#2D9078',fontSize:14,lineHeight:1.6,textAlign:'center'}}>üåø It's okay that this happened. Every step of awareness is part of healing.</p>
        </div>
        <button onClick={handleSubmit} className="btn-sage" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Submit Report</button>
      </div>
    </Modal>
  );
};

// ‚îÄ‚îÄ InquiryForm (App Î∞ñ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const InquiryForm = ({ onClose, onSubmit, saving }) => {
  const questionRef = useRef(null);
  const [category, setCategory] = useState('Diet');

  const handleSubmit = () => {
    const question = questionRef.current ? questionRef.current.value : '';
    if (!question.trim()) return;
    onSubmit({ category, question });
  };

  return (
    <Modal onClose={onClose} title="New Question">
      <div style={{display:'flex',flexDirection:'column',gap:16}}>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>Category</label>
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:8}}>
            {['Diet','Exercise','Other'].map(c=><button key={c} onClick={()=>setCategory(c)} className={category===c?'cat-active':'cat-btn'} style={{padding:'12px',fontSize:14}}>{c}</button>)}
          </div>
        </div>
        <div><label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:6}}>Your Question</label><textarea ref={questionRef} placeholder="Ask your coach anything..." className="input-field" rows={5} style={{resize:'none'}}/></div>
        <button onClick={handleSubmit} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Send Question</button>
      </div>
    </Modal>
  );
};

// ‚îÄ‚îÄ PostForm (App Î∞ñ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PostForm = ({ onClose, onSubmit, saving }) => {
  const titleRef = useRef(null);
  const contentRef = useRef(null);
  const [imageUrl, setImageUrl] = useState('');
  const [uploading, setUploading] = useState(false);
  const [preview, setPreview] = useState('');

  const handleImageChange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setUploading(true);
    const localUrl = URL.createObjectURL(file);
    setPreview(localUrl);
    try {
      const url = await uploadImage(file);
      setImageUrl(url);
    } catch {
      alert('Image upload failed. Please try again.');
      setPreview('');
    }
    setUploading(false);
  };

  const handleSubmit = () => {
    const title = titleRef.current ? titleRef.current.value : '';
    const content = contentRef.current ? contentRef.current.value : '';
    if (!title.trim() || !content.trim()) return;
    onSubmit({ title, content, imageUrl });
  };

  return (
    <Modal onClose={onClose} title="New Post">
      <div style={{display:'flex',flexDirection:'column',gap:14}}>
        <input ref={titleRef} placeholder="Title" className="input-field" style={{fontWeight:600,fontSize:16}}/>
        <textarea ref={contentRef} placeholder="Write your announcement..." className="input-field" rows={6} style={{resize:'none'}}/>
        <div>
          <label style={{fontSize:13,fontWeight:600,color:'#2D9078',display:'block',marginBottom:8}}>Photo (Optional)</label>
          <label style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8,padding:'14px',background:'#E8F8F4',border:'1.5px dashed #3BAA8C',borderRadius:12,cursor:'pointer',color:'#2D9078',fontWeight:600,fontSize:14}}>
            {uploading ? '‚è≥ Uploading...' : imageUrl ? '‚úì Photo uploaded' : 'üì∑ Add Photo'}
            <input type="file" accept="image/*" onChange={handleImageChange} style={{display:'none'}}/>
          </label>
          {preview && <img src={preview} alt="preview" style={{width:'100%',borderRadius:12,marginTop:8,maxHeight:200,objectFit:'cover'}}/>}
        </div>
        <button onClick={handleSubmit} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving||uploading}>Publish</button>
      </div>
    </Modal>
  );
};

// ‚îÄ‚îÄ MeetingForm (App Î∞ñ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MeetingForm = ({ onClose, onSubmit, saving, today, isCoach }) => {
  const clientRef = useRef(null);
  const titleRef = useRef(null);
  const notesRef = useRef(null);
  const [date, setDate] = useState(today);
  const [time, setTime] = useState('');
  const handleSubmit = () => {
    const clientName = isCoach ? (clientRef.current ? clientRef.current.value : '') : null;
    const title = titleRef.current ? titleRef.current.value : '';
    const notes = notesRef.current ? notesRef.current.value : '';
    if (!title.trim() || !date || !time) return;
    onSubmit({ clientName, title, notes, date, time });
  };
  return (
    <Modal onClose={onClose} title="Schedule Meeting">
      <div style={{display:'flex',flexDirection:'column',gap:14}}>
        {isCoach && <input ref={clientRef} placeholder="Client Name" className="input-field" style={{fontWeight:600}}/>}
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
          <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="input-field"/>
          <input type="time" value={time} onChange={e=>setTime(e.target.value)} className="input-field"/>
        </div>
        <input ref={titleRef} placeholder="Meeting Title" className="input-field" style={{fontWeight:600}}/>
        <textarea ref={notesRef} placeholder="Notes (optional)" className="input-field" rows={3} style={{resize:'none'}}/>
        <button onClick={handleSubmit} className="btn-primary" style={{width:'100%',padding:'15px',fontSize:16}} disabled={saving}>Schedule</button>
      </div>
    </Modal>
  );
};

// ‚îÄ‚îÄ PayPal Button Ïª¥Ìè¨ÎÑåÌä∏ (App Î∞ñ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLANS = [
  { id: 'monthly', name: 'Monthly Plan', price: '150.00', currency: 'SGD', desc: 'Full coaching support for 1 month', emoji: 'üåø' },
  { id: 'quarterly', name: '3-Month Plan', price: '400.00', currency: 'SGD', desc: 'Best value ‚Äî save SGD 50', emoji: '‚≠ê' },
  { id: 'session', name: 'Single Session', price: '80.00', currency: 'SGD', desc: 'One-on-one coaching session', emoji: 'üí¨' },
];

const PAYPAL_CLIENT_ID = 'ARllutZeJShzQMPZMOwIX7vD8CRA4g-LBq9-DnTjHi5tn4H8qrfrgkT0LX_fcDnmiT3zktRdoNM6F-B1';

const loadPayPalScript = () => new Promise((resolve, reject) => {
  if (window.paypal) { resolve(); return; }
  const script = document.createElement('script');
  script.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=SGD&components=buttons`;
  script.onload = resolve;
  script.onerror = reject;
  document.body.appendChild(script);
});

const PayPalButton = ({ plan, onSuccess }) => {
  const containerRef = useRef(null);
  const rendered = useRef(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    if (rendered.current) return;
    rendered.current = true;
    loadPayPalScript().then(() => {
      setLoading(false);
      if (!containerRef.current) return;
      window.paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'pay', height: 48 },
        createOrder: (data, actions) => actions.order.create({
          purchase_units: [{ amount: { value: plan.price, currency_code: plan.currency }, description: plan.name }]
        }),
        onApprove: async (data, actions) => {
          const order = await actions.order.capture();
          onSuccess(order, plan);
        },
        onError: (err) => { console.error('PayPal error:', err); alert('Payment failed. Please try again.'); }
      }).render(containerRef.current);
    }).catch(() => { setLoading(false); setError('Failed to load PayPal. Please check your connection.'); });
  }, []);

  if (loading) return <div style={{textAlign:'center',padding:'16px',color:'#5A9A8E',fontSize:14}}>‚è≥ Loading PayPal...</div>;
  if (error) return <div style={{textAlign:'center',padding:'16px',color:'#E05C5C',fontSize:14}}>{error}</div>;
  return <div ref={containerRef} style={{marginTop:12}}/>;
};

const PaymentTab = ({ clientName, mode }) => {
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [paid, setPaid] = useState(null);

  const handleSuccess = (order, plan) => {
    setPaid({ order, plan, date: new Date().toLocaleString() });
    setSelectedPlan(null);
  };

  if (mode === 'coach') return (
    <div>
      <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58',marginBottom:8}}>Payment Plans</h2>
      <p style={{color:'#5A9A8E',fontSize:14,marginBottom:20}}>These are the plans shown to your clients.</p>
      {PLANS.map(plan => (
        <div key={plan.id} className="card" style={{padding:20,marginBottom:12}}>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <span style={{fontSize:32}}>{plan.emoji}</span>
            <div>
              <p style={{fontWeight:700,color:'#1A6B58',fontSize:16}}>{plan.name}</p>
              <p style={{color:'#3BAA8C',fontSize:20,fontWeight:700}}>SGD {plan.price}</p>
              <p style={{color:'#5A9A8E',fontSize:13}}>{plan.desc}</p>
            </div>
          </div>
        </div>
      ))}
    </div>
  );

  if (paid) return (
    <div style={{textAlign:'center',padding:'40px 20px'}}>
      <div style={{fontSize:64,marginBottom:16}}>üéâ</div>
      <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:28,color:'#1A6B58',marginBottom:8}}>Payment Successful!</h2>
      <p style={{color:'#5A9A8E',fontSize:15,marginBottom:8}}>{paid.plan.name} ‚Äî SGD {paid.plan.price}</p>
      <p style={{color:'#A8DDD5',fontSize:13,marginBottom:24}}>{paid.date}</p>
      <div style={{background:'#E8F8F4',borderRadius:16,padding:20,marginBottom:24}}>
        <p style={{color:'#2D9078',fontSize:14,lineHeight:1.7}}>üåø Thank you for your payment! Your coach will be in touch shortly to get started on your journey.</p>
      </div>
      <button onClick={()=>setPaid(null)} className="btn-outline" style={{padding:'12px 24px'}}>Back to Plans</button>
    </div>
  );

  return (
    <div>
      <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58',marginBottom:8}}>Payment</h2>
      <p style={{color:'#5A9A8E',fontSize:14,marginBottom:20}}>Choose a plan to get started with your coaching journey.</p>

      {PLANS.map(plan => (
        <div key={plan.id} onClick={()=>setSelectedPlan(selectedPlan?.id===plan.id?null:plan)}
          style={{background: selectedPlan?.id===plan.id?'#E8F8F4':'#fff', border: selectedPlan?.id===plan.id?'2px solid #3BAA8C':'1.5px solid #C8EDE6', borderRadius:18, padding:20, marginBottom:12, cursor:'pointer', transition:'all 0.2s'}}>
          <div style={{display:'flex',alignItems:'center',gap:12}}>
            <span style={{fontSize:32}}>{plan.emoji}</span>
            <div style={{flex:1}}>
              <p style={{fontWeight:700,color:'#1A6B58',fontSize:16}}>{plan.name}</p>
              <p style={{color:'#3BAA8C',fontSize:20,fontWeight:700}}>SGD {plan.price}</p>
              <p style={{color:'#5A9A8E',fontSize:13}}>{plan.desc}</p>
            </div>
            {selectedPlan?.id===plan.id && <span style={{color:'#3BAA8C',fontSize:20}}>‚úì</span>}
          </div>
          {selectedPlan?.id===plan.id && (
            <div onClick={e=>e.stopPropagation()} style={{marginTop:16,borderTop:'1px solid #D4F2EB',paddingTop:16}}>
              <p style={{color:'#5A9A8E',fontSize:13,marginBottom:12,textAlign:'center'}}>Complete your payment with PayPal</p>
              <PayPalButton plan={plan} onSuccess={handleSuccess}/>
            </div>
          )}
        </div>
      ))}

      <div style={{background:'#F4FBFA',borderRadius:14,padding:16,marginTop:8}}>
        <p style={{color:'#5A9A8E',fontSize:13,textAlign:'center',lineHeight:1.6}}>üîí Secure payment via PayPal ¬∑ All major cards accepted</p>
      </div>
    </div>
  );
};

// ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App() {
  const [mode, setMode] = useState('client');
  const [coachPw, setCoachPw] = useState('');
  const [showCoachModal, setShowCoachModal] = useState(false);
  const [clientName, setClientName] = useState(() => localStorage.getItem('clientName') || '');
  const [tempName, setTempName] = useState('');
  const [tempPw, setTempPw] = useState('');
  const [clientPw, setClientPw] = useState('');
  const [showChangePwModal, setShowChangePwModal] = useState(false);
  const [meals, setMeals] = useState(() => lsGet('meals'));
  const [posts, setPosts] = useState(() => lsGet('posts'));
  const [meetings, setMeetings] = useState(() => lsGet('meetings'));
  const [journals, setJournals] = useState(() => lsGet('journals'));
  const [inquiries, setInquiries] = useState(() => lsGet('inquiries'));
  const [activeTab, setActiveTab] = useState('meals');
  const [selectedClient, setSelectedClient] = useState('all');
  const [filterType, setFilterType] = useState('all');
  const [showMealForm, setShowMealForm] = useState(false);
  const [showEmForm, setShowEmForm] = useState(false);
  const [showJrnForm, setShowJrnForm] = useState(false);
  const [showPostForm, setShowPostForm] = useState(false);
  const [showMtgForm, setShowMtgForm] = useState(false);
  const [showInqForm, setShowInqForm] = useState(false);
  const [expandedMeals, setExpandedMeals] = useState({});
  const [expandedJournals, setExpandedJournals] = useState({});
  const [expandedDates, setExpandedDates] = useState({});
  const [expandedInq, setExpandedInq] = useState({});
  const [selectedMeal, setSelectedMeal] = useState(null);
  const [answerText, setAnswerText] = useState('');
  const [answeringId, setAnsweringId] = useState(null);
  const [saving, setSaving] = useState(false);
  const [syncMsg, setSyncMsg] = useState('');
  const today = new Date().toISOString().split('T')[0];
  const todayLabel = new Date().toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric'});

  const syncFromSheets = async () => {
    setSyncMsg('Syncing...');
    try {
      const [m,p,mt,j,inq] = await Promise.all([
        apiCall('meals','getAll'), apiCall('posts','getAll'),
        apiCall('meetings','getAll'), apiCall('journals','getAll'),
        apiCall('inquiries','getAll'),
      ]);
      if (m?.data) { const d = m.data.map(r=>({...r,feedback:r.feedback?(typeof r.feedback==='string'?JSON.parse(r.feedback):r.feedback):[],isEmergency:r.isEmergency==='TRUE'||r.isEmergency===true})).reverse(); setMeals(d); lsSet('meals',d); }
      if (p?.data) { const d=p.data.reverse(); setPosts(d); lsSet('posts',d); }
      if (mt?.data) { const d=mt.data.sort((a,b)=>new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time)); setMeetings(d); lsSet('meetings',d); }
      if (j?.data) { const d=j.data.reverse(); setJournals(d); lsSet('journals',d); }
      if (inq?.data) { const d=inq.data.map(r=>({...r,resolved:r.resolved==='TRUE'||r.resolved===true})).reverse(); setInquiries(d); lsSet('inquiries',d); }
      setSyncMsg('‚úì Synced');
    } catch { setSyncMsg('Sync failed'); }
    setTimeout(()=>setSyncMsg(''), 3000);
  };

  useEffect(() => { syncFromSheets(); }, []);

  const clients = [...new Set(meals.map(m=>m.clientName).filter(Boolean))];

  const filteredMeals = meals.filter(m => {
    const cm = mode==='coach' ? (selectedClient==='all'||m.clientName===selectedClient) : m.clientName===clientName;
    return cm && (filterType==='all'||m.mealType===filterType);
  });
  const todayMeals = filteredMeals.filter(m=>m.date===today);
  const mealsByDate = filteredMeals.reduce((acc,m)=>{ if(!acc[m.date])acc[m.date]=[]; acc[m.date].push(m); return acc; },{});
  const sortedDates = Object.keys(mealsByDate).sort((a,b)=>new Date(b)-new Date(a));
  const filteredMeetings = meetings.filter(m=>mode==='coach'?(selectedClient==='all'||m.clientName===selectedClient):m.clientName===clientName);
  const now = new Date();
  const pastMeetings = filteredMeetings.filter(m=>new Date(m.date+' '+m.time)<now).sort((a,b)=>new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time));
  const upcomingMeetings = filteredMeetings.filter(m=>new Date(m.date+' '+m.time)>=now);
  const relevantMeals = mode==='coach'?(selectedClient==='all'?meals:meals.filter(m=>m.clientName===selectedClient)):meals.filter(m=>m.clientName===clientName);
  const relevantJournals = mode==='coach'?(selectedClient==='all'?journals:journals.filter(j=>j.clientName===selectedClient)):journals.filter(j=>j.clientName===clientName);
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
  const stats = {
    weekMeals: relevantMeals.filter(m=>new Date(m.date)>=weekAgo&&!m.isEmergency).length,
    specialNotes: relevantMeals.filter(m=>m.isEmergency).length,
    journalEntries: relevantJournals.length,
    withFeedback: relevantMeals.filter(m=>(m.feedback||[]).length>0).length,
    totalClients: clients.length,
  };
  const filteredInq = mode==='coach'?(selectedClient==='all'?inquiries:inquiries.filter(i=>i.clientName===selectedClient)):inquiries.filter(i=>i.clientName===clientName);
  const unresolvedCount = filteredInq.filter(i=>!i.resolved && !i.answer).length;

  // Handlers
  const signup = () => {
    if(!tempName.trim()||!tempPw.trim()) return;
    setClientName(tempName.trim());
    localStorage.setItem('clientName',tempName.trim());
    localStorage.setItem('clientPw',tempPw.trim());
    setTempName(''); setTempPw('');
  };
  const verifyChangePw = () => {
    if(clientPw===localStorage.getItem('clientPw')) {
      setClientName(''); setClientPw('');
      localStorage.removeItem('clientName'); localStorage.removeItem('clientPw');
      setShowChangePwModal(false);
    } else { alert('Incorrect password'); setClientPw(''); }
  };
  const verifyCoach = () => {
    if(coachPw==='9324') { setMode('coach'); setShowCoachModal(false); setCoachPw(''); }
    else { alert('Incorrect password'); setCoachPw(''); }
  };

  const submitMeal = async ({date,time,mealType,foods,fullness,satietyHours}) => {
    setSaving(true);
    const row = {id:Date.now(),clientName,date,time,mealType,foods,fullness,satietyHours,emergencyType:'',feedback:'[]',isEmergency:false,timestamp:new Date().toLocaleString()};
    try { await apiCall('meals','append',{row}); } catch{}
    const nm = [{...row,feedback:[]}, ...meals]; setMeals(nm); lsSet('meals',nm);
    setShowMealForm(false); setSaving(false);
  };
  const submitEmergency = async ({type,notes,date,time}) => {
    setSaving(true);
    const row = {id:Date.now(),clientName,date,time,mealType:'Emergency',foods:notes||type,emergencyType:type,fullness:'',satietyHours:'',feedback:'[]',isEmergency:true,timestamp:new Date().toLocaleString()};
    try { await apiCall('meals','append',{row}); } catch{}
    const nm = [{...row,feedback:[]}, ...meals]; setMeals(nm); lsSet('meals',nm);
    setShowEmForm(false); setSaving(false);
  };
  const submitJournal = async ({date,mood,energy,feelings,notes}) => {
    setSaving(true);
    const row = {id:Date.now(),clientName,date,mood,energy,feelings,notes,timestamp:new Date().toLocaleString()};
    try { await apiCall('journals','append',{row}); } catch{}
    const nj = [row,...journals]; setJournals(nj); lsSet('journals',nj);
    setShowJrnForm(false); setSaving(false);
  };
  const submitPost = async ({title,content,imageUrl}) => {
    setSaving(true);
    const row = {id:Date.now(),title,content,imageUrl:imageUrl||'',date:new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})};
    try { await apiCall('posts','append',{row}); } catch{}
    const np = [row,...posts]; setPosts(np); lsSet('posts',np);
    setShowPostForm(false); setSaving(false);
  };
  const submitMeeting = async ({clientName:cn,title,notes,date,time}) => {
    setSaving(true);
    const name = mode==='coach' ? cn : clientName;
    const row = {id:Date.now(),clientName:name,date,time,title,notes};
    try { await apiCall('meetings','append',{row}); } catch{}
    const nm = [...meetings,row].sort((a,b)=>new Date(a.date+' '+a.time)-new Date(b.date+' '+b.time));
    setMeetings(nm); lsSet('meetings',nm);
    setShowMtgForm(false); setSaving(false);
  };
  const submitInquiry = async ({category,question}) => {
    setSaving(true);
    const row = {id:Date.now(),clientName,category,question,answer:'',resolved:false,date:today,timestamp:new Date().toLocaleString()};
    try { await apiCall('inquiries','append',{row}); } catch{}
    const ni = [row,...inquiries]; setInquiries(ni); lsSet('inquiries',ni);
    setShowInqForm(false); setSaving(false);
  };
  const submitAnswer = async (id) => {
    if(!answerText.trim()) return;
    setSaving(true);
    try { await apiCall('inquiries','update',{id,row:{answer:answerText}}); } catch{}
    const u = inquiries.map(i=>i.id==id?{...i,answer:answerText}:i);
    setInquiries(u); lsSet('inquiries',u);
    setAnswerText(''); setAnsweringId(null); setSaving(false);
  };
  const toggleResolved = async (id) => {
    const inq = inquiries.find(i=>i.id==id);
    const nv = !inq.resolved;
    try { await apiCall('inquiries','update',{id,row:{resolved:nv}}); } catch{}
    const u = inquiries.map(i=>i.id==id?{...i,resolved:nv}:i);
    setInquiries(u); lsSet('inquiries',u);
  };
  const addFeedback = async (mealId, text) => {
    if(!text.trim()) return;
    setSaving(true);
    const meal = meals.find(m=>m.id==mealId);
    const fb = [...(meal.feedback||[]),{id:Date.now(),text,timestamp:new Date().toLocaleString(),author:'Coach'}];
    try { await apiCall('meals','update',{id:mealId,row:{feedback:JSON.stringify(fb)}}); } catch{}
    const u = meals.map(m=>m.id==mealId?{...m,feedback:fb}:m);
    setMeals(u); lsSet('meals',u);
    setSelectedMeal(null); setSaving(false);
  };
  const deleteMeal = async (id) => { try{await apiCall('meals','delete',{id});}catch{} const u=meals.filter(m=>m.id!=id); setMeals(u); lsSet('meals',u); };
  const deletePost = async (id) => { try{await apiCall('posts','delete',{id});}catch{} const u=posts.filter(p=>p.id!=id); setPosts(u); lsSet('posts',u); };
  const deleteMeeting = async (id) => { try{await apiCall('meetings','delete',{id});}catch{} const u=meetings.filter(m=>m.id!=id); setMeetings(u); lsSet('meetings',u); };
  const deleteInquiry = async (id) => { try{await apiCall('inquiries','delete',{id});}catch{} const u=inquiries.filter(i=>i.id!=id); setInquiries(u); lsSet('inquiries',u); };

  const tabs = [
    {id:'meals',Icon:I.Meal,label:'Meals'},
    {id:'journal',Icon:I.Book,label:'Journal'},
    {id:'stats',Icon:I.Chart,label:'Stats'},
    {id:'inquiries',Icon:I.Msg,label:'Q&A'},
    {id:'posts',Icon:I.Bell,label:mode==='client'?'Notice':'Posts'},
    {id:'meetings',Icon:I.Cal,label:'Meetings'},
    {id:'payment',Icon:I.Pay,label:'Payment'},
  ];

  return (
    <div style={{background:'#F4FBFA',minHeight:'100vh'}}>
      {saving && <div style={{position:'fixed',top:0,left:0,right:0,zIndex:100,background:'#3BAA8C',color:'white',textAlign:'center',padding:'8px',fontSize:13,fontWeight:600}}>Saving...</div>}

      {/* Coach PW Modal */}
      {showCoachModal && (
        <div className="modal-overlay" onClick={()=>{setShowCoachModal(false);setCoachPw('');}}>
          <div className="modal-sheet" onClick={e=>e.stopPropagation()}>
            <div className="modal-handle"/>
            <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:26,color:'#2D9078',marginBottom:8}}>Coach Access</h2>
            <p style={{color:'#5A9A8E',marginBottom:24,fontSize:15}}>Enter your password to continue</p>
            <input type="password" value={coachPw} onChange={e=>setCoachPw(e.target.value)} onKeyDown={e=>e.key==='Enter'&&verifyCoach()} className="input-field" placeholder="Password" autoFocus style={{marginBottom:16}}/>
            <div style={{display:'flex',gap:10}}>
              <button onClick={verifyCoach} className="btn-primary" style={{flex:1,padding:'14px'}}>Enter</button>
              <button onClick={()=>{setShowCoachModal(false);setCoachPw('');}} className="btn-outline" style={{flex:1,padding:'14px'}}>Cancel</button>
            </div>
          </div>
        </div>
      )}

      {/* Change Name Modal */}
      {showChangePwModal && (
        <div className="modal-overlay" onClick={()=>{setShowChangePwModal(false);setClientPw('');}}>
          <div className="modal-sheet" onClick={e=>e.stopPropagation()}>
            <div className="modal-handle"/>
            <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:26,color:'#2D9078',marginBottom:8}}>Verify Identity</h2>
            <p style={{color:'#5A9A8E',marginBottom:24,fontSize:15}}>Enter your password to change name</p>
            <input type="password" value={clientPw} onChange={e=>setClientPw(e.target.value)} onKeyDown={e=>e.key==='Enter'&&verifyChangePw()} className="input-field" placeholder="Your Password" autoFocus style={{marginBottom:16}}/>
            <div style={{display:'flex',gap:10}}>
              <button onClick={verifyChangePw} className="btn-primary" style={{flex:1,padding:'14px'}}>Verify</button>
              <button onClick={()=>{setShowChangePwModal(false);setClientPw('');}} className="btn-outline" style={{flex:1,padding:'14px'}}>Cancel</button>
            </div>
          </div>
        </div>
      )}

      {/* Form Modals */}
      {showMealForm && <MealForm onClose={()=>setShowMealForm(false)} onSubmit={submitMeal} saving={saving} today={today}/>}
      {showJrnForm && <JournalForm onClose={()=>setShowJrnForm(false)} onSubmit={submitJournal} saving={saving} today={today}/>}
      {showEmForm && <EmergencyForm onClose={()=>setShowEmForm(false)} onSubmit={submitEmergency} saving={saving} today={today}/>}
      {showInqForm && <InquiryForm onClose={()=>setShowInqForm(false)} onSubmit={submitInquiry} saving={saving}/>}
      {showPostForm && <PostForm onClose={()=>setShowPostForm(false)} onSubmit={submitPost} saving={saving}/>}
      {showMtgForm && <MeetingForm onClose={()=>setShowMtgForm(false)} onSubmit={submitMeeting} saving={saving} today={today} isCoach={mode==='coach'}/>}

      {/* Header */}
      <div className="header-gradient" style={{padding:'20px 20px 0'}}>
        <div style={{maxWidth:640,margin:'0 auto'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:20}}>
            <div>
              <h1 style={{fontFamily:'DM Serif Display,serif',fontSize:32,color:'#fff',letterSpacing:'-0.5px'}}>Mindfit</h1>
              <p style={{color:'rgba(255,255,255,0.85)',fontSize:13,marginTop:2}}>Your Journey with Mindfit</p>
            </div>
            <div style={{display:'flex',gap:8,alignItems:'center'}}>
              {syncMsg && <span style={{fontSize:12,color:'rgba(255,255,255,0.9)',fontWeight:600}}>{syncMsg}</span>}
              <button onClick={syncFromSheets} style={{background:'rgba(255,255,255,0.2)',border:'1px solid rgba(255,255,255,0.3)',borderRadius:10,padding:'6px 10px',color:'#fff',fontSize:12,fontWeight:600}}>Sync</button>
              <button onClick={()=>mode==='coach'?setMode('client'):setShowCoachModal(true)} style={{background:'rgba(255,255,255,0.25)',border:'1px solid rgba(255,255,255,0.4)',borderRadius:10,padding:'8px 12px',color:'#fff'}}>
                {mode==='coach'?<I.User size={16} color="#fff"/>:<I.Users size={16} color="#fff"/>}
              </button>
            </div>
          </div>

          {mode==='coach' && clients.length>0 && (
            <div style={{marginBottom:16}}>
              <select value={selectedClient} onChange={e=>setSelectedClient(e.target.value)} style={{width:'100%',padding:'10px 14px',background:'rgba(255,255,255,0.2)',border:'1px solid rgba(255,255,255,0.3)',borderRadius:12,color:'#fff',fontSize:14,outline:'none'}}>
                <option value="all" style={{color:'#333'}}>All Clients ({clients.length})</option>
                {clients.map(c=><option key={c} value={c} style={{color:'#333'}}>{c}</option>)}
              </select>
            </div>
          )}

          {mode==='client' && !clientName && (
            <div style={{background:'rgba(255,255,255,0.15)',borderRadius:18,padding:20,marginBottom:16,border:'1px solid rgba(255,255,255,0.2)'}}>
              <p style={{color:'#fff',fontWeight:600,marginBottom:14,fontFamily:'DM Serif Display,serif',fontSize:18}}>Welcome! Let's get started.</p>
              <div style={{display:'flex',flexDirection:'column',gap:10}}>
                <input value={tempName} onChange={e=>setTempName(e.target.value)} placeholder="Your Name" style={{width:'100%',padding:'12px 14px',background:'rgba(255,255,255,0.92)',border:'none',borderRadius:12,fontSize:15,outline:'none',color:'#2D7060'}}/>
                <input type="password" value={tempPw} onChange={e=>setTempPw(e.target.value)} onKeyDown={e=>e.key==='Enter'&&signup()} placeholder="Set a Password" style={{width:'100%',padding:'12px 14px',background:'rgba(255,255,255,0.92)',border:'none',borderRadius:12,fontSize:15,outline:'none',color:'#2D7060'}}/>
                <button onClick={signup} style={{width:'100%',padding:'13px',background:'rgba(255,255,255,0.95)',color:'#3BAA8C',border:'none',borderRadius:12,fontWeight:700,fontSize:15,cursor:'pointer'}}>Start My Journey</button>
              </div>
            </div>
          )}

          {mode==='client' && clientName && (
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',background:'rgba(255,255,255,0.2)',borderRadius:12,padding:'10px 14px',marginBottom:16}}>
              <div style={{display:'flex',alignItems:'center',gap:8}}>
                <div style={{width:32,height:32,background:'rgba(255,255,255,0.3)',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:700,fontSize:14}}>{clientName[0]?.toUpperCase()}</div>
                <span style={{color:'#fff',fontWeight:600,fontSize:15}}>{clientName}</span>
              </div>
              <button onClick={()=>setShowChangePwModal(true)} style={{color:'#fff',fontSize:13,fontWeight:600,background:'none',border:'none',cursor:'pointer'}}>Change</button>
            </div>
          )}

          <div style={{display:'flex',overflowX:'auto'}}>
            {tabs.map(tab=>(
              <button key={tab.id} onClick={()=>setActiveTab(tab.id)} style={{position:'relative',display:'flex',flexDirection:'column',alignItems:'center',gap:4,padding:'10px 14px 14px',background:'none',border:'none',borderBottom:activeTab===tab.id?'2.5px solid #fff':'2.5px solid transparent',color:activeTab===tab.id?'#fff':'rgba(255,255,255,0.55)',cursor:'pointer',whiteSpace:'nowrap',transition:'all 0.15s',minWidth:60}}>
                <tab.Icon size={18} color={activeTab===tab.id?'#fff':'rgba(255,255,255,0.55)'}/>
                <span style={{fontSize:11,fontWeight:600}}>{tab.label}</span>
                {tab.id==='inquiries'&&unresolvedCount>0&&<span className="badge">{unresolvedCount}</span>}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Content */}
      <div style={{maxWidth:640,margin:'0 auto',padding:'20px 16px 100px'}}>

        {/* MEALS */}
        {activeTab==='meals' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
              <div>
                <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>Today's Meals</h2>
                <p style={{color:'#5A9A8E',fontSize:13,marginTop:2}}>{todayLabel}</p>
              </div>
              <select value={filterType} onChange={e=>setFilterType(e.target.value)} style={{padding:'8px 12px',border:'1.5px solid #C8EDE6',borderRadius:10,fontSize:13,background:'#fff',color:'#2D9078',outline:'none'}}>
                <option value="all">All</option>
                {['Breakfast','Lunch','Dinner','Snack'].map(t=><option key={t} value={t}>{t}</option>)}
              </select>
            </div>
            {mode==='client'&&clientName&&(
              <div style={{display:'flex',flexDirection:'column',gap:10,marginBottom:24}}>
                <button onClick={()=>setShowMealForm(true)} style={{width:'100%',padding:'18px',background:'#3BAA8C',color:'#fff',border:'none',borderRadius:16,fontWeight:600,fontSize:16,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
                  <I.Plus size={20} color="#fff"/> Log a Meal
                </button>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                  <button onClick={()=>setShowJrnForm(true)} style={{padding:'16px',background:'#fff',border:'1.5px solid #C8EDE6',borderRadius:16,fontWeight:600,fontSize:14,cursor:'pointer',color:'#2D9078',display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
                    <I.Book size={18} color="#3BAA8C"/> Daily Journal
                  </button>
                  <button onClick={()=>setShowEmForm(true)} style={{padding:'16px',background:'#E8F8F4',border:'1.5px solid #B8D4B9',borderRadius:16,fontWeight:600,fontSize:14,cursor:'pointer',color:'#3BAA8C',display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
                    Special Note
                  </button>
                </div>
              </div>
            )}
            {todayMeals.length===0 ? (
              <div className="card" style={{padding:40,textAlign:'center'}}>
                <div style={{fontSize:48,marginBottom:12}}>üçΩÔ∏è</div>
                <p style={{color:'#5A9A8E',fontWeight:600,fontSize:16}}>No meals logged today</p>
                <p style={{color:'#A8DDD5',fontSize:14,marginTop:6}}>Past records are in the Stats tab</p>
              </div>
            ) : todayMeals.map(meal=>(
              <MealCard key={meal.id} meal={meal} mode={mode}
                isExpanded={!!expandedMeals[meal.id]}
                onToggle={()=>setExpandedMeals(p=>({...p,[meal.id]:!p[meal.id]}))}
                isSelectedMeal={selectedMeal==meal.id}
                onSelectMeal={setSelectedMeal}
                onAddFeedback={addFeedback}
                onDelete={deleteMeal}
                saving={saving}
              />
            ))}
          </div>
        )}

        {/* JOURNAL */}
        {activeTab==='journal' && (
          <div>
            <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58',marginBottom:20}}>Journal</h2>
            {relevantJournals.length===0 ? (
              <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üìî</div><p style={{color:'#5A9A8E',fontWeight:600,fontSize:16}}>No journal entries yet</p></div>
            ) : relevantJournals.map(j=>{
              const exp = expandedJournals[j.id];
              return (
                <div key={j.id} className="card-warm" style={{marginBottom:10,overflow:'hidden'}}>
                  <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:12,textAlign:'left',background:'none',border:'none'}} onClick={()=>setExpandedJournals(p=>({...p,[j.id]:!p[j.id]}))}>
                    <span style={{fontSize:28}}>{j.mood||'üìî'}</span>
                    <div style={{flex:1}}>
                      <p style={{fontWeight:600,color:'#2D9078',fontSize:15}}>{j.date}</p>
                      <p style={{color:'#5A9A8E',fontSize:13}}>{j.clientName}</p>
                    </div>
                    {j.energy&&<span style={{fontSize:13,color:'#3BAA8C',fontWeight:700}}>‚ö° {j.energy}/5</span>}
                    {exp?<I.Up size={18} color="#52C9A8"/>:<I.Down size={18} color="#52C9A8"/>}
                  </button>
                  {exp&&(
                    <div style={{padding:'0 18px 18px',borderTop:'1px solid #D4F2EB'}}>
                      <div style={{background:'#E8F8F4',borderRadius:12,padding:'12px 14px',marginTop:14,marginBottom:10}}>
                        <p style={{fontSize:11,fontWeight:700,color:'#5A9A8E',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.05em'}}>Feelings</p>
                        <p style={{color:'#2D7060',lineHeight:1.6,fontSize:14}}>{j.feelings}</p>
                      </div>
                      {j.notes&&<p style={{color:'#5A9A8E',fontSize:14,lineHeight:1.5}}>{j.notes}</p>}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* STATS */}
        {activeTab==='stats' && (
          <div>
            <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58',marginBottom:20}}>Progress</h2>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:24}}>
              {mode==='coach'&&selectedClient==='all'&&(
                <div className="stat-card" style={{gridColumn:'span 2',background:'linear-gradient(135deg,#3BAA8C,#52C9A8)',color:'white'}}>
                  <p style={{fontSize:40,fontWeight:700,fontFamily:'DM Serif Display,serif'}}>{stats.totalClients}</p>
                  <p style={{opacity:0.85,fontSize:13,marginTop:4,fontWeight:600}}>Total Clients</p>
                </div>
              )}
              {[{v:stats.weekMeals,l:'Meals This Week',i:'üçΩÔ∏è'},{v:stats.specialNotes,l:'Special Notes',i:'üìã'},{v:stats.journalEntries,l:'Journal Entries',i:'üìî'},{v:stats.withFeedback,l:'With Feedback',i:'üí¨'}].map((s,i)=>(
                <div key={i} className="stat-card">
                  <p style={{fontSize:13,marginBottom:8}}>{s.i}</p>
                  <p style={{fontSize:32,fontWeight:700,color:'#1A6B58',fontFamily:'DM Serif Display,serif'}}>{s.v}</p>
                  <p style={{color:'#4A8A7E',fontSize:13,fontWeight:600,marginTop:4}}>{s.l}</p>
                </div>
              ))}
            </div>
            <h3 style={{fontWeight:700,color:'#1A6B58',fontSize:17,marginBottom:14}}>All Records</h3>
            {sortedDates.length===0 ? (
              <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:40,marginBottom:12}}>üìä</div><p style={{color:'#5A9A8E',fontWeight:600}}>No records yet</p></div>
            ) : sortedDates.map(date=>{
              const dm = mealsByDate[date];
              const exp = expandedDates[date];
              return (
                <div key={date} className="card-warm" style={{marginBottom:10,overflow:'hidden'}}>
                  <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:10,textAlign:'left',background:'none',border:'none'}} onClick={()=>setExpandedDates(p=>({...p,[date]:!p[date]}))}>
                    <div style={{flex:1,display:'flex',alignItems:'center',gap:8}}>
                      <span style={{fontWeight:700,color:'#1A6B58',fontSize:15}}>{date}</span>
                      <span style={{color:'#4A8A7E',fontSize:13,fontWeight:600}}>{dm.length} meals</span>
                      {dm.some(m=>m.isEmergency)&&<span className="tag-sage" style={{fontSize:11}}>Special</span>}
                      {date===today&&<span className="tag-dark" style={{fontSize:11}}>Today</span>}
                    </div>
                    {exp?<I.Up size={16} color="#52C9A8"/>:<I.Down size={16} color="#52C9A8"/>}
                  </button>
                  {exp&&(
                    <div style={{borderTop:'1px solid #D4F2EB'}}>
                      {dm.map((meal,i)=>(
                        <div key={meal.id} style={{padding:'12px 18px',borderBottom:i<dm.length-1?'1px solid #D4F2EB':'none'}}>
                          <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:6}}>
                            {meal.isEmergency?<span className="tag-sage" style={{fontSize:11}}>Special</span>:<span className="tag-dark" style={{fontSize:11}}>{meal.mealType}</span>}
                            <span style={{color:'#5A9A8E',fontSize:12}}>{meal.time}</span>
                            {mode==='coach'&&<span style={{color:'#3BAA8C',fontSize:12,fontWeight:600}}>{meal.clientName}</span>}
                          </div>
                          <p style={{color:'#2D7060',fontSize:14,lineHeight:1.5}}>{meal.foods}</p>
                          {(meal.fullness||meal.satietyHours)&&(
                            <div style={{display:'flex',gap:6,marginTop:6,flexWrap:'wrap'}}>
                              {meal.fullness&&<span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'3px 10px',fontSize:11,fontWeight:600}}>üçΩÔ∏è {FULLNESS[meal.fullness]||meal.fullness}</span>}
                              {meal.satietyHours&&<span style={{background:'#D4F2EB',color:'#2D9078',borderRadius:20,padding:'3px 10px',fontSize:11,fontWeight:600}}>‚è±Ô∏è {meal.satietyHours}</span>}
                            </div>
                          )}
                          {(meal.feedback||[]).map((fb,fi)=><p key={fi} style={{color:'#3BAA8C',fontSize:13,marginTop:4}}>üí¨ {fb.text}</p>)}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* Q&A */}
        {activeTab==='inquiries' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
              <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>Q&A</h2>
              {mode==='client'&&clientName&&<button onClick={()=>setShowInqForm(true)} className="btn-primary" style={{padding:'10px 18px',fontSize:14,display:'flex',alignItems:'center',gap:6}}><I.Plus size={16} color="#fff"/> New Question</button>}
            </div>
            {filteredInq.length===0 ? (
              <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üí¨</div><p style={{color:'#5A9A8E',fontWeight:600,fontSize:16}}>No inquiries yet</p><p style={{color:'#A8DDD5',fontSize:14,marginTop:6}}>Ask your coach anything!</p></div>
            ) : filteredInq.map(inq=>{
              const exp = expandedInq[inq.id];
              const bc = inq.resolved?'#52C9A8':inq.answer?'#3BAA8C':'#F0B86E';
              return (
                <div key={inq.id} style={{background:inq.resolved?'#F4FBFA':'#fff',border:'1.5px solid #C8EDE6',borderLeft:`4px solid ${bc}`,borderRadius:16,marginBottom:10,overflow:'hidden',opacity:inq.resolved?0.8:1}}>
                  <button style={{width:'100%',padding:'14px 18px',display:'flex',alignItems:'center',gap:10,textAlign:'left',background:'none',border:'none'}} onClick={()=>setExpandedInq(p=>({...p,[inq.id]:!p[inq.id]}))}>
                    <div style={{flex:1,display:'flex',alignItems:'center',gap:8,minWidth:0}}>
                      <span className="tag-sage" style={{fontSize:11,flexShrink:0}}>{inq.category}</span>
                      <span style={{fontWeight:500,color:'#2D7060',fontSize:14,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{inq.question}</span>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:6,flexShrink:0}}>
                      {inq.resolved?<I.Check size={16} color="#3BAA8C"/>:!inq.answer?<span style={{fontSize:11,color:'#C8963E',fontWeight:600,background:'#FEF3E2',padding:'2px 8px',borderRadius:10}}>Pending</span>:<span style={{fontSize:11,color:'#2D9078',fontWeight:600,background:'#D4F2EB',padding:'2px 8px',borderRadius:10}}>Answered</span>}
                      {exp?<I.Up size={16} color="#52C9A8"/>:<I.Down size={16} color="#52C9A8"/>}
                    </div>
                  </button>
                  {exp&&(
                    <div style={{padding:'0 18px 18px',borderTop:'1px solid #D4F2EB'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',paddingTop:12,marginBottom:14}}>
                        <span style={{color:'#5A9A8E',fontSize:12}}>{inq.date} ¬∑ {inq.clientName}</span>
                        {mode==='coach'&&(
                          <div style={{display:'flex',gap:8}}>
                            <button onClick={()=>toggleResolved(inq.id)} style={{fontSize:12,padding:'4px 12px',background:inq.resolved?'#E8F8F4':'#D4F2EB',color:inq.resolved?'#5A9A8E':'#2D9078',borderRadius:10,fontWeight:600,border:'none',cursor:'pointer'}}>{inq.resolved?'Unresolve':'‚úì Resolved'}</button>
                            <button onClick={()=>deleteInquiry(inq.id)} style={{color:'#52C9A8',background:'none',border:'none',cursor:'pointer'}}><I.X size={16}/></button>
                          </div>
                        )}
                      </div>
                      <div style={{background:'#E8F8F4',borderRadius:12,padding:'12px 14px',marginBottom:12}}>
                        <p style={{fontSize:11,fontWeight:700,color:'#5A9A8E',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.05em'}}>Question</p>
                        <p style={{color:'#2D7060',lineHeight:1.6,fontSize:14}}>{inq.question}</p>
                      </div>
                      {inq.answer ? (
                        <div className="answer-bubble">
                          <p style={{fontSize:11,fontWeight:700,color:'rgba(255,255,255,0.6)',marginBottom:4,textTransform:'uppercase',letterSpacing:'0.05em'}}>Coach Reply</p>
                          <p style={{fontSize:14,lineHeight:1.6}}>{inq.answer}</p>
                        </div>
                      ) : mode==='coach' ? (
                        answeringId==inq.id ? (
                          <div style={{display:'flex',flexDirection:'column',gap:8}}>
                            <textarea value={answerText} onChange={e=>setAnswerText(e.target.value)} placeholder="Write your reply..." className="input-field" rows={4} style={{resize:'none'}}/>
                            <div style={{display:'flex',gap:8}}>
                              <button onClick={()=>submitAnswer(inq.id)} className="btn-primary" style={{flex:1,padding:'12px'}} disabled={saving}>Submit Reply</button>
                              <button onClick={()=>{setAnsweringId(null);setAnswerText('');}} style={{padding:'12px 14px',background:'#E8F8F4',border:'none',borderRadius:12,cursor:'pointer'}}><I.X size={16} color="#5A9A8E"/></button>
                            </div>
                          </div>
                        ) : <button onClick={()=>setAnsweringId(inq.id)} className="btn-primary" style={{width:'100%',padding:'12px'}}>Reply</button>
                      ) : (
                        <div style={{background:'#E8F8F4',borderRadius:12,padding:'14px',textAlign:'center'}}><p style={{color:'#5A9A8E',fontSize:14}}>Your coach will reply soon üåø</p></div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* POSTS */}
        {activeTab==='posts' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
              <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>{mode==='client'?'Notice':'Posts'}</h2>
              {mode==='coach'&&<button onClick={()=>setShowPostForm(true)} className="btn-primary" style={{padding:'10px 18px',fontSize:14,display:'flex',alignItems:'center',gap:6}}><I.Plus size={16} color="#fff"/> New Post</button>}
            </div>
            {posts.length===0 ? (
              <div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üì¢</div><p style={{color:'#5A9A8E',fontWeight:600}}>No posts yet</p></div>
            ) : posts.map(post=>(
              <div key={post.id} className="card" style={{padding:22,marginBottom:12}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:12}}>
                  <div>
                    <h3 style={{fontFamily:'DM Serif Display,serif',fontSize:19,color:'#1A6B58',marginBottom:4}}>{post.title}</h3>
                    <p style={{color:'#5A9A8E',fontSize:12}}>{post.date}</p>
                  </div>
                  {mode==='coach'&&<button onClick={()=>deletePost(post.id)} style={{color:'#52C9A8',background:'none',border:'none',cursor:'pointer'}}><I.X size={18}/></button>}
                </div>
                <p style={{color:'#2D7060',lineHeight:1.7,fontSize:15,whiteSpace:'pre-line'}}>{post.content}</p>
                {post.imageUrl && <img src={post.imageUrl} alt="post" style={{width:'100%',borderRadius:12,marginTop:12,maxHeight:300,objectFit:'cover'}}/>}
              </div>
            ))}
          </div>
        )}

        {/* PAYMENT */}
        {activeTab==='payment' && <PaymentTab clientName={clientName} mode={mode}/>}

        {/* MEETINGS */}
        {activeTab==='meetings' && (
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}>
              <h2 style={{fontFamily:'DM Serif Display,serif',fontSize:24,color:'#1A6B58'}}>Meetings</h2>
              {mode==='coach'&&<button onClick={()=>setShowMtgForm(true)} className="btn-primary" style={{padding:'10px 18px',fontSize:14,display:'flex',alignItems:'center',gap:6}}><I.Plus size={16} color="#fff"/> Schedule</button>}
            </div>
            {upcomingMeetings.length>0&&(
              <div style={{marginBottom:24}}>
                <p style={{fontSize:12,fontWeight:700,color:'#5A9A8E',textTransform:'uppercase',letterSpacing:'0.08em',marginBottom:12}}>Upcoming</p>
                {upcomingMeetings.map(m=>(
                  <div key={m.id} className="upcoming-meeting" style={{marginBottom:10}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                      <div>
                        <p style={{fontFamily:'DM Serif Display,serif',fontSize:20,marginBottom:6}}>{m.title}</p>
                        <p style={{opacity:0.75,fontSize:13}}>{m.date} ¬∑ {m.time}</p>
                        {mode==='coach'&&<p style={{opacity:0.9,fontSize:14,marginTop:4,fontWeight:600}}>{m.clientName}</p>}
                      </div>
                      {mode==='coach'&&<button onClick={()=>deleteMeeting(m.id)} style={{color:'rgba(255,255,255,0.5)',background:'none',border:'none',cursor:'pointer'}}><I.X size={18}/></button>}
                    </div>
                    {m.notes&&<p style={{opacity:0.8,fontSize:14,marginTop:10,lineHeight:1.5}}>{m.notes}</p>}
                  </div>
                ))}
              </div>
            )}
            {pastMeetings.length>0&&(
              <div>
                <p style={{fontSize:12,fontWeight:700,color:'#5A9A8E',textTransform:'uppercase',letterSpacing:'0.08em',marginBottom:12}}>Past</p>
                {mode==='client'&&<div className="stat-card" style={{marginBottom:14,display:'flex',alignItems:'center',gap:14}}><p style={{fontSize:36,fontWeight:700,color:'#1A6B58',fontFamily:'DM Serif Display,serif'}}>{pastMeetings.length}</p><p style={{color:'#5A9A8E',fontSize:14,fontWeight:600}}>Sessions completed</p></div>}
                {pastMeetings.map(m=>(
                  <div key={m.id} className="card-warm" style={{padding:18,marginBottom:10,opacity:0.75}}>
                    <div style={{display:'flex',justifyContent:'space-between'}}>
                      <div>
                        <p style={{fontWeight:600,color:'#2D9078',fontSize:15,marginBottom:4}}>{m.title}</p>
                        <p style={{color:'#5A9A8E',fontSize:13}}>{m.date} ¬∑ {m.time}</p>
                        {mode==='coach'&&<p style={{color:'#3BAA8C',fontSize:13,marginTop:4}}>{m.clientName}</p>}
                      </div>
                      {mode==='coach'&&<button onClick={()=>deleteMeeting(m.id)} style={{color:'#52C9A8',background:'none',border:'none',cursor:'pointer'}}><I.X size={16}/></button>}
                    </div>
                  </div>
                ))}
              </div>
            )}
            {filteredMeetings.length===0&&<div className="card" style={{padding:40,textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>üìÖ</div><p style={{color:'#5A9A8E',fontWeight:600}}>No meetings yet</p></div>}
          </div>
        )}
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
